<!DOCTYPE html><html lang="pt-BR"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>FABRECK DO BRASIL - App de Garantia (Nuvem com Login)</title><script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script><script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"><!-- Firebase SDKs (Versões atualizadas para maior segurança e performance) --><script type="module">import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getFirestore,collection,onSnapshot,addDoc,doc,deleteDoc,updateDoc,writeBatch,getDocs,query,where,setDoc,getDoc}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import{getAuth,signInAnonymously,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";window.firebase={initializeApp,getFirestore,collection,onSnapshot,addDoc,doc,deleteDoc,updateDoc,writeBatch,getDocs,query,where,setDoc,getDoc,getAuth,signInAnonymously,onAuthStateChanged};</script><style>:root{--fabreck-red:#D22630;--fabreck-blue:#0047AB;--fabreck-white:#FFFFFF;--fabreck-light:#F5F7FA;--fabreck-dark:#1A2A3A;--fabreck-gray:#7F8C8D;--fabreck-success:#2ECC71;--fabreck-warning:#F39C12;--fabreck-danger:#E74C3C;--dark-bg:#121212;--dark-card-bg:#1E1E1E;--dark-text:#FFFFFF;--dark-light-text:#BDBDBD;--dark-border:#333333;--dark-header-bg-start:#002244;--dark-header-bg-end:#000000;--dark-blue-light:#64B5F6}*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;-webkit-tap-highlight-color:transparent}html{scroll-behavior:smooth}html,body{height:100%;overflow:hidden}body.loaded{}.jenilton-only{display:none}#loadingOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,var(--fabreck-dark),#000);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .5s ease-out;overflow:hidden}.loading-text{color:var(--fabreck-white);text-align:center;z-index:10;animation:pulse-logo 2.5s infinite ease-in-out}@keyframes pulse-logo{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}.loading-text p{font-size:16px;opacity:.8;letter-spacing:1px;margin-top:15px}.loading-text .logo-main{font-size:8vw;max-font-size:96px;-webkit-text-stroke:3px var(--fabreck-white);color:var(--fabreck-red)}.loading-text .logo-sub{font-size:3vw;max-font-size:32px;margin-top:-15px;color:var(--fabreck-white)}#lightning-container{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}.lightning{position:absolute;width:100px;height:150px;fill:rgba(0,100,224,.6);opacity:0;animation:flash 3.5s infinite ease-in-out;transform-origin:center}.bolt1{top:10%;left:15%;transform:rotate(-20deg);animation-delay:0s}.bolt2{top:20%;right:10%;transform:rotate(30deg) scale(.8);animation-delay:.7s}.bolt3{bottom:15%;left:25%;transform:rotate(-10deg) scale(1.2);animation-delay:1.5s}.bolt4{bottom:5%;right:20%;transform:rotate(15deg) scale(1.1);animation-delay:2.2s}.bolt5{top:50%;left:5%;transform:rotate(-30deg) scale(.7);animation-delay:2.8s}@keyframes flash{0%,100%{opacity:0;transform:scale(.8)}2%{opacity:.7;transform:scale(1.1)}4%{opacity:0}6%{opacity:.5;transform:scale(1)}8%,95%{opacity:0}}.login-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,var(--fabreck-blue),var(--fabreck-dark));display:flex;align-items:center;justify-content:center;z-index:3000;transition:opacity .3s ease}.login-overlay.hidden{opacity:0;pointer-events:none}.login-card{background:var(--fabreck-white);padding:30px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.2);width:90%;max-width:400px;text-align:center;transition:opacity .5s ease}#screensaverOverlay{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.9);opacity:0;pointer-events:none;transition:opacity .5s ease;z-index:3001;cursor:pointer}#screensaverOverlay .loading-text p{animation:pulse-text 2s infinite ease-in-out}@keyframes pulse-text{0%,100%{opacity:.6}50%{opacity:1}}body.dark-mode .login-card{background:var(--dark-card-bg)}.login-card .logo-img{width:180px;margin-bottom:20px}.login-card h2{color:var(--fabreck-blue);margin-bottom:20px}body.dark-mode .login-card h2{color:var(--dark-blue-light)}.login-card .form-group{text-align:left}.login-card .logo-main{color:var(--fabreck-red);-webkit-text-stroke-color:var(--fabreck-blue)}.login-card .logo-sub{color:var(--fabreck-blue)}#layoutContainer{display:flex;width:100%;visibility:hidden}#sidebar{width:260px;background:var(--fabreck-dark);color:var(--fabreck-white);display:none;flex-direction:column;padding:20px;box-shadow:5px 0 15px rgba(0,0,0,.1);transition:background .3s ease;position:sticky;top:0;height:100vh}#mainContentWrapper{flex:1;position:relative;padding:10px;height:100vh;overflow-y:auto}.container{max-width:100%;margin:0 auto}.footer{position:fixed;bottom:0;left:0;right:0;background:var(--fabreck-white);display:flex;justify-content:space-around;padding:10px 5px;border-top:1px solid rgba(0,0,0,.08);z-index:100;box-shadow:0 -4px 12px rgba(0,0,0,.05);transition:background .3s ease,border-top .3s ease}.page{display:none;animation:fadeIn .3s ease-in-out}.page.active{display:block}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}@media (min-width:992px){#sidebar{display:flex}.footer{display:none}#mainContentWrapper{padding:20px}.container{width:100%;max-width:none;margin:0}}@media (max-width:991px){#mainContentWrapper{padding-bottom:90px}}body.dark-mode #sidebar{background:var(--dark-card-bg);border-right:1px solid var(--dark-border)}.sidebar-header{text-align:center;margin-bottom:30px}.sidebar-header .logo-img{width:150px;margin-bottom:10px}.sidebar-header h3{font-size:16px;opacity:.8}.sidebar-nav{flex-grow:1}.sidebar-btn{display:flex;align-items:center;padding:15px;color:var(--fabreck-white);opacity:.7;text-decoration:none;border-radius:12px;margin-bottom:8px;font-weight:500;transition:all .3s ease}body.dark-mode .sidebar-btn{color:var(--dark-text)}.sidebar-btn i{font-size:20px;width:30px;margin-right:15px}.sidebar-btn:hover{opacity:1;background:rgba(255,255,255,.1)}.sidebar-btn.active{opacity:1;background:var(--fabreck-blue);color:var(--fabreck-white);font-weight:600}body.dark-mode .sidebar-btn.active{background:var(--dark-blue-light)}.sidebar-footer{font-size:12px;text-align:center;opacity:.5;padding-top:20px;border-top:1px solid rgba(255,255,255,.1)}body.dark-mode .sidebar-footer{border-top-color:var(--dark-border)}body.dark-mode{background:var(--dark-bg);color:var(--dark-text)}body.dark-mode .status-badge{color:#FFF}body.dark-mode .status-warranty,body.dark-mode .action-approved{background:#27ae60;border:none}body.dark-mode .status-expired,body.dark-mode .action-rejected{background:#c0392b;border:none}body.dark-mode .status-factory,body.dark-mode .status-awaiting-receipt{background:#2980b9;border:none}body.dark-mode .status-in-analysis,body.dark-mode .action-courtesy{background:#f39c12;border:none}body.dark-mode .status-finalized,body.dark-mode .action-scrapped{background:#8e44ad;border:none}body.dark-mode .footer{background:var(--dark-card-bg);border-top:1px solid var(--dark-border);box-shadow:0 -4px 12px rgba(0,0,0,.3)}body.dark-mode .nav-btn{color:var(--dark-light-text)}body.dark-mode .nav-btn.active{color:var(--dark-blue-light);background:rgba(0,71,171,.2)}body.dark-mode .rules-modal .rules-content,body.dark-mode .edit-modal .edit-content,body.dark-mode #receiptConfirmModal .modal-content, body.dark-mode #batchEditFinalizadoModal .modal-content{background:var(--dark-card-bg);border:2px solid var(--dark-blue-light)}body.dark-mode .rules-title,body.dark-mode .edit-title,body.dark-mode #receiptConfirmModal .modal-title, body.dark-mode #batchEditFinalizadoModal .modal-title{color:var(--dark-blue-light)}body.dark-mode .rules-list li,body.dark-mode .edit-modal label,body.dark-mode #receiptConfirmModal label, body.dark-mode #batchEditFinalizadoModal label{color:var(--dark-light-text)}body.dark-mode .rules-highlight{background:rgba(0,71,171,.2);color:var(--dark-blue-light);border:1px solid rgba(0,71,171,.3)}body.dark-mode .warranty-option{background:rgba(0,71,171,.1);border:1px solid rgba(0,71,171,.2);color:var(--dark-light-text)}body.dark-mode .warranty-option.selected{background:var(--dark-blue-light);color:var(--fabreck-white);border-color:var(--dark-blue-light)}body.dark-mode .persisted-field::after{color:var(--fabreck-success);background:rgba(46,204,113,.1)}
/* Início da adição do CSS para o novo bloco de credenciais */
body.dark-mode #testCredentialsInfo {
    background: var(--dark-card-bg); /* Use dark card background for better contrast */
    border-color: var(--dark-border);
}
body.dark-mode #testCredentialsInfo p {
    color: var(--dark-text) !important;
}
body.dark-mode #testCredentialsInfo p strong {
    color: var(--dark-blue-light);
}
/* Fim da adição do CSS para o novo bloco de credenciais */
header{background:linear-gradient(135deg,var(--fabreck-blue),var(--fabreck-dark));padding:15px;border-radius:16px;margin-bottom:15px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,.15);border:1px solid rgba(255,255,255,.1);position:sticky;top:0;z-index:101;transition:padding .3s ease, transform .3s ease}.logo-text-container{padding:5px 0;line-height:1;margin-bottom:10px}.logo-main{font-family:Impact,Haettenschweiler,'Arial Narrow Bold',sans-serif;font-weight:900;font-size:58px;color:var(--fabreck-red);-webkit-text-stroke:3px var(--fabreck-white);paint-order:stroke fill;text-shadow:0 2px 4px rgba(0,0,0,.3);letter-spacing:1px}.logo-sub{font-family:Arial,sans-serif;font-weight:700;font-size:20px;color:var(--fabreck-white);letter-spacing:2px;margin-top:-5px;text-shadow:0 1px 2px rgba(0,0,0,.3)}.sidebar-header .logo-main{font-size:44px}.sidebar-header .logo-sub{font-size:16px}.system-title{font-size:16px;opacity:.9;color:rgba(255,255,255,.85);margin-top:5px;font-weight:500;position:relative;z-index:1}.company-info{margin-top:10px;padding:10px;background:rgba(0,0,0,.2);border-radius:10px;border:1px solid rgba(255,255,255,.15);font-size:13px;backdrop-filter:blur(5px);position:relative;z-index:1}.company-info p{margin:3px 0;color:var(--fabreck-white)}.active-data-container{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;}.active-data{font-weight:700;color:var(--fabreck-white);font-size:13px;padding:4px 8px;border-radius:8px;display:inline-block;margin-top:5px;}.active-salesman-label{background:var(--fabreck-red);}.active-client-label{background:var(--fabreck-blue);}.card{background:var(--fabreck-white);border-radius:16px;box-shadow:0 5px 20px rgba(0,0,0,.05);padding:20px;border:1px solid rgba(0,0,0,.05);transition:transform .3s ease,box-shadow .3s ease,background .3s ease,color .3s ease;margin-bottom:15px}.card:hover{transform:translateY(-5px);box-shadow:0 8px 25px rgba(0,0,0,.1)}.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:12px;border-bottom:2px solid rgba(0,71,171,.1)}.card-title{font-size:18px;color:var(--fabreck-blue);font-weight:700;letter-spacing:.3px}.card-icon{font-size:24px;color:var(--fabreck-white);background:var(--fabreck-red);width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;box-shadow:0 3px 8px rgba(210,38,48,.3)}.form-group{margin-bottom:15px;position:relative}.form-group label{display:block;margin-bottom:5px;font-weight:600;color:var(--fabreck-blue);font-size:14px;transition:color .3s ease}.form-control{width:100%;padding:14px 16px;border:1px solid rgba(0,0,0,.1);border-radius:12px;font-size:16px;background:var(--fabreck-white);color:var(--fabreck-dark);box-shadow:inset 0 1px 3px rgba(0,0,0,.05);transition:border .3s,box-shadow .3s,background .3s ease,color .3s ease}#clientName,#salesmanName,#editClientName,#editSalesmanName,#usernameInput,#receiptOperationCode{text-transform:uppercase}.form-control:focus{border-color:var(--fabreck-blue);outline:none;box-shadow:0 0 0 3px rgba(0,71,171,.2)}.form-row{display:grid;grid-template-columns:1fr;gap:10px}.btn{padding:12px;border:none;border-radius:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-top:10px;width:100%;font-size:15px;box-shadow:0 4px 8px rgba(0,0,0,.1);transition:all .2s}.btn:disabled{background-color:var(--fabreck-gray);cursor:not-allowed;opacity:.7}.btn:active{transform:translateY(2px);box-shadow:0 2px 4px rgba(0,0,0,.1)}.btn-primary{background:var(--fabreck-blue);color:var(--fabreck-white)}.btn-success{background:var(--fabreck-success);color:var(--fabreck-white)}.btn-warning{background:var(--fabreck-warning);color:var(--fabreck-white)}.btn-danger{background:var(--fabreck-danger);color:var(--fabreck-white)}.btn-info{background:#3498DB;color:var(--fabreck-white)}.table-container{overflow-x:auto;margin-top:15px;border:1px solid rgba(0,0,0,.1);border-radius:12px;padding:3px}table{width:100%;border-collapse:collapse;font-size:14px}th,td{padding:12px 15px;text-align:left;border-bottom:1px solid rgba(0,0,0,.08);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}th:first-child,td:first-child{width:40px;text-align:center}th{background:rgba(0,71,171,.1);color:var(--fabreck-blue);font-weight:700;position:sticky;top:0;z-index:1;font-size:13px}tr:nth-child(even){background:rgba(0,71,171,.03)}.status-badge{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:700;display:inline-block;text-align:center}.status-warranty{background:rgba(46,204,113,.15);color:var(--fabreck-success);border:1px solid rgba(46,204,113,.3)}.status-expired{background:rgba(231,76,60,.15);color:var(--fabreck-danger);border:1px solid rgba(231,76,60,.3)}.status-factory,.status-awaiting-receipt{background:rgba(52,152,219,.15);color:#3498DB;border:1px solid rgba(52,152,219,.3)}.status-in-analysis{background:rgba(243,156,18,.15);color:var(--fabreck-warning);border:1px solid rgba(243,156,18,.3)}.status-finalized{background:rgba(142,68,173,.15);color:#8E44AD;border:1px solid rgba(142,68,173,.3)}.action-approved{background:rgba(46,204,113,.2);color:var(--fabreck-success);border:1px solid rgba(46,204,113,.4)}.action-rejected{background:rgba(231,76,60,.2);color:var(--fabreck-danger);border:1px solid rgba(231,76,60,.4)}.action-courtesy{background:rgba(243,156,18,.2);color:var(--fabreck-warning);border:1px solid rgba(243,156,18,.4)}.action-scrapped{background:rgba(127,140,141,.2);color:var(--fabreck-gray);border:1px solid rgba(127,140,141,.4)}.stat-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:15px}.stat-card{background:var(--fabreck-white);padding:15px;border-radius:12px;text-align:center;border:1px solid rgba(0,0,0,.05);box-shadow:0 3px 10px rgba(0,0,0,.03);transition:transform .3s ease,box-shadow .3s ease,background .3s ease,color .3s ease}.stat-title{font-size:12px;color:var(--fabreck-blue);margin-bottom:5px;font-weight:600}.stat-value{font-size:24px;font-weight:800;margin:5px 0;color:var(--fabreck-blue)}.nav-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px;color:var(--fabreck-gray);font-size:11px;text-align:center;border-radius:12px;transition:all .3s;flex-basis:0;flex-grow:1}.nav-btn.active{color:var(--fabreck-blue);background:rgba(0,71,171,.1);transform:translateY(-5px)}.nav-btn i{font-size:20px;margin-bottom:3px}.notification{position:fixed;top:20px;left:50%;transform:translateX(-50%);width:auto;min-width:300px;max-width:90%;padding:15px 20px;border-radius:12px;color:var(--fabreck-white);font-weight:600;box-shadow:0 5px 20px rgba(0,0,0,.15);z-index:2100;transform:translate(-50%,-120px);transition:transform .4s ease}.notification.show{transform:translate(-50%,0)}.notification.success{background:var(--fabreck-success);border-left:5px solid rgba(0,0,0,.1)}.notification.error{background:var(--fabreck-danger);border-left:5px solid rgba(0,0,0,.1)}.notification.info{background:var(--fabreck-blue);border-left:5px solid rgba(0,0,0,.1)}.info-section{background:rgba(0,71,171,.05);padding:15px;border-radius:12px;margin-top:15px;border:1px solid rgba(0,71,171,.1);font-size:14px;transition:background .3s ease,border .3s ease,color .3s ease}.report-filters{background:rgba(0,71,171,.05);padding:15px;border-radius:12px;margin-bottom:15px;border:1px solid rgba(0,71,171,.1);transition:background .3s ease,border .3s ease}.filter-row{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:10px}.filter-group{margin-bottom:8px}.filter-buttons{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}.hidden{display:none!important}.status-tabs{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}.status-tab{flex:1;padding:10px;border:1px solid var(--fabreck-blue);background:transparent;color:var(--fabreck-blue);border-radius:8px;cursor:pointer;font-weight:600;transition:all .2s;min-width:100px}.status-tab.active{background:var(--fabreck-blue);color:var(--fabreck-white)}body.dark-mode .status-tab{border-color:var(--dark-blue-light);color:var(--dark-blue-light)}body.dark-mode .status-tab.active{background:var(--dark-blue-light);color:var(--dark-card-bg)}.code-preview{font-size:20px;text-align:center;font-weight:700;margin-top:10px;letter-spacing:2px;color:var(--fabreck-blue);font-family:monospace;transition:color .3s ease}.help-icon{position:absolute;right:10px;top:35px;color:var(--fabreck-blue);cursor:pointer;background:rgba(0,71,171,.1);width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center}.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:2000;opacity:0;pointer-events:none;transition:opacity .3s}.modal.active{opacity:1;pointer-events:all}.modal-content{background:var(--fabreck-white);border-radius:16px;padding:25px;width:90%;max-width:500px;border:2px solid var(--fabreck-blue);position:relative;box-shadow:0 15px 30px rgba(0,0,0,.2);transition:background .3s ease,border .3s ease}.modal-close{position:absolute;top:15px;right:15px;color:var(--fabreck-red);font-size:24px;cursor:pointer;transition:transform .2s}.modal-close:hover{transform:scale(1.1)}.modal-title{color:var(--fabreck-blue);margin-bottom:15px;text-align:center;font-size:20px;font-weight:700}.rules-list{padding-left:20px;margin-bottom:20px}.rules-list li{margin-bottom:12px;line-height:1.5}.rules-highlight{background:rgba(0,71,171,.1);padding:2px 8px;border-radius:4px;font-weight:700;color:var(--fabreck-blue);border:1px solid rgba(0,71,171,.2);transition:background .3s ease,border .3s ease,color .3s ease}.warranty-type{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:15px}.warranty-option{display:flex;align-items:center;background:rgba(0,71,171,.05);padding:12px 15px;border-radius:12px;border:1px solid rgba(0,71,171,.1);cursor:pointer;transition:all .2s}.warranty-option.selected{background:var(--fabreck-blue);color:var(--fabreck-white);border-color:var(--fabreck-blue)}.warranty-option input{margin-right:10px}.persisted-field{position:relative}.persisted-field::after{content:'Salvo';position:absolute;right:10px;top:40px;font-size:10px;color:var(--fabreck-success);background:rgba(46,204,113,.1);padding:2px 5px;border-radius:10px}.code-input-row{display:flex;gap:10px}.code-input-row .form-control{flex:1}.code-input-row .btn{width:auto;flex:0 0 auto;margin-top:0;padding:14px 20px}.activity-log{margin-top:15px;max-height:200px;overflow-y:auto;border:1px solid rgba(0,0,0,.05);border-radius:12px;padding:10px;background:var(--fabreck-white);transition:background .3s ease,border .3s ease}.activity-item{padding:12px;border-bottom:1px dashed rgba(0,0,0,.08);display:flex;gap:10px;align-items:center;border-radius:8px;transition:background .2s,border-bottom .3s ease}.activity-item:hover{background:rgba(0,71,171,.03)}.activity-icon{width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:rgba(0,71,171,.1);color:var(--fabreck-blue);flex-shrink:0}.activity-content{flex:1;font-size:14px}.activity-time{color:var(--fabreck-gray);font-size:12px;white-space:nowrap}.totals-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-top:20px;flex-wrap:wrap}.total-box{flex:1;min-width:150px;background:var(--fabreck-white);padding:15px;border-radius:12px;text-align:center;box-shadow:0 3px 10px rgba(0,0,0,.05);border:1px solid rgba(0,0,0,.08);transition:transform .3s ease,box-shadow .3s ease,background .3s ease,color .3s ease}.total-title{font-size:14px;font-weight:600;color:var(--fabreck-blue);margin-bottom:5px}.total-value{font-size:24px;font-weight:800}.total-warranty{color:var(--fabreck-success)}.total-expired{color:var(--fabreck-danger)}.total-all{color:var(--fabreck-blue)}.analysis-info{background:rgba(0,71,171,.05);padding:15px;border-radius:12px;margin-bottom:15px;border:1px solid rgba(0,71,171,.1);font-size:14px;display:grid;grid-template-columns:1fr 1fr;gap:10px}.analysis-info p{margin:0}.analysis-info p strong{color:var(--fabreck-blue);display:block;font-size:12px}.form-section{margin-bottom:20px;border-bottom:1px solid #eee;padding-bottom:15px}body.dark-mode .form-section{border-bottom-color:var(--dark-border)}.form-section h3{color:var(--fabreck-blue);margin-bottom:15px;font-size:16px}body.dark-mode .form-section h3{color:var(--dark-blue-light)}.batch-actions{display:flex;flex-direction:column;gap:10px;margin-top:15px}@media (min-width:600px){.batch-actions{flex-direction:row;align-items:center;justify-content:space-between}.batch-actions .form-group{flex-grow:1;margin-bottom:0}.batch-actions .btn{width:auto;margin-top:0}}.analysis-tabs{display:flex;border-bottom:2px solid rgba(0,71,171,.1);margin-bottom:20px}.analysis-tab{padding:12px 20px;cursor:pointer;font-weight:600;color:var(--fabreck-gray);border-bottom:3px solid transparent;transition:all .3s ease}.analysis-tab.active{color:var(--fabreck-blue);border-bottom-color:var(--fabreck-blue)}.analysis-tab-content{display:none}.analysis-tab-content.active{display:block}body.dark-mode .analysis-tabs{border-bottom-color:var(--dark-border)}body.dark-mode .analysis-tab.active{color:var(--dark-blue-light);border-bottom-color:var(--dark-card-bg)}@media (min-width:600px){.form-row{grid-template-columns:1fr 1fr}.filter-row{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}#finalizadoPage .stat-cards{grid-template-columns:repeat(4,1fr)}}@media (min-width:992px){.total-box{min-width:200px}}@media (min-width:1200px){#scanPage.active{display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start}#scanPage.active .card{margin-bottom:0}#analysisPage.active>.card{display:grid;grid-template-columns:300px 1fr;gap:20px;align-items:start}#analysisPage.active .card-header{grid-column:1/-1}#analysisPage.active .analysis-tabs{grid-column:1/-1}#analysisPage.active .stat-cards{grid-column:1/2}#analysisPage.active .analysis-tab-content{grid-column:2/3;grid-row:3}#analysisPage.active .table-container{margin-top:0;max-height:70vh}#analysisContent .batch-actions{grid-column:1/2;display:flex;flex-direction:column;gap:15px}#settingsPage.active{display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start}}body.dark-mode .card,body.dark-mode .stat-card,body.dark-mode .total-box,body.dark-mode .activity-log{background:var(--dark-card-bg);border-color:var(--dark-border)}body.dark-mode .card-title,body.dark-mode .form-group label,body.dark-mode .stat-title,body.dark-mode .stat-value,body.dark-mode .total-title,body.dark-mode .code-preview{color:var(--dark-blue-light)}body.dark-mode .form-control{background-color:#2a2a2a;color:var(--dark-text);border-color:var(--dark-border)}body.dark-mode .form-control::placeholder{color:var(--dark-light-text);opacity:.7}body.dark-mode .form-control:focus{border-color:var(--dark-blue-light);box-shadow:0 0 0 3px rgba(100,181,246,.3)}body.dark-mode th{background-color:rgba(100,181,246,.15);color:var(--dark-blue-light)}body.dark-mode tr:nth-child(even){background-color:rgba(100,181,246,.05)}.active-salesman .active-data{background:var(--fabreck-red);}.active-client .active-data{background:var(--fabreck-blue);}.active-salesman, .active-client {display: inline-flex; align-items: center; white-space: nowrap; margin-top: 5px; font-weight: 600;}.active-salesman{margin-right: 15px;}body.dark-mode .info-section,body.dark-mode .report-filters{background:rgba(0,71,171,.15);border-color:rgba(0,71,171,.25)}.logo-minimal-container{display:none}.logo-minimal-container .logo-main{font-size:28px;-webkit-text-stroke:1.5px var(--fabreck-white);text-shadow:none;line-height:1;margin:0}header.minimal{padding:8px 15px;flex-direction:row;display:flex;justify-content:space-between;align-items:center}header.minimal .header-main-content{display:none}header.minimal .header-controls{display:flex;width:100%;justify-content:space-between;align-items:center}header.minimal .logo-minimal-container{display:block}header.minimal .header-buttons{margin-top:0}#header-scroll-trigger{height:1px}</style></head><body><div id="loadingOverlay"><div id="lightning-container"><svg class="lightning bolt1" viewBox="0 0 50 120"><path d="M 50 0 L 20 60 L 45 60 L 15 120 L 50 70 L 25 70 L 50 0 Z"></path></svg><svg class="lightning bolt2" viewBox="0 0 50 120"><path d="M 50 0 L 20 60 L 45 60 L 15 120 L 50 70 L 25 70 L 50 0 Z"></path></svg><svg class="lightning bolt3" viewBox="0 0 50 120"><path d="M 50 0 L 20 60 L 45 60 L 15 120 L 50 70 L 25 70 L 50 0 Z"></path></svg><svg class="lightning bolt4" viewBox="0 0 50 120"><path d="M 50 0 L 20 60 L 45 60 L 15 120 L 50 70 L 25 70 L 50 0 Z"></path></svg><svg class="lightning bolt5" viewBox="0 0 50 120"><path d="M 50 0 L 20 60 L 45 60 L 15 120 L 50 70 L 25 70 L 50 0 Z"></path></svg></div><div class="loading-text"><h1 class="logo-main">FABRECK</h1><h2 class="logo-sub">DO BRASIL</h2><p>A carregar sistema...</p></div></div><div class="login-overlay hidden" id="loginOverlay"><div id="screensaverOverlay"><div id="lightning-container"><svg class="lightning bolt1" viewBox="0 0 50 120"><path d="M 50 0 L 20 60 L 45 60 L 15 120 L 50 70 L 25 70 L 50 0 Z"></path></svg><svg class="lightning bolt2" viewBox="0 0 50 120"><path d="M 50 0 L 20 60 L 45 60 L 15 120 L 50 70 L 25 70 L 50 0 Z"></path></svg><svg class="lightning bolt3" viewBox="0 0 50 120"><path d="M 50 0 L 20 60 L 45 60 L 15 120 L 50 70 L 25 70 L 50 0 Z"></path></svg><svg class="lightning bolt4" viewBox="0 0 50 120"><path d="M 50 0 L 20 60 L 45 60 L 15 120 L 50 70 L 25 70 L 50 0 Z"></path></svg><svg class="lightning bolt5" viewBox="0 0 50 120"><path d="M 50 0 L 20 60 L 45 60 L 15 120 L 50 70 L 25 70 L 50 0 Z"></path></svg></div><div class="loading-text"><h1 class="logo-main">FABRECK</h1><h2 class="logo-sub">DO BRASIL</h2><p>Toque para voltar</p></div></div><div class="login-card"><div class="logo-text-container"><h1 class="logo-main">FABRECK</h1><h2 class="logo-sub">BATERIAS</h2></div><h2>Acesso Restrito</h2><form id="loginForm"><div class="form-group"><label for="usernameInput">Utilizador</label><input type="text" id="usernameInput" class="form-control" required></div><div class="form-group"><label for="passwordInput">Palavra-passe</label><input type="password" id="passwordInput" class="form-control" required></div><button type="submit" class="btn btn-primary">Entrar</button></form><div style="margin-top: 15px; border-top: 1px solid #e0e0e0; padding-top: 15px;"><button id="viewerLoginBtn" class="btn btn-info" style="margin-top:0;">Acesso Rápido (Somente Consulta)</button></div>
<p id="appVersionLogin" style="font-size: 12px; color: var(--fabreck-gray); margin-top: 20px;"></p></div></div><div id="layoutContainer"><nav id="sidebar"><div class="sidebar-header"><div class="logo-text-container"><h1 class="logo-main">FABRECK</h1><h2 class="logo-sub">BATERIAS</h2></div><h3>Garantia</h3></div><div class="sidebar-nav"><a href="#" class="sidebar-btn active" data-page="scanPage"><i class="fas fa-bolt"></i><span>Registo</span></a><a href="#" class="sidebar-btn" data-page="analysisPage"><i class="fas fa-clipboard-check"></i><span>Análise</span></a><a href="#" class="sidebar-btn" data-page="finalizadoPage"><i class="fas fa-check-double"></i><span>Finalizadas</span></a><a href="#" class="sidebar-btn jenilton-only" data-page="dispatchPage"><i class="fas fa-truck"></i><span>Expedição</span></a><a href="#" class="sidebar-btn jenilton-only" data-page="settingsPage"><i class="fas fa-cog"></i><span>Ajustes</span></a></div><div class="sidebar-footer"><p>&copy; 2025 FABRECK DO BRASIL | PCP Jenilton Cruz<br>Versão <span id="appVersionSidebar"></span></p></div></nav><div id="mainContentWrapper"><div class="container"><header><div class="header-main-content"><div class="logo-text-container"><h1 class="logo-main">FABRECK</h1><h2 class="logo-sub">BATERIAS</h2></div><div class="system-title">Sistema de Controle de Garantia</div><div class="company-info"><div class="active-data-container">
    <span class="active-salesman">Vendedor Ativo: <span class="active-data active-salesman-label" id="currentSalesman">N/A</span></span>
    <span class="active-client">Cliente Ativo: <span class="active-data active-client-label" id="currentClient">N/A</span></span>
</div></div></div><div class="header-controls"><div class="logo-minimal-container"><h1 class="logo-main">FABRECK</h1></div><div id="connectionStatus" style="font-size: 12px; font-weight: 600; color: white; opacity: 0.8;">A Ligar...</div><div class="header-buttons" style="display: flex; gap: 10px; margin-left: auto;"><button id="toggleDarkModeBtn" class="btn btn-info" style="width: auto; margin-top:0;"><i class="fas fa-moon"></i> <span id="darkModeText">Modo Escuro</span></button><button id="logoutBtn" class="btn btn-danger" style="width: auto; margin-top:0;"><i class="fas fa-sign-out-alt"></i> Sair</button></div></div></header><div id="header-scroll-trigger"></div><div id="scanPage" class="page active"><div class="card"><div class="card-header"><h2 class="card-title">Registo de Garantia</h2><div class="card-icon"><i class="fas fa-bolt"></i></div></div><div class="form-row"><div class="form-group autocomplete-container"><label for="clientName">Nome do Cliente</label><input type="text" id="clientName" class="form-control" placeholder="Nome completo" autocomplete="off"></div><div class="form-group"><label for="clientPhone">Telefone (WhatsApp)</label><input type="tel" id="clientPhone" class="form-control" placeholder="Ex: 5511999998888"></div><div class="form-group autocomplete-container"><label for="salesmanName">Nome do Vendedor</label><input type="text" id="salesmanName" class="form-control" placeholder="Nome do vendedor" autocomplete="off"></div></div><div class="form-group"><label for="submissionDateInput">Data do Envio</label><input type="date" id="submissionDateInput" class="form-control"></div><div class="warranty-type"><div class="warranty-option" id="factoryOption"><input type="radio" id="factoryRadio" name="warrantyType" value="factory" style="display:none;"><label for="factoryRadio" style="width:100%; cursor:pointer;">Garantia p/ Fábrica</label></div><div class="warranty-option" id="analyzedOption"><input type="radio" id="analyzedRadio" name="warrantyType" value="analyzed" style="display:none;"><label for="analyzedRadio" style="width:100%; cursor:pointer;">Análise por Vídeo</label></div></div><div id="videoAnalysisOptions" class="hidden"><div class="form-group"><label>Parecer Rápido (Análise por Vídeo)</label><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"><button id="procedenteBtn" class="btn btn-success" style="margin-top:0;">Procedente</button><button id="descarregadaBtn" class="btn btn-warning" style="margin-top:0;">Descarregada</button></div></div><div class="form-group"><label for="recommendation">Parecer Técnico (Obrigatório)</label><textarea id="recommendation" class="form-control" placeholder="Clique em uma opção acima ou digite o parecer."></textarea></div><button id="addObservationBtn" class="btn btn-info" style="margin-top: -10px; margin-bottom: 10px;"><i class="fas fa-comment-alt"></i> Adicionar Observações</button></div><div class="form-group"><label for="serialCode">Código de Série<i class="fas fa-question-circle help-icon" id="helpBtn"></i></label><div class="code-input-row"><div style="position: relative; flex: 1;"><input type="text" id="serialCode" class="form-control" placeholder="Ex: 3524A2623" maxlength="9"></div><button id="addBtn" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Adicionar</button></div><div id="codePreview" class="code-preview"></div><div id="warrantyDebugInfo" class="info-section" style="margin-top: 10px; display: none;"><p><strong>Informações de Cálculo da Garantia:</strong></p><p>Fabricação: <span id="debugManufDate"></span></p><p>Fim da Garantia: <span id="debugWarrantyEndDate"></span></p><p>Status Calculado: <span id="debugCalculatedStatus"></span></p></div></div><div class="form-row" style="margin-top: 10px;"><button id="clearFormBtn" class="btn btn-danger"><i class="fas fa-eraser"></i> Limpar Formulário e Desbloquear</button><button id="showRequirementsBtn" class="btn btn-info"><i class="fas fa-info-circle"></i> Requisitos para Análise</button><button id="registerScrapBtn" class="btn btn-warning jenilton-only"><i class="fas fa-trash-alt"></i> Recebimento de Sucatas</button></div><div class="activity-log" id="activityLog"></div></div><div class="card"><div class="card-header"><h2 class="card-title">Últimos Registos</h2><div class="card-icon"><i class="fas fa-history"></i></div></div><div class="table-container" style="margin-top:0; max-height: 65vh;"><table id="recentRegistrationsTable"><thead><tr><th>Cód. Operação</th><th>Código Bateria</th><th>Cliente</th><th>Vendedor</th><th>Data</th></tr></thead><tbody id="recentRegistrationsBody"></tbody></table></div></div></div><div id="analysisPage" class="page"><div class="card"><div class="card-header"><h2 class="card-title">Processo de Análise</h2><div class="card-icon"><i class="fas fa-clipboard-check"></i></div></div><div class="analysis-tabs"><div class="analysis-tab active" data-tab="receipt">Para Receber (Aline)</div><div class="analysis-tab" data-tab="analysis">Para Analisar (Reginaldo)</div></div><div id="receiptContent" class="analysis-tab-content"><div class="info-section"><p><b>Função da Aline:</b> Esta é a sua área para confirmar o recebimento físico das baterias. Use a pesquisa e os filtros para encontrar um item e clique em "Receber" ou selecione vários e confirme em lote.</p><div id="receiptLockMessage" class="info-section" style="margin-top: 10px; background-color: var(--fabreck-danger); color: var(--fabreck-white); display: none;"><i class="fas fa-lock"></i> **ATENÇÃO!** Não pode receber baterias enquanto um registo estiver em curso (Cliente/Vendedor Ativo no Cabeçalho). Peça para o registo ser finalizado.</div></div><div class="report-filters" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end; margin-bottom: 10px; padding: 10px;"><div class="form-group" style="margin: 0; flex-grow: 1; min-width: 200px;"><label for="receiptSearchInput" style="margin-bottom: 2px;">Pesquisa Rápida:</label><input type="search" id="receiptSearchInput" class="form-control" placeholder="Pesquisar por cliente, vendedor, códigos..."></div><div class="form-group" style="margin: 0; flex-basis: 250px; flex-grow: 1;"><label for="receiptClientFilter" style="margin-bottom: 2px;">Filtrar por Cliente:</label><select id="receiptClientFilter" class="form-control"></select></div><div class="form-group" style="margin: 0; flex-basis: 250px; flex-grow: 1;"><label for="receiptSalesmanFilter" style="margin-bottom: 2px;">Filtrar por Vendedor:</label><select id="receiptSalesmanFilter" class="form-control"></select></div></div><div class="stat-cards"><div class="stat-card"><div class="stat-title">Aguardando Recebimento</div><div class="stat-value" id="awaitingReceiptCount">0</div></div></div><div class="batch-actions"><button id="batchReceiptBtn" class="btn btn-success" disabled><i class="fas fa-check-double"></i> Confirmar Recebidos</button></div><div class="table-container"><table id="receiptTable"><thead><tr><th><input type="checkbox" id="selectAllReceiptCheckbox"></th><th>Código Bateria</th><th>Modelo</th><th>Cliente</th><th>Vendedor</th><th>Data Envio</th><th>Status Prazo</th><th class="actions-cell">Ação</th></tr></thead><tbody id="receiptBody"></tbody></table></div></div><div id="analysisContent" class="analysis-tab-content"><div class="info-section"><p><b>Função do Reginaldo:</b> Esta lista contém apenas baterias que já foram recebidas pela Aline e estão prontas para o seu teste técnico.</p></div><div class="report-filters" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end; margin-bottom: 10px; padding: 10px;"><div class="form-group" style="margin: 0; flex-grow: 1; min-width: 200px;"><label for="analysisSearchInput" style="margin-bottom: 2px;">Pesquisa Rápida:</label><input type="search" id="analysisSearchInput" class="form-control" placeholder="Pesquisar por códigos, modelo..."></div><div class="form-group" style="margin: 0; flex-basis: 250px; flex-grow: 1;"><label for="analysisClientFilter">Filtrar por Cliente:</label><select id="analysisClientFilter" class="form-control"></select></div><div class="form-group" style="margin: 0; flex-basis: 250px; flex-grow: 1;"><label for="analysisSalesmanFilter">Filtrar por Vendedor:</label><select id="analysisSalesmanFilter" class="form-control"></select></div></div><div class="stat-cards"><div class="stat-card"><div class="stat-title">Prontas para Análise</div><div class="stat-value" id="inAnalysisCount">0</div></div></div><div class="batch-actions"><button id="batchAnalyzeBtn" class="btn btn-success" disabled><i class="fas fa-layer-group"></i> Analisar Selecionados</button></div><div class="table-container"><table id="analysisTable"><thead><tr><th><input type="checkbox" id="selectAllAnalysisCheckbox"></th><th>Cód. Operação</th><th>Código Bateria</th><th>Cliente</th><th>Modelo</th><th>Data Envio</th><th>Status Garantia</th><th class="actions-cell">Ação</th></tr></thead><tbody id="analysisBody"></tbody></table></div></div></div></div><div id="finalizadoPage" class="page"><div class="card"><div class="card-header"><h2 class="card-title">Garantias Finalizadas</h2><div class="card-icon"><i class="fas fa-check-double"></i></div></div><div class="info-section"><p><b>Função do Jenilton:</b> Use esta página para consultar garantias já finalizadas, gerar relatórios para os clientes e preparar os pedidos de envio.</p></div><div class="stat-cards"><div class="stat-card"><div class="stat-title">Total Finalizadas</div><div class="stat-value" id="finalizadoCount">0</div></div><div class="stat-card"><div class="stat-title">PROCEDENTE (ENVIAR NOVA)</div><div class="stat-value" id="finalizadoAprovadaFabricaCount">0</div></div><div class="stat-card"><div class="stat-title">Improcedentes (Cortesia)</div><div class="stat-value" id="finalizadoAprovadaCortesiaCount">0</div></div><div class="stat-card"><div class="stat-title">Improcedentes (Total)</div><div class="stat-value" id="finalizadoReprovadaCount">0</div></div></div><div class="report-filters"><div class="form-group" style="margin-bottom: 10px;"><label for="finalizadoSearchInput">Pesquisa Rápida</label><input type="search" id="finalizadoSearchInput" class="form-control" placeholder="Pesquisar por cliente, códigos, parecer..."></div><div class="filter-row" style="margin-top: 15px;"><div class="filter-group"><label for="finalizadoStartDate">Data Inicial da Análise:</label><input type="date" id="finalizadoStartDate" class="form-control"></div><div class="filter-group"><label for="finalizadoEndDate">Data Final da Análise:</label><input type="date" id="finalizadoEndDate" class="form-control"></div><div class="filter-group"><label for="finalizadoSalesmanFilter">Filtrar por Vendedor:</label><select id="finalizadoSalesmanFilter" class="form-control"></select></div><div class="filter-group"><label for="finalizadoActionFilter">Filtrar por Ação Final:</label><select id="finalizadoActionFilter" class="form-control"></select></div></div><div class="filter-buttons" style="grid-template-columns: 1fr; margin-top: 10px;"><button id="finalizadoClearFilterBtn" class="btn btn-danger">Limpar Filtros</button></div></div><div class="filter-buttons" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin-top: 15px; margin-bottom: 15px;"><button id="batchEditFinalizadoBtn" class="btn btn-warning jenilton-only" disabled><i class="fas fa-edit"></i> Alterar Selecionadas</button><button id="finalizadoPdfBtn" class="btn btn-primary"><i class="fas fa-file-pdf"></i> Gerar PDF</button><button id="finalizadoExcelBtn" class="btn btn-success"><i class="fas fa-file-excel"></i> Exportar Excel</button><button id="finalizadoWhatsappBtn" class="btn btn-info"><i class="fab fa-whatsapp"></i> Enviar Resumo</button></div><div class="table-container"><table id="finalizadoTable"><thead><tr><th class="jenilton-only"><input type="checkbox" id="selectAllFinalizadoCheckbox"></th><th>Cód. Operação</th><th>Código Bateria</th><th>Cliente</th><th>Data da Análise</th><th>Ação Final</th><th>Parecer</th><th class="actions-cell">Ação</th></tr></thead><tbody id="finalizadoBody"></tbody></table></div></div></div><div id="dispatchPage" class="page jenilton-only"><div class="card"><div class="card-header"><h2 class="card-title">Pedidos de Expedição Pendentes</h2><div class="card-icon"><i class="fas fa-truck-loading"></i></div></div><div class="info-section"><p>Esta é a sua área para gerar os pedidos de envio para as garantias aprovadas. As baterias são agrupadas por cliente. Ao gerar um pedido, elas saem desta lista para evitar duplicidade.</p></div><div class="report-filters"><div class="form-group" style="margin-bottom: 0;"><label for="dispatchSearchInput">Pesquisar Cliente ou Vendedor</label><input type="search" id="dispatchSearchInput" class="form-control" placeholder="Digite o nome do cliente ou vendedor..."></div></div><div id="dispatchClientList"></div></div></div><div id="settingsPage" class="page jenilton-only"><div class="card"><div class="card-header"><h2 class="card-title">Backup e Restauração (Nuvem)</h2><div class="card-icon"><i class="fas fa-cloud-upload-alt"></i></div></div><div class="info-section" style="margin-top:0;"><p>Use os botões abaixo para guardar uma cópia de segurança de todos os dados da nuvem para o seu computador, ou para restaurar os dados de um ficheiro de backup para a nuvem.</p></div><div class="form-row"><button id="backupBtn" class="btn btn-primary"><i class="fas fa-download"></i> Exportar Dados (Backup)</button><button id="restoreBtn" class="btn btn-primary"><i class="fas fa-upload"></i> Importar Dados (Restaurar)</button></div><input type="file" id="restoreFile" accept=".json" style="display: none;"><div class="info-section"><h3>Última Sincronização com a Nuvem</h3><p id="lastUpdate">A ligar...</p></div></div><div class="card"><div class="card-header"><h2 class="card-title">Instruções de Garantia</h2><div class="card-icon"><i class="fas fa-info-circle"></i></div></div><div id="warrantyInstructionsContainer" class="info-section" style="margin-top:0;"></div></div><div class="card"><div class="card-header"><h2 class="card-title">Segurança</h2><div class="card-icon"><i class="fas fa-shield-alt"></i></div></div><div class="info-section" style="margin-top:0;"><p>Altere a sua palavra-passe de administrador regularmente para manter a segurança da sua conta.</p></div><button id="changePasswordBtn" class="btn btn-warning" style="margin-top: 20px;"><i class="fas fa-key"></i> Alterar Palavra-passe</button></div><div class="card"><div class="card-header"><h2 class="card-title">Sobre a Aplicação</h2><div class="card-icon"><i class="fas fa-code-branch"></i></div></div><div class="info-section" style="margin-top:0;"><p><strong>Versão da Aplicação:</strong> <span id="appVersionSettings"></span></p></div></div></div></div><div class="footer"><div class="nav-btn active" data-page="scanPage"><div><i class="fas fa-bolt"></i></div><span>Registo</span></div><div class="nav-btn" data-page="analysisPage"><div><i class="fas fa-clipboard-check"></i></div><span>Análise</span></div><div class="nav-btn" data-page="finalizadoPage"><div><i class="fas fa-check-double"></i></div><span>Finalizadas</span></div><div class="nav-btn jenilton-only" data-page="dispatchPage"><div><i class="fas fa-truck"></i></div><span>Expedição</span></div><div class="nav-btn jenilton-only" data-page="settingsPage"><div><i class="fas fa-cog"></i></div><span>Ajustes</span></div></div></div><div id="notification" class="notification"></div><div class="modal" id="rulesModal"><div class="modal-content"><span class="modal-close" id="closeRulesModal">&times;</span><h3 class="modal-title">Formato do Código de Série</h3><ul class="rules-list"><li>O código deve ter exatamente <span class="rules-highlight">9 caracteres</span></li><li>Os primeiros 4 caracteres devem ser <span class="rules-highlight">números</span></li><li>O quinto caractere deve ser uma <span class="rules-highlight">letra</span></li><li>Os últimos 4 caracteres devem ser <span class="rules-highlight">números</span></li><li>Exemplo válido: <span class="rules-highlight">3524A2623</span></li></ul><button class="btn btn-primary" id="confirmRules" style="width: 100%;">Entendi</button></div></div><div class="modal" id="receiptConfirmModal"><div class="modal-content"><span class="modal-close" id="closeReceiptConfirmModal">&times;</span><h3 class="modal-title" id="receiptConfirmTitle">Confirmar Recebimento</h3><div id="receiptBatteryInfo" class="info-section" style="margin-top:0; margin-bottom: 15px; text-align: left; display: none;"></div><div class="form-group"><label for="receiptOperationCode">Código da Operação (Obrigatório)</label><input type="text" id="receiptOperationCode" class="form-control" placeholder="Insira o código da operação"></div><div style="display: flex; gap: 10px; margin-top: 20px;"><button type="button" id="cancelReceiptConfirmBtn" class="btn btn-info" style="margin-top:0;">Cancelar</button><button type="button" id="confirmReceiptBtn" class="btn btn-success" style="margin-top:0;">Confirmar Recebimento</button></div></div></div><div class="modal" id="analysisModal"><div class="modal-content"><span class="modal-close" id="closeAnalysisModal">&times;</span><h3 class="modal-title" id="analysisModalTitle">Analisar Bateria</h3><div id="analysisSingleInfo"><div class="analysis-info"><p><strong>Cliente:</strong> <span id="analysisClientName"></span></p><p><strong>Vendedor:</strong> <span id="analysisSalesmanName"></span></p><p><strong>Modelo:</strong> <span id="analysisBatteryModel"></span></p><p><strong>Status Garantia:</strong> <span id="analysisWarrantyStatus"></span></p></div></div><div class="form-group"><label>Diagnóstico Técnico</label><div class="warranty-type"><div class="warranty-option" id="analysisApprovedRadioContainer"><input type="radio" id="analysisApprovedRadio" name="analysisDiagnosis" value="approved" style="display:none;"><label for="analysisApprovedRadio" style="width:100%; cursor:pointer;">Procedente</label></div><div class="warranty-option" id="analysisRejectedRadioContainer"><input type="radio" id="analysisRejectedRadio" name="analysisDiagnosis" value="rejected" style="display:none;"><label for="analysisRejectedRadio" style="width:100%; cursor:pointer;">Improcedente</label></div></div></div><div class="form-group"><label for="analysisRecommendation">Parecer Técnico (Descrição)</label><textarea id="analysisRecommendation" class="form-control" placeholder="Descreva o defeito ou o motivo da reprovação..."></textarea></div><div class="form-group"><label for="analysisFinalAction">Ação Comercial Final</label><select id="analysisFinalAction" class="form-control" disabled><option value="">-- Selecione o diagnóstico primeiro --</option></select></div><button id="analysisAddObservationBtn" class="btn btn-info" style="margin-top: -10px; margin-bottom: 10px;"><i class="fas fa-comment-alt"></i> Adicionar Observações</button><button id="saveAnalysisBtn" class="btn btn-success"><i class="fas fa-save"></i> Salvar Análise e Finalizar</button></div></div><div class="modal" id="batchEditFinalizadoModal"><div class="modal-content"><span class="modal-close" id="closeBatchEditFinalizadoModal">&times;</span><h3 class="modal-title" id="batchEditFinalizadoModalTitle">Alterar Análises em Lote</h3><p style="text-align: center; font-size: 14px; margin-bottom: 15px;">A ação e parecer abaixo serão aplicados a todos os itens selecionados.</p><div class="form-group"><label>Novo Diagnóstico Técnico</label><div class="warranty-type"><div class="warranty-option" id="batchEditApprovedRadioContainer"><input type="radio" id="batchEditApprovedRadio" name="batchEditDiagnosis" value="approved" style="display:none;"><label for="batchEditApprovedRadio" style="width:100%; cursor:pointer;">Procedente</label></div><div class="warranty-option" id="batchEditRejectedRadioContainer"><input type="radio" id="batchEditRejectedRadio" name="batchEditDiagnosis" value="rejected" style="display:none;"><label for="batchEditRejectedRadio" style="width:100%; cursor:pointer;">Improcedente</label></div></div></div><div class="form-group"><label for="batchEditFinalAction">Nova Ação Comercial Final</label><select id="batchEditFinalAction" class="form-control" disabled><option value="">-- Selecione o diagnóstico primeiro --</option></select></div><div class="form-group"><label for="batchEditRecommendation">Novo Parecer Técnico (Descrição)</label><textarea id="batchEditRecommendation" class="form-control" placeholder="Selecione uma ação para preenchimento automático..."></textarea></div><button id="saveBatchEditBtn" class="btn btn-success"><i class="fas fa-save"></i> Salvar Alterações em Lote</button></div></div><div class="modal" id="clientEditModal"><div class="modal-content"><span class="modal-close" id="closeClientEditModal">&times;</span><h3 class="modal-title">Editar Dados do Cliente</h3><p style="text-align: center; font-size: 14px; margin-bottom: 15px;">A alteração será aplicada a todos os registos com este cliente.</p><div class="form-group"><label for="editClientName">Nome do Cliente</label><input type="text" id="editClientName" class="form-control"></div><div class="form-group"><label for="editClientPhone">Telefone (WhatsApp)</label><input type="tel" id="editClientPhone" class="form-control" placeholder="Ex: 5511999998888"></div><div class="form-group"><label for="editSalesmanName">Nome do Vendedor</label><input type="text" id="editSalesmanName" class="form-control"></div><button id="saveClientEditBtn" class="btn btn-success"><i class="fas fa-save"></i> Salvar Alterações</button></div></div><div class="modal" id="observationModal"><div class="modal-content"><span class="modal-close" id="closeObservationModal">&times;</span><h3 class="modal-title">Observações para o Cliente</h3><div class="form-group"><label for="observationText">Observação</label><textarea id="observationText" class="form-control" rows="4" placeholder="Digite aqui informações adicionais para o cliente..."></textarea></div><button id="saveObservationBtn" class="btn btn-primary"><i class="fas fa-check"></i> Confirmar</button></div></div><div class="modal" id="procedenteModal"><div class="modal-content"><span class="modal-close" id="closeProcedenteModal">&times;</span><h3 class="modal-title">Motivo - Procedente</h3><p style="text-align: center; font-size: 14px; margin-bottom: 15px;">Selecione o motivo pelo qual a garantia foi aprovada.</p><div style="display: grid; grid-template-columns: 1fr; gap: 10px;"><button id="capacidadeBaixaBtn" class="btn btn-success">Capacidade Baixa</button><button id="ccaBaixoBtn" class="btn btn-success">CCA Baixo</button></div></div></div><div class="modal" id="confirmModal"><div class="modal-content"><h3 class="modal-title" id="confirmTitle">Confirmar Ação</h3><p id="confirmMessage" style="text-align: center; font-size: 14px; margin-bottom: 20px;">Tem a certeza que deseja prosseguir?</p><div style="display: flex; gap: 10px;"><button id="cancelConfirmBtn" class="btn btn-info" style="margin-top:0;">Cancelar</button><button id="confirmActionBtn" class="btn btn-danger" style="margin-top:0;">Confirmar</button></div></div></div><div class="modal" id="passwordConfirmModal"><div class="modal-content"><span class="modal-close" id="closePasswordConfirmModal">&times;</span><h3 class="modal-title">Confirmação de Segurança</h3><p style="text-align: center; font-size: 14px; margin-bottom: 15px;">Para apagar todos os dados da nuvem, confirme a palavra-passe MASTER de administrador.</p><form id="passwordConfirmForm"><div class="form-group"><label for="adminPasswordConfirm">Palavra-passe MASTER</label><input type="password" id="adminPasswordConfirm" class="form-control" required></div><div style="display: flex; gap: 10px; margin-top: 20px;"><button id="cancelPasswordConfirmBtn" class="btn btn-info" style="margin-top:0;">Cancelar</button><button type="submit" id="confirmActionBtn" class="btn btn-danger" style="margin-top:0;">Confirmar e Apagar Tudo</button></div></form></div></div><div class="modal" id="whatsappPreviewModal"><div class="modal-content" style="max-width: 600px;"><span class="modal-close" id="closeWhatsappPreviewModal">&times;</span><h3 class="modal-title">Pré-visualização da Mensagem</h3><div class="info-section" style="margin-top: 0; margin-bottom: 20px; max-height: 40vh; overflow-y: auto;"><pre id="whatsappMessagePreview" style="white-space: pre-wrap; word-wrap: break-word; font-size: 14px;"></pre></div><div style="display: flex; gap: 10px;"><button id="cancelWhatsappBtn" class="btn btn-warning" style="margin-top:0;">Cancelar</button><button id="sendWhatsappBtn" class="btn btn-success" style="margin-top:0;"><i class="fab fa-whatsapp"></i> Enviar Agora</button></div></div></div><div class="modal" id="whatsappOptionsMenuModal"><div class="modal-content"><span class="modal-close" id="closeWhatsappOptionsMenuModal">&times;</span><h3 class="modal-title">Escolha o Relatório para Enviar</h3><div class="info-section" style="margin-top:0; margin-bottom: 20px;"><p>Selecione uma das opções abaixo para gerar e enviar um relatório via WhatsApp.</p></div><div style="display: grid; grid-template-columns: 1fr; gap: 10px;"><button id="sendFilteredReportBtn" class="btn btn-primary"><i class="fas fa-filter"></i> Resumo Detalhado do Filtro</button><button id="sendTodaySummaryBtn" class="btn btn-info"><i class="fas fa-calendar-day"></i> Resumo de Registos de Hoje</button><button id="sendPendingAnalysisBtn" class="btn btn-warning"><i class="fas fa-hourglass-half"></i> Notificar Pendentes de Análise</button><button id="sendGeneralSummaryBtn" class="btn btn-success"><i class="fas fa-globe-americas"></i> Resumo Geral de Finalizadas</button></div></div></div><div class="modal" id="finalizedNotificationModal"><div class="modal-content"><span class="modal-close" id="closeFinalizedNotificationModal">&times;</span><h3 class="modal-title"><i class="fas fa-bell" style="color: var(--fabreck-warning);"></i> Novas Baterias Finalizadas!</h3><div id="finalizedNotificationList" class="info-section" style="margin-top:0; text-align: left; max-height: 40vh; overflow-y: auto;"></div></div></div><div class="modal" id="receiptSummaryModal"><div class="modal-content"><span class="modal-close" id="closeReceiptSummaryModal">&times;</span><h3 class="modal-title" id="receiptSummaryTitle">Resumo de Baterias</h3><div id="receiptSummaryBody" class="info-section" style="margin-top:0; text-align: left;"></div><button id="printReceiptSummaryBtn" class="btn btn-primary" style="margin-top: 15px;"><i class="fas fa-print"></i> Visualizar para Impressão</button></div></div><div class="modal" id="dispatchConfirmModal"><div class="modal-content"><span class="modal-close" id="closeDispatchConfirmModal">&times;</span><h3 class="modal-title" id="dispatchConfirmTitle">Finalizar Expedição</h3><div id="dispatchInfo" class="info-section" style="margin-top:0; margin-bottom: 15px; text-align: center;"><p>A finalizar o pedido de expedição. Insira a Ordem de Serviço (O.S.) para confirmar o envio.</p></div><div class="form-group"><label for="dispatchOSCode">Ordem de Serviço (O.S.)</label><input type="text" id="dispatchOSCode" class="form-control" placeholder="Insira o código da O.S."></div><div style="display: flex; gap: 10px; margin-top: 20px;"><button type="button" id="cancelDispatchConfirmBtn" class="btn btn-info" style="margin-top:0;">Cancelar</button><button type="button" id="confirmDispatchBtn" class="btn btn-success" style="margin-top:0;">Confirmar Expedição</button></div></div></div><div class="modal" id="dispatchSummaryModal"><div class="modal-content"><span class="modal-close" id="closeDispatchSummaryModal">&times;</span><h3 class="modal-title" id="dispatchSummaryTitle">Resumo de Expedição</h3><div id="dispatchSummaryBody" class="info-section" style="margin-top:0; text-align: left;"></div><button id="printDispatchSummaryBtn" class="btn btn-primary" style="margin-top: 15px;"><i class="fas fa-print"></i> Visualizar para Impressão</button></div></div><div class="modal" id="passwordModal"><div class="modal-content"><span class="modal-close" id="closePasswordModal">&times;</span><h3 class="modal-title">Alterar Palavra-passe</h3><form id="passwordChangeForm"><div class="form-group"><label for="currentPassword">Palavra-passe Atual</label><input type="password" id="currentPassword" class="form-control" required></div><div class="form-group"><label for="newPassword">Nova Palavra-passe</label><input type="password" id="newPassword" class="form-control" required></div><div class="form-group"><label for="confirmNewPassword">Confirmar Nova Palavra-passe</label><input type="password" id="confirmNewPassword" class="form-control" required></div><button type="submit" id="savePasswordBtn" class="btn btn-success"><i class="fas fa-save"></i> Guardar Nova Palavra-passe</button></form></div></div><script>
    document.addEventListener('DOMContentLoaded', () => {
        const {initializeApp,getFirestore,collection,onSnapshot,addDoc,doc,deleteDoc,updateDoc,writeBatch,getDocs,query,where,setDoc,getDoc,getAuth,signInAnonymously,onAuthStateChanged}=window.firebase;
        const layoutContainer=document.getElementById('layoutContainer');
        const loginOverlay=document.getElementById('loginOverlay');
        const loginForm=document.getElementById('loginForm');
        const usernameInput=document.getElementById('usernameInput');
        const passwordInput=document.getElementById('passwordInput');
        const viewerLoginBtn=document.getElementById('viewerLoginBtn');
        const logoutBtn=document.getElementById('logoutBtn');
        const clientNameInput=document.getElementById('clientName');
        const salesmanNameInput=document.getElementById('salesmanName');
        const serialCodeInput=document.getElementById('serialCode');
        const addBtn=document.getElementById('addBtn');
        const clearFormBtn=document.getElementById('clearFormBtn');
        const backupBtn=document.getElementById('backupBtn');
        const restoreBtn=document.getElementById('restoreBtn');
        const restoreFileInput=document.getElementById('restoreFile');
        const totalCount=document.getElementById('totalCount');
        const lastUpdate=document.getElementById('lastUpdate');
        const navBtns=document.querySelectorAll('.nav-btn');
        const sidebarBtns=document.querySelectorAll('.sidebar-btn');
        const pages=document.querySelectorAll('.page');
        const codePreview=document.getElementById('codePreview');
        const activityLog=document.getElementById('activityLog');
        const currentUserDisplay=document.getElementById('currentUserDisplay');
        const helpBtn=document.getElementById('helpBtn');
        const rulesModal=document.getElementById('rulesModal');
        const closeRulesModal=document.getElementById('closeRulesModal');
        const confirmRules=document.getElementById('confirmRules');
        const factoryRadio=document.getElementById('factoryRadio');
        const analyzedRadio=document.getElementById('analyzedRadio');
        const factoryOption=document.getElementById('factoryOption');
        const analyzedOption=document.getElementById('analyzedOption');
        const recommendationInput=document.getElementById('recommendation');
        const warrantyDebugInfo=document.getElementById('warrantyDebugInfo');
        const debugManufDate=document.getElementById('debugManufDate');
        const debugWarrantyEndDate=document.getElementById('debugWarrantyEndDate');
        const debugCalculatedStatus=document.getElementById('debugCalculatedStatus');
        const submissionDateInput=document.getElementById('submissionDateInput');
        const toggleDarkModeBtn=document.getElementById('toggleDarkModeBtn');
        const darkModeText=document.getElementById('darkModeText');
        const warrantyInstructionsContainer=document.getElementById('warrantyInstructionsContainer');
        const analysisTabs=document.querySelectorAll('.analysis-tab');
        const analysisTabContents=document.querySelectorAll('.analysis-tab-content');
        const awaitingReceiptCount=document.getElementById('awaitingReceiptCount');
        const receiptBody=document.getElementById('receiptBody');
        const selectAllReceiptCheckbox=document.getElementById('selectAllReceiptCheckbox');
        const batchReceiptBtn=document.getElementById('batchReceiptBtn');
        const receiptSearchInput=document.getElementById('receiptSearchInput');
        const receiptClientFilter=document.getElementById('receiptClientFilter');
        const receiptSalesmanFilter=document.getElementById('receiptSalesmanFilter');
        const analysisBody=document.getElementById('analysisBody');
        const inAnalysisCount=document.getElementById('inAnalysisCount');
        const analysisClientFilter=document.getElementById('analysisClientFilter');
        const analysisSalesmanFilter=document.getElementById('analysisSalesmanFilter');
        const selectAllAnalysisCheckbox=document.getElementById('selectAllAnalysisCheckbox');
        const batchAnalyzeBtn=document.getElementById('batchAnalyzeBtn');
        const analysisSearchInput=document.getElementById('analysisSearchInput');
        const recentRegistrationsBody=document.getElementById('recentRegistrationsBody');
        const finalizadoBody=document.getElementById('finalizadoBody');
        const finalizadoCount=document.getElementById('finalizadoCount');
        const finalizadoSearchInput=document.getElementById('finalizadoSearchInput');
        const finalizadoStartDate=document.getElementById('finalizadoStartDate');
        const finalizadoEndDate=document.getElementById('finalizadoEndDate');
        const finalizadoSalesmanFilter = document.getElementById('finalizadoSalesmanFilter');
        const finalizadoActionFilter = document.getElementById('finalizadoActionFilter');
        const finalizadoClearFilterBtn=document.getElementById('finalizadoClearFilterBtn');
        const finalizadoPdfBtn=document.getElementById('finalizadoPdfBtn');
        const finalizadoExcelBtn=document.getElementById('finalizadoExcelBtn');
        const finalizadoWhatsappBtn=document.getElementById('finalizadoWhatsappBtn');
        const whatsappPreviewModal=document.getElementById('whatsappPreviewModal');
        const closeWhatsappPreviewModal=document.getElementById('closeWhatsappPreviewModal');
        const whatsappMessagePreview=document.getElementById('whatsappMessagePreview');
        const sendWhatsappBtn=document.getElementById('sendWhatsappBtn');
        const cancelWhatsappBtn=document.getElementById('cancelWhatsappBtn');
        const whatsappOptionsMenuModal=document.getElementById('whatsappOptionsMenuModal');
        const closeWhatsappOptionsMenuModal=document.getElementById('closeWhatsappOptionsMenuModal');
        const sendFilteredReportBtn=document.getElementById('sendFilteredReportBtn');
        const sendTodaySummaryBtn=document.getElementById('sendTodaySummaryBtn');
        const sendPendingAnalysisBtn=document.getElementById('sendPendingAnalysisBtn');
        const sendGeneralSummaryBtn=document.getElementById('sendGeneralSummaryBtn');
        const receiptConfirmModal=document.getElementById('receiptConfirmModal');
        const closeReceiptConfirmModal=document.getElementById('closeReceiptConfirmModal');
        const receiptConfirmTitle=document.getElementById('receiptConfirmTitle');
        const receiptBatteryInfo=document.getElementById('receiptBatteryInfo');
        const receiptOperationCode=document.getElementById('receiptOperationCode');
        const cancelReceiptConfirmBtn=document.getElementById('cancelReceiptConfirmBtn');
        const confirmReceiptBtn=document.getElementById('confirmReceiptBtn');
        const analysisModal=document.getElementById('analysisModal');
        const closeAnalysisModal=document.getElementById('closeAnalysisModal');
        const analysisModalTitle=document.getElementById('analysisModalTitle');
        const analysisSingleInfo=document.getElementById('analysisSingleInfo');
        const analysisClientName=document.getElementById('analysisClientName');
        const analysisSalesmanName=document.getElementById('analysisSalesmanName');
        const analysisBatteryModel=document.getElementById('analysisBatteryModel');
        const analysisWarrantyStatus=document.getElementById('analysisWarrantyStatus');
        const analysisRecommendation=document.getElementById('analysisRecommendation');
        const analysisFinalAction=document.getElementById('analysisFinalAction');
        const saveAnalysisBtn=document.getElementById('saveAnalysisBtn');
        const analysisAddObservationBtn=document.getElementById('analysisAddObservationBtn');
        const analysisApprovedRadio=document.getElementById('analysisApprovedRadio');
        const analysisRejectedRadio=document.getElementById('analysisRejectedRadio');
        const analysisApprovedRadioContainer=document.getElementById('analysisApprovedRadioContainer');
        const analysisRejectedRadioContainer=document.getElementById('analysisRejectedRadioContainer');
        const clientEditModal=document.getElementById('clientEditModal');
        const closeClientEditModal=document.getElementById('closeClientEditModal');
        const editClientNameInput=document.getElementById('editClientName');
        const editSalesmanNameInput=document.getElementById('editSalesmanName');
        const editClientPhoneInput=document.getElementById('editClientPhone');
        const saveClientEditBtn=document.getElementById('saveClientEditBtn');
        const observationModal=document.getElementById('observationModal');
        const closeObservationModal=document.getElementById('closeObservationModal');
        const observationText=document.getElementById('observationText');
        const saveObservationBtn=document.getElementById('saveObservationBtn');
        const videoAnalysisOptions=document.getElementById('videoAnalysisOptions');
        const procedenteBtn=document.getElementById('procedenteBtn');
        const descarregadaBtn=document.getElementById('descarregadaBtn');
        const addObservationBtn=document.getElementById('addObservationBtn');
        const clientPhoneInput=document.getElementById('clientPhone');
        const procedenteModal=document.getElementById('procedenteModal');
        const closeProcedenteModal=document.getElementById('closeProcedenteModal');
        const capacidadeBaixaBtn=document.getElementById('capacidadeBaixaBtn');
        const ccaBaixoBtn=document.getElementById('ccaBaixoBtn');
        const confirmModal=document.getElementById('confirmModal');
        const confirmTitle=document.getElementById('confirmTitle');
        const confirmMessage=document.getElementById('confirmMessage');
        const confirmActionBtn=document.getElementById('confirmActionBtn');
        const cancelConfirmBtn=document.getElementById('cancelConfirmBtn');
        const finalizedNotificationModal=document.getElementById('finalizedNotificationModal');
        const closeFinalizedNotificationModal=document.getElementById('closeFinalizedNotificationModal');
        const receiptSummaryModal=document.getElementById('receiptSummaryModal');
        const closeReceiptSummaryModal=document.getElementById('closeReceiptSummaryModal');
        const receiptSummaryTitle=document.getElementById('receiptSummaryTitle');
        const receiptSummaryBody=document.getElementById('receiptSummaryBody');
        const printReceiptSummaryBtn=document.getElementById('printReceiptSummaryBtn');
        const dispatchSummaryModal=document.getElementById('dispatchSummaryModal');
        const closeDispatchSummaryModal=document.getElementById('closeDispatchSummaryModal');
        const dispatchSummaryTitle=document.getElementById('dispatchSummaryTitle');
        const dispatchSummaryBody=document.getElementById('dispatchSummaryBody');
        const printDispatchSummaryBtn=document.getElementById('printDispatchSummaryBtn');
        const dispatchConfirmModal=document.getElementById('dispatchConfirmModal');
        const closeDispatchConfirmModal=document.getElementById('closeDispatchConfirmModal');
        const dispatchOSCode=document.getElementById('dispatchOSCode');
        const confirmDispatchBtn=document.getElementById('confirmDispatchBtn');
        const dispatchClientList=document.getElementById('dispatchClientList');
        const dispatchSearchInput=document.getElementById('dispatchSearchInput');
        const connectionStatus=document.getElementById('connectionStatus');
        const passwordConfirmModal=document.getElementById('passwordConfirmModal');
        const closePasswordConfirmModal=document.getElementById('closePasswordConfirmModal');
        const passwordConfirmForm=document.getElementById('passwordConfirmForm');
        const cancelPasswordConfirmBtn=document.getElementById('cancelPasswordConfirmBtn');
        const adminPasswordConfirmInput=document.getElementById('adminPasswordConfirm');
        const changePasswordBtn=document.getElementById('changePasswordBtn');
        const passwordModal=document.getElementById('passwordModal');
        const closePasswordModal=document.getElementById('closePasswordModal');
        const passwordChangeForm=document.getElementById('passwordChangeForm');
        const showRequirementsBtn = document.getElementById('showRequirementsBtn');
        const registerScrapBtn = document.getElementById('registerScrapBtn');
        const batchEditFinalizadoBtn = document.getElementById('batchEditFinalizadoBtn');
        const selectAllFinalizadoCheckbox = document.getElementById('selectAllFinalizadoCheckbox');
        const batchEditFinalizadoModal = document.getElementById('batchEditFinalizadoModal');
        const closeBatchEditFinalizadoModal = document.getElementById('closeBatchEditFinalizadoModal');
        const batchEditApprovedRadioContainer = document.getElementById('batchEditApprovedRadioContainer');
        const batchEditRejectedRadioContainer = document.getElementById('batchEditRejectedRadioContainer');
        const batchEditApprovedRadio = document.getElementById('batchEditApprovedRadio');
        const batchEditRejectedRadio = document.getElementById('batchEditRejectedRadio');
        const batchEditFinalAction = document.getElementById('batchEditFinalAction');
        const batchEditRecommendation = document.getElementById('batchEditRecommendation');
        const saveBatchEditBtn = document.getElementById('saveBatchEditBtn');

        const GLOBAL_ACTIVE_ID = "FABRECK_GLOBAL_ACTIVE_STATUS";
        const ACTIVITY_DATA_KEY='fabreck_activity_data_v2';
        const LAST_WARRANTY_TYPE_KEY='fabreck_last_warranty_type_v12';
        const DARK_MODE_KEY='fabreck_dark_mode';
        const ADMIN_USERS_KEY='fabreck_admin_users_local';
        let batteryData=[];
        let previousBatteryData=[];
        let activityData=[];
        let warrantyInstructions={};
        let rulesShown=localStorage.getItem('rulesShown')==='true';
        let analysisMode='single';
        let analyzingBatteryId=null;
        let batchAnalysisIds=[];
        let batchEditFinalizadoIds = [];
        let editingBatteryId=null;
        let observationCallback=null;
        let confirmCallback=null;
        let tempObservation='';
        let isDarkMode=localStorage.getItem(DARK_MODE_KEY)==='true';
        let filterDebounceTimer=null;
        let whatsappUrl='';
        let idleTimer=null;
        let receiptIdsToConfirm=[];
        let currentReceiptSummaryData=null;
        let dispatchBatteriesToConfirm=[];
        let currentDispatchSummaryData=null;
        let db;
        let auth;
        let batteriesCollection;
        let unsubscribeFromFirestore=null;
        let unsubscribeGlobalStatus = null;
        const batteryModelMap={'A':'FA6AD','B':'FA4D','C':'FA5AD','D':'FA5D','E':'FA5,5D','F':'FA6D','G':'FA7E','H':'FA8AE','I':'FA8E','J':'FA7AE','K':'FA7D'};
        const userFullNameMap={'JENILTON':'Jenilton Cruz','ALINE BURQUE':'Aline Burque','REGINALDO':'Reginaldo','VIEWER':'Visitante','VIDEO_ANALYSIS':'Análise por Vídeo'};
        const currentClientDisplay=document.getElementById('currentClient');
        const currentSalesmanDisplay=document.getElementById('currentSalesman');
        const receiptLockMessage=document.getElementById('receiptLockMessage');

        // --- FUNÇÕES AUXILIARES MOVIDAS PARA O TOPO DO ESCOPO ---
        function validateSerialCode(code){return/^\d{4}[A-Za-z]\d{4}$/.test(code)}
        function parseCode(code){return{week:parseInt(code.substring(0,2)),year:parseInt("20"+code.substring(2,4))}}
        function getBatteryModelFromCode(code){return code?.length>=5?(batteryModelMap[code[4].toUpperCase()]||'Desconhecido'):'N/A'}
        function getManufacturingDate(week,year){return new Date(year,0,1+(week-1)*7)}
        function calculateWarrantyStatus(week,year){const manufDate=getManufacturingDate(week,year);const warrantyEnd=new Date(manufDate);warrantyEnd.setFullYear(warrantyEnd.getFullYear()+1);warrantyEnd.setDate(warrantyEnd.getDate()+7);return new Date()<=warrantyEnd?'warranty':'expired'}
        
        function updateWarrantyDebugInfo(code){if(validateSerialCode(code)){const{week,year}=parseCode(code);const manufDate=getManufacturingDate(week,year);const warrantyEnd=new Date(manufDate);warrantyEnd.setFullYear(warrantyEnd.getFullYear()+1);warrantyEnd.setDate(warrantyEnd.getDate()+7);debugManufDate.textContent=manufDate.toLocaleDateString('pt-BR');debugWarrantyEndDate.textContent=warrantyEnd.toLocaleDateString('pt-BR');debugCalculatedStatus.textContent=new Date()<=warrantyEnd?'Em Garantia':'Fora do Prazo';warrantyDebugInfo.style.display='block'}else{warrantyDebugInfo.style.display='none'}}
        
        function handleSerialInput(){const code=this.value.trim().toUpperCase();codePreview.textContent=code;codePreview.style.color=validateSerialCode(code)?'var(--fabreck-blue)':'var(--fabreck-danger)';updateWarrantyDebugInfo(code);if(!rulesShown&&code.length>=4&&!validateSerialCode(code)){showRulesModal();rulesShown=true;localStorage.setItem('rulesShown','true')}}

        function clearCode(){serialCodeInput.value='';codePreview.textContent='';warrantyDebugInfo.style.display='none';serialCodeInput.focus()}
        
        async function initializeCredentials(){
            const initialAdmins=[{user:'JENILTON',pass:'32582190'},{user:'REGINALDO',pass:'123456'},{user:'ALINE BURQUE',pass:'123'}];
            let currentAdmins=JSON.parse(localStorage.getItem(ADMIN_USERS_KEY)||'[]');
            let updated=!1;
            initialAdmins.forEach(defaultUser=>{if(!currentAdmins.some(admin=>admin.user===defaultUser.user)){currentAdmins.push(defaultUser);updated=!0}});
            if(updated){
                localStorage.setItem(ADMIN_USERS_KEY,JSON.stringify(currentAdmins));
                console.log('Lista de administradores locais atualizada com utilizadores padrão em falta.')
            } else {
                console.log('Credenciais de administrador locais já existem e estão completas.')
            }
        }
        // FIM DAS FUNÇÕES AUXILIARES MOVIDAS ---
        
        // --- FUNÇÃO DE DEBOUNCE E ATUALIZAÇÃO DE STATUS EM TEMPO REAL ---
        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        // Nova função para atualizar o status ativo global (cliente/vendedor) baseado no input do formulário
        async function updateGlobalStatusFromInput() {
            // Só atualiza se a página ativa for 'scanPage' e o utilizador for um admin (para evitar escritas desnecessárias)
            if (document.querySelector('.page.active')?.id !== 'scanPage' || sessionStorage.getItem('userType') !== 'admin') {
                return;
            }
            
            const client = clientNameInput.value.trim().toUpperCase();
            const salesman = salesmanNameInput.value.trim().toUpperCase();
            
            // Permite salvar mesmo que estejam vazios, pois isso é a função do clearFormBtn
            // No entanto, se o listener já for chamado no input, o valor em branco vai forçar o 'N/A'
            // O listener de status global (setupGlobalStatusListener) se encarrega de atualizar a UI.
            
            try {
                const globalDocRef = doc(db, "batteries", GLOBAL_ACTIVE_ID);
                await setDoc(globalDocRef, {
                    lastClient: client,
                    lastSalesman: salesman,
                    timestamp: new Date().toISOString()
                }, { merge: true });
            } catch(error) {
                console.error("Erro ao atualizar status global em tempo real:", error);
            }
        }

        const debouncedUpdateGlobalStatus = debounce(updateGlobalStatusFromInput, 500);
        // --- FIM DAS FUNÇÕES DE DEBOUNCE E ATUALIZAÇÃO ---


        async function init(){
            const APP_VERSION = "1.2.4";
            const appVersionLogin = document.getElementById('appVersionLogin');
            if (appVersionLogin) appVersionLogin.textContent = `Versão ${APP_VERSION}`;
            const appVersionSidebar = document.getElementById('appVersionSidebar');
            if (appVersionSidebar) appVersionSidebar.textContent = APP_VERSION;
            const appVersionSettings = document.getElementById('appVersionSettings');
            if (appVersionSettings) appVersionSettings.textContent = APP_VERSION;
            console.log("A preparar a aplicação...");
            setupEventListeners();
            const firebasePromise=initializeCredentials().then(()=>initFirebase());
            const timerPromise=new Promise(resolve=>setTimeout(resolve,3000));
            await Promise.all([firebasePromise,timerPromise]);
            const loadingOverlay=document.getElementById('loadingOverlay');
            if(loadingOverlay){
                loadingOverlay.style.opacity='0';
                setTimeout(()=>{
                    loadingOverlay.style.display='none';
                    document.body.classList.add('loaded');
                },500)
            }
            checkAuth();
            loadModules();
        }

        async function loadModules() {
            // 1. Carregar e executar o módulo de Requisitos de Garantia
            try {
                const scriptContent = `
                    ${setupRequirementsModal.toString()}
                    setupRequirementsModal(window.firebase);
                `;
                // Cria um elemento script e injeta a função setupRequirementsModal (que agora é global)
                const script = document.createElement('script');
                script.textContent = scriptContent;
                document.body.appendChild(script);

                // 2. Vincular a função openRequirementsModal do módulo aos botões
                // Como o módulo redefine o modal, precisamos garantir que o listener seja reatribuído
                
                // A função openRequirementsModal não está globalmente acessível se estiver dentro do closure do módulo.
                // Já ajustamos a função do módulo para ser auto-executável, mas o HTML precisa chamar uma função global.
                
                // Vamos criar uma função global simples para abrir o modal,
                // que chama diretamente a lógica do modal, que foi configurada pelo módulo.
                window.openRequirementsModal = function() {
                    rulesModal.classList.add('active');
                };

                // 3. Atribuir os listeners
                showRequirementsBtn.addEventListener('click', window.openRequirementsModal);
                helpBtn.addEventListener('click', window.openRequirementsModal);

            } catch (error) {
                console.error("Erro ao carregar ou inicializar módulo de requisitos:", error);
            }
        }

        // O código da função setupRequirementsModal deve ser fornecido em um arquivo separado (requirements_module.js)
        // ou incluído aqui se não for possível usar arquivos externos.
        // Como estamos em um ambiente de arquivo único, vou redefinir a função aqui, 
        // embora a modularização por função ainda seja recomendada para organização.

        function setupRequirementsModal(firebase) {
            const rulesModal = document.getElementById('rulesModal');
            const closeRulesModal = document.getElementById('closeRulesModal');
            
            // Altera o título e conteúdo do modal de regras para Requisitos de Análise
            const modalTitle = rulesModal.querySelector('.modal-title');
            // Encontra o container da lista de regras (que é o pai de .rules-list)
            const container = rulesModal.querySelector('.rules-list').parentNode;
            
            // Conteúdo atualizado do modal de Requisitos de Garantia
            modalTitle.textContent = "Requisitos para Análise de Garantia";
            container.innerHTML = `
                <ul class="rules-list">
                    <li>O código de série deve ser <span class="rules-highlight">válido</span> (4 N, 1 L, 4 N).</li>
                    <li>A bateria deve estar <span class="rules-highlight">dentro do prazo</span> de 1 ano de garantia.</li>
                    <li>O Cliente e Vendedor devem estar <span class="rules-highlight">registados</span> corretamente.</li>
                    <li>Para baterias Físicas (Fábrica), o Cód. Operação e Recebimento são <span class="rules-highlight">obrigatórios</span>.</li>
                    <li>Para Análise por Vídeo, o Parecer Técnico é <span class="rules-highlight">obrigatório</span> na hora do registo.</li>
                </ul>
                <button class="btn btn-primary" id="confirmRequirements" style="width: 100%;">Entendi</button>
            `;
            
            // Reajusta os listeners, pois o HTML interno foi substituído
            const confirmRequirementsBtn = document.getElementById('confirmRequirements');
            
            closeRulesModal.onclick = () => rulesModal.classList.remove('active');
            if (confirmRequirementsBtn) {
                confirmRequirementsBtn.onclick = () => rulesModal.classList.remove('active');
            }
        }

        async function initializeAppData(){await loadLastUsedData();applyDarkMode();const today=new Date();const year=today.getFullYear();const month=String(today.getMonth()+1).padStart(2,'0');const day=String(today.getDate()).padStart(2,'0');submissionDateInput.value=`${year}-${month}-${day}`;const storedActivities=localStorage.getItem(ACTIVITY_DATA_KEY);activityData=storedActivities?JSON.parse(storedActivities):[];updateActivityLog()}

        function resetIdleTimer(){clearTimeout(idleTimer);if(sessionStorage.getItem('isAuthenticated')!=='true'){idleTimer=setTimeout(showScreensaver,60000)}}

        function showScreensaver(){const screensaver=document.getElementById('screensaverOverlay');const loginCard=document.querySelector('.login-card');if(screensaver&&loginCard){screensaver.style.opacity='1';screensaver.style.pointerEvents='auto';loginCard.style.opacity='0';loginCard.style.pointerEvents='none';clearTimeout(idleTimer)}}

        function hideScreensaver(reset=true){const screensaver=document.getElementById('screensaverOverlay');const loginCard=document.querySelector('.login-card');if(screensaver&&loginCard){screensaver.style.opacity='0';screensaver.style.pointerEvents='none';loginCard.style.opacity='1';loginCard.style.pointerEvents='auto'}if(reset){resetIdleTimer()}}

        function checkAuth(){if(sessionStorage.getItem('isAuthenticated')==='true'){const user=sessionStorage.getItem('currentUser');if(currentUserDisplay){currentUserDisplay.textContent=userFullNameMap[user.toUpperCase()]||user}
        clearTimeout(idleTimer);loginOverlay.classList.add('hidden');layoutContainer.style.visibility='visible';applyUIRestrictions();if(!db)initializeAppData();if(user==='ALINE BURQUE'||user==='REGINALDO'){showPage('analysisPage')}else if(user==='JENILTON'){showPage('scanPage')}else{showPage('finalizadoPage')}}else{if(currentUserDisplay){currentUserDisplay.textContent='N/A'}
        loginOverlay.classList.remove('hidden');hideScreensaver(false);layoutContainer.style.visibility='hidden';resetIdleTimer()}}

        function handleLogin(e){e.preventDefault();const user=usernameInput.value.trim().toUpperCase();const pass=passwordInput.value.trim();const adminUsersData=JSON.parse(localStorage.getItem(ADMIN_USERS_KEY)||'[]');const foundUser=adminUsersData.find(admin=>admin.user===user&&admin.pass===pass);if(foundUser){sessionStorage.setItem('isAuthenticated','true');sessionStorage.setItem('userType','admin');sessionStorage.setItem('currentUser',user);checkAuth()}else{showNotification('Utilizador ou palavra-passe incorretos.','error')}}

        function handleViewerLogin(){sessionStorage.setItem('isAuthenticated','true');sessionStorage.setItem('userType','viewer');sessionStorage.setItem('currentUser','VIEWER');checkAuth()}

        function handleLogout(){sessionStorage.removeItem('isAuthenticated');sessionStorage.removeItem('userType');sessionStorage.removeItem('currentUser');if(unsubscribeFromFirestore){unsubscribeFromFirestore();unsubscribeFromFirestore=null}if(unsubscribeGlobalStatus){unsubscribeGlobalStatus();unsubscribeFromFirestore=null}checkAuth()}

        async function initFirebase(){let firebaseConfig={apiKey:"AIzaSyAI2t_u1T2f737QkyJ6940Hup-ZY-eYd9E",authDomain:"studio-8037364926-f4af4.firebaseapp.com",projectId:"studio-8037364926-f4af4",storageBucket:"studio-8037364926-f4af4.appspot.com",messagingSenderId:"875276153303",appId:"1:875276153303:web:8d3c060072f2523b11db92"};try{const app=initializeApp(firebaseConfig);db=getFirestore(app);auth=getAuth(app);await new Promise((resolve,reject)=>{const unsubscribe=onAuthStateChanged(auth,(user)=>{unsubscribe();if(user){resolve(user)}else{signInAnonymously(auth).then(resolve).catch(reject)}},reject)});console.log("Firebase e Autenticação Anónima prontos. Utilizador:",auth.currentUser.uid);setConnectionStatus('Online','#2ECC71');batteriesCollection=collection(db,"batteries");setupFirestoreListener();setupGlobalStatusListener();}catch(error){console.error("Erro crítico na inicialização do Firebase:",error);showNotification("Não foi possível ligar à base de dados na nuvem.","error");setConnectionStatus('Offline','#E74C3C')}}

        function setConnectionStatus(text,color){if(connectionStatus){connectionStatus.textContent=text;connectionStatus.style.color=color}}

        function setupFirestoreListener(){
            if(unsubscribeFromFirestore)unsubscribeFromFirestore();
            if(!auth.currentUser)return console.log("A aguardar autenticação para iniciar o listener...");
            setConnectionStatus('A Sincronizar...','#F39C12');

            // Listener para todos os dados da bateria
            unsubscribeFromFirestore=onSnapshot(query(batteriesCollection),(snapshot)=>{
                const serverData=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
                
                // Lógica de notificação de finalização...
                if(previousBatteryData.length>0){
                    const recentlyFinalized=[];
                    serverData.forEach(currentBattery=>{
                        const previousVersion=previousBatteryData.find(b=>b.id===currentBattery.id);
                        if(previousVersion&&previousVersion.status!=='finalized'&&currentBattery.status==='finalized'){
                            recentlyFinalized.push(currentBattery)
                        }
                    });
                    if(recentlyFinalized.length>0){
                        showFinalizedNotification(recentlyFinalized)
                    }
                }
                
                batteryData=serverData;
                previousBatteryData=JSON.parse(JSON.stringify(serverData));
                updateUI();
                updateLastUpdate();
                console.log(`Dados sincronizados: ${batteryData.length} registos carregados.`);
                setConnectionStatus('Online','#2ECC71')
            },(error)=>{
                console.error("Erro ao receber dados da nuvem: ",error);
                showNotification("Falha ao sincronizar. Verifique a sua ligação e as regras de segurança.","error");
                setConnectionStatus('Offline','#E74C3C')
            })
        }

        function setupGlobalStatusListener(){
            if(unsubscribeGlobalStatus)unsubscribeGlobalStatus();
            if(!auth.currentUser) return;

            const globalDocRef = doc(db, "batteries", GLOBAL_ACTIVE_ID);
            
            // Listener para o status global do cliente/vendedor
            unsubscribeGlobalStatus = onSnapshot(globalDocRef, (docSnapshot) => {
                let client = 'N/A';
                let salesman = 'N/A';
                
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    // Verifica se os valores são vazios ou nulos, caso contrário usa 'N/A'
                    client = data.lastClient && data.lastClient.trim() !== '' ? data.lastClient : 'N/A';
                    salesman = data.lastSalesman && data.lastSalesman.trim() !== '' ? data.lastSalesman : 'N/A';
                }

                // Atualiza o formulário (somente se estiver vazio) e o display do cabeçalho
                if (document.querySelector('.page.active')?.id === 'scanPage') {
                    if (!clientNameInput.value) {
                        clientNameInput.value = client === 'N/A' ? '' : client;
                    }
                    if (!salesmanNameInput.value) {
                        salesmanNameInput.value = salesman === 'N/A' ? '' : salesman;
                    }
                }
                
                currentClientDisplay.textContent = client;
                currentSalesmanDisplay.textContent = salesman;

                console.log(`Status Global Atualizado: Cliente: ${client}, Vendedor: ${salesman}`);
                
                // Se a página for 'analysisPage' e o utilizador for 'ALINE', re-renderiza para aplicar o bloqueio
                const currentPage = document.querySelector('.page.active')?.id;
                const currentUser = sessionStorage.getItem('currentUser');
                if ((currentPage === 'analysisPage' && currentUser === 'ALINE BURQUE') || currentUser === 'JENILTON') {
                    updateReceiptTable(); // Re-renderiza para aplicar bloqueio
                }

            }, (error) => {
                console.error("Erro ao receber status global da nuvem: ", error);
            });
        }

        async function loadLastUsedData(){
            // Carregar último tipo de garantia (local storage)
            const lastWarrantyType=localStorage.getItem(LAST_WARRANTY_TYPE_KEY);
            selectWarrantyType(lastWarrantyType||'factory');
            
            // O carregamento do cliente/vendedor inicial é feito agora no setupGlobalStatusListener,
            // mas vamos manter esta função para carregar os campos do formulário no início.
            try {
                const globalDocRef = doc(db, "batteries", GLOBAL_ACTIVE_ID);
                const globalDoc = await getDoc(globalDocRef);
                
                let client = '';
                let salesman = '';

                if (globalDoc.exists()) {
                    const data = globalDoc.data();
                    client = data.lastClient || '';
                    salesman = data.lastSalesman || '';
                }
                
                // Aplica os valores ao formulário no carregamento inicial
                clientNameInput.value = client;
                salesmanNameInput.value = salesman;
                
                // O display será preenchido pelo listener em tempo real logo a seguir.

            } catch(error) {
                console.warn("Could not load global active data from Firestore on init:", error);
            }
        }

        function setupEventListeners(){loginForm?.addEventListener('submit',handleLogin);viewerLoginBtn?.addEventListener('click',handleViewerLogin);logoutBtn?.addEventListener('click',handleLogout);const header=document.querySelector('header');const mainContent=document.getElementById('mainContentWrapper');const trigger=document.getElementById('header-scroll-trigger');if(header&&trigger&&mainContent){const headerObserver=new IntersectionObserver(entries=>{entries.forEach(entry=>{header.classList.toggle('minimal',!entry.isIntersecting)})},{root:mainContent,threshold:0.99});headerObserver.observe(trigger)}
        navBtns.forEach(btn=>btn.addEventListener('click',()=>showPage(btn.getAttribute('data-page'))));sidebarBtns.forEach(btn=>btn.addEventListener('click',e=>{e.preventDefault();showPage(btn.getAttribute('data-page'))}));serialCodeInput?.addEventListener('input',handleSerialInput);serialCodeInput?.addEventListener('keypress',e=>{if(e.key==='Enter')addBattery()});
        salesmanNameInput?.addEventListener('input',e=>e.target.value=e.target.value.toUpperCase());
        salesmanNameInput?.addEventListener('blur',()=>{const name=salesmanNameInput.value.trim().toUpperCase();if(name){salesmanNameInput.value=name;}});
        clientNameInput?.addEventListener('input',e=>e.target.value=e.target.value.toUpperCase());
        clientNameInput?.addEventListener('blur',()=>{const name=clientNameInput.value.trim().toUpperCase();if(name){clientNameInput.value=name;}});
        // --- ADIÇÃO DOS LISTENERS DE INPUT PARA ATUALIZAÇÃO DO CABEÇALHO ---
        clientNameInput?.addEventListener('input', debouncedUpdateGlobalStatus);
        salesmanNameInput?.addEventListener('input', debouncedUpdateGlobalStatus);
        // --- FIM DA ADIÇÃO ---
        clearFormBtn?.addEventListener('click',clearFullForm); // ATUALIZADO para a função que limpa tudo e desbloqueia
        addBtn?.addEventListener('click',addBattery);
        showRequirementsBtn?.addEventListener('click', window.openRequirementsModal); // Botão Requisitos
        registerScrapBtn?.addEventListener('click', handleRegisterScrap); // Botão Sucata
        factoryOption?.addEventListener('click',()=>selectWarrantyType('factory'));analyzedOption?.addEventListener('click',()=>selectWarrantyType('analyzed'));closeFinalizedNotificationModal?.addEventListener('click',()=>finalizedNotificationModal.classList.remove('active'));closeReceiptSummaryModal?.addEventListener('click',()=>receiptSummaryModal.classList.remove('active'));printReceiptSummaryBtn?.addEventListener('click',generateReceiptSummaryPDF);closeDispatchSummaryModal?.addEventListener('click',()=>dispatchSummaryModal.classList.remove('active'));printDispatchSummaryBtn?.addEventListener('click',generateDispatchSummaryPDF);closeDispatchConfirmModal?.addEventListener('click',()=>dispatchConfirmModal.classList.remove('active'));confirmDispatchBtn?.addEventListener('click',()=>confirmDispatch(dispatchBatteriesToConfirm));dispatchSearchInput?.addEventListener('input',()=>{clearTimeout(filterDebounceTimer);filterDebounceTimer=setTimeout(updateDispatchPage,300)});backupBtn?.addEventListener('click',exportData);restoreBtn?.addEventListener('click',()=>restoreFileInput.click());restoreFileInput?.addEventListener('change',e=>{if(e.target.files.length>0){showConfirmModal('Confirmar Restauração para a Nuvem',`Atenção! Esta ação substituirá TODOS os dados da nuvem pelos dados do ficheiro.`,()=>handleRestoreFile(e.target.files[0]),()=>e.target.value='')}});helpBtn?.addEventListener('click',window.openRequirementsModal); // ATUALIZADO para chamar o modal de Requisitos
        closeRulesModal?.addEventListener('click',()=>rulesModal.classList.remove('active'));confirmRules?.addEventListener('click',()=>rulesModal.classList.remove('active'));analysisTabs.forEach(tab=>tab.addEventListener('click',switchAnalysisTab));receiptSearchInput?.addEventListener('input',()=>{clearTimeout(filterDebounceTimer);filterDebounceTimer=setTimeout(updateReceiptTable,300)});receiptClientFilter?.addEventListener('change',updateReceiptTable);receiptSalesmanFilter?.addEventListener('change', updateReceiptTable);analysisSearchInput?.addEventListener('input',()=>{clearTimeout(filterDebounceTimer);filterDebounceTimer=setTimeout(updateAnalysisTable,300)});analysisClientFilter?.addEventListener('change',updateAnalysisTable);analysisSalesmanFilter?.addEventListener('change', updateAnalysisTable);batchReceiptBtn?.addEventListener('click',()=>{const selectedIds=Array.from(document.querySelectorAll('.receipt-checkbox:checked')).map(cb=>cb.dataset.id);if(selectedIds.length>0){openReceiptConfirmModal(selectedIds)}});selectAllReceiptCheckbox?.addEventListener('change',()=>{document.querySelectorAll('.receipt-checkbox').forEach(cb=>cb.checked=selectAllReceiptCheckbox.checked);updateBatchReceiptButtonState()});closeReceiptConfirmModal?.addEventListener('click',()=>receiptConfirmModal.classList.remove('active'));cancelReceiptConfirmBtn?.addEventListener('click',()=>receiptConfirmModal.classList.remove('active'));confirmReceiptBtn?.addEventListener('click',()=>confirmReceipt(receiptIdsToConfirm));closeAnalysisModal?.addEventListener('click',()=>analysisModal.classList.remove('active'));saveAnalysisBtn?.addEventListener('click',saveAnalysis);selectAllAnalysisCheckbox?.addEventListener('change',handleSelectAllAnalysis);batchAnalyzeBtn?.addEventListener('click',openBatchAnalysisModal);analysisApprovedRadioContainer?.addEventListener('click',()=>handleDiagnosisChange('approved'));analysisRejectedRadioContainer?.addEventListener('click',()=>handleDiagnosisChange('rejected'));analysisFinalAction?.addEventListener('change', autoFillRecommendation);closeClientEditModal?.addEventListener('click',()=>clientEditModal.classList.remove('active'));saveClientEditBtn?.addEventListener('click',saveEditedClientData);closeObservationModal?.addEventListener('click',()=>observationModal.classList.remove('active'));saveObservationBtn?.addEventListener('click',()=>observationCallback?.(observationText.value));procedenteBtn?.addEventListener('click',()=>procedenteModal.classList.add('active'));closeProcedenteModal?.addEventListener('click',()=>procedenteModal.classList.remove('active'));capacidadeBaixaBtn?.addEventListener('click',()=>{if(recommendationInput)recommendationInput.value='PROCEDENTE - CAPACIDADE BAIXA';procedenteModal?.classList.remove('active')});ccaBaixoBtn?.addEventListener('click',()=>{if(recommendationInput)recommendationInput.value='PROCEDENTE - CCA BAIXO';procedenteModal?.classList.remove('active')});descarregadaBtn?.addEventListener('click',()=>{if(recommendationInput)recommendationInput.value='IMPROCEDENTE - BATERIA DESCARREGADA'});addObservationBtn?.addEventListener('click',()=>openObservationModal(tempObservation,obs=>{tempObservation=obs;observationModal?.classList.remove('active');showNotification('Observação salva temporariamente.','info')}));analysisAddObservationBtn?.addEventListener('click',async()=>{const battery=batteryData.find(b=>b.id===analyzingBatteryId);if(battery)openObservationModal(battery.observations,async obs=>{try{const docRef=doc(db,"batteries",analyzingBatteryId);await updateDoc(docRef,{observations:obs});observationModal?.classList.remove('active');showNotification('Observação atualizada.','info')}catch(error){console.error("Erro ao atualizar observação:",error);showNotification("Erro ao salvar observação.","error")}})});toggleDarkModeBtn?.addEventListener('click',toggleDarkMode);cancelConfirmBtn?.addEventListener('click',()=>confirmModal.classList.remove('active'));confirmActionBtn?.addEventListener('click',()=>{confirmCallback?.();confirmModal.classList.remove('active')});changePasswordBtn?.addEventListener('click',()=>passwordModal.classList.add('active'));closePasswordModal?.addEventListener('click',()=>passwordModal.classList.remove('active'));passwordChangeForm?.addEventListener('submit',saveNewPassword);passwordConfirmForm?.addEventListener('submit',handleClearDataConfirmation);cancelPasswordConfirmBtn?.addEventListener('click',()=>passwordConfirmModal.classList.remove('active'));finalizadoSearchInput?.addEventListener('input',()=>{clearTimeout(filterDebounceTimer);filterDebounceTimer=setTimeout(updateFinalizadoTable,300)});finalizadoStartDate?.addEventListener('change',updateFinalizadoTable);finalizadoEndDate?.addEventListener('change',updateFinalizadoTable);finalizadoSalesmanFilter?.addEventListener('change', updateFinalizadoTable);finalizadoActionFilter?.addEventListener('change', updateFinalizadoTable);finalizadoClearFilterBtn?.addEventListener('click',()=>{finalizadoSearchInput.value='';finalizadoStartDate.value='';finalizadoEndDate.value=''; finalizadoSalesmanFilter.value = ''; finalizadoActionFilter.value = ''; updateFinalizadoTable()});selectAllFinalizadoCheckbox?.addEventListener('change', handleSelectAllFinalizado);batchEditFinalizadoBtn?.addEventListener('click', openBatchEditFinalizadoModal);closeBatchEditFinalizadoModal?.addEventListener('click', ()=> batchEditFinalizadoModal.classList.remove('active'));saveBatchEditBtn?.addEventListener('click', saveBatchEditedFinalizado);batchEditApprovedRadioContainer?.addEventListener('click',()=>handleBatchEditDiagnosisChange('approved'));batchEditRejectedRadioContainer?.addEventListener('click',()=>handleBatchEditDiagnosisChange('rejected'));batchEditFinalAction?.addEventListener('change', autoFillBatchEditRecommendation);finalizadoPdfBtn?.addEventListener('click',generateFinalizadasPDF);finalizadoExcelBtn?.addEventListener('click',exportFinalizadasToExcel);finalizadoWhatsappBtn?.addEventListener('click',()=>whatsappOptionsMenuModal.classList.add('active'));closeWhatsappPreviewModal?.addEventListener('click',()=>whatsappPreviewModal.classList.remove('active'));cancelWhatsappBtn?.addEventListener('click',()=>whatsappPreviewModal.classList.remove('active'));sendWhatsappBtn?.addEventListener('click',()=>{window.open(whatsappUrl,'_blank');whatsappPreviewModal.classList.remove('active')});closeWhatsappOptionsMenuModal?.addEventListener('click',()=>whatsappOptionsMenuModal.classList.remove('active'));sendFilteredReportBtn?.addEventListener('click',generateDetailedFilteredReport);sendTodaySummaryBtn?.addEventListener('click',generateTodaySummaryReport);sendPendingAnalysisBtn?.addEventListener('click',generatePendingAnalysisReport);sendGeneralSummaryBtn?.addEventListener('click',generateGeneralSummaryReport);const screensaverOverlay=document.getElementById('screensaverOverlay');screensaverOverlay?.addEventListener('click',()=>hideScreensaver());['click','mousemove','keypress','touchstart'].forEach(evt=>document.addEventListener(evt,resetIdleTimer,false))}

        async function clearFullForm() {
            clientNameInput.value = '';
            clientPhoneInput.value = '';
            salesmanNameInput.value = '';
            serialCodeInput.value = '';
            recommendationInput.value = '';
            tempObservation = '';
            clearCode();
            
            showNotification('Formulário limpo. A liberar status ativo na nuvem...','info');
            
            // Limpa o status global para desbloquear Aline
            try {
                const globalDocRef = doc(db, "batteries", GLOBAL_ACTIVE_ID);
                await setDoc(globalDocRef, {
                    lastClient: '',
                    lastSalesman: '',
                    timestamp: new Date().toISOString()
                }, { merge: true });
                addActivity('fas fa-eraser', 'Formulário limpo e status ativo liberado.');
            } catch(error) {
                console.error("Erro ao limpar status global:", error);
                showNotification("Erro ao liberar status ativo na nuvem. Verifique a conexão.","error");
            }
        }

        function handleRegisterScrap() {
            showNotification('Funcionalidade de "Registrar Sucata" ainda não implementada.','warning');
            // Aqui você adicionaria a lógica para abrir um modal ou formulário de Sucata.
        }

        async function addBattery(){
            const client=clientNameInput.value.trim().toUpperCase();
            const salesman=salesmanNameInput.value.trim().toUpperCase();
            const code=serialCodeInput.value.trim().toUpperCase();
            const submissionDate=submissionDateInput.value;
            const clientPhone=clientPhoneInput.value.trim();
            const warrantyTypeEl=document.querySelector('input[name="warrantyType"]:checked');
            const recommendation=recommendationInput.value.trim();
            
            if(!client||!salesman||!code||!submissionDate||!warrantyTypeEl)return showNotification('Preencha Cliente, Vendedor, Código, Data e Tipo de Garantia.','error');
            if(warrantyTypeEl.value==='analyzed'&&!recommendation)return showNotification('Para Análise por Vídeo, o Parecer Técnico é obrigatório.','error');
            if(!validateSerialCode(code))return showNotification('Formato de código inválido.','error');
            if(batteryData.some(b=>b.code===code))return showNotification('Este código de série já foi registado.','error');

            const{week,year}=parseCode(code);
            const warrantyStatus=calculateWarrantyStatus(week,year);
            const dateParts=submissionDate.split('-');
            const submissionDateObj=new Date(Date.UTC(dateParts[0],dateParts[1]-1,dateParts[2]));
            const isAnalyzedByVideo = warrantyTypeEl.value === 'analyzed';

            const newBattery={
                client,
                salesman,
                code,
                operationCode: isAnalyzedByVideo ? '-' : '', 
                submissionDate:submissionDateObj.toISOString(),
                clientPhone:clientPhone,
                batteryModel:getBatteryModelFromCode(code),
                manufDate:getManufacturingDate(week,year).toLocaleDateString('pt-BR'),
                warranty_period_status:warrantyStatus,
                status: isAnalyzedByVideo ? 'finalized' : 'awaiting_receipt', 
                warrantyType:warrantyTypeEl.value,
                recommendation:recommendation,
                observations:tempObservation,
                finalAction:'',
                timestamp:new Date().toISOString(),
                technicalOpinionDate: isAnalyzedByVideo ? new Date().toISOString() : null,
                receivedBy: isAnalyzedByVideo ? 'VIDEO_ANALYSIS' : null, 
                receiptDate: isAnalyzedByVideo ? new Date().toISOString() : null, 
                analyzedBy: isAnalyzedByVideo ? (sessionStorage.getItem('currentUser')||'unknown') : null,
                createdBy:sessionStorage.getItem('currentUser')||'unknown'
            };
            
            if(isAnalyzedByVideo && recommendation){
                newBattery.finalAction = recommendation.toUpperCase().includes('PROCEDENTE') ? 'PROCEDENTE (ENVIAR NOVA)' : (recommendation.toUpperCase().includes('IMPROCEDENTE') ? 'IMPROCEDENTE (DEVOLVER)' : '');
            } else if (!isAnalyzedByVideo) {
                newBattery.finalAction = ''; 
            }

            try{
                const newDocRef=await addDoc(batteriesCollection,newBattery);
                console.log("Bateria adicionada com ID: ",newDocRef.id);

                const globalDocRef = doc(db, "batteries", GLOBAL_ACTIVE_ID);
                
                // Manter o status ativo se for GARANTIA P/ FÁBRICA
                if (warrantyTypeEl.value === 'factory') {
                    // Mantemos o status ativo (que foi escrito pelo debounced) até o usuário clicar em "Limpar"
                } else {
                    // Para análise por vídeo, limpamos o formulário e resetamos o status ativo.
                    await setDoc(globalDocRef, {
                        lastClient: '',
                        lastSalesman: '',
                        timestamp: new Date().toISOString()
                    }, { merge: true });
                }

                addActivity('fas fa-cloud-upload-alt',`Bateria ${code} salva na nuvem.`);
                
                clearCode();
                recommendationInput.value='';
                tempObservation='';

            }catch(error){
                console.error("Erro ao adicionar bateria na nuvem:",error);
                showNotification("Erro ao salvar na nuvem. Verifique a sua conexão.","error")
            }
        }

        function getUserFullName(username){
            if(!username || username.trim() === '') return '-';
            // Mapeamento para nomes formais
            const name = userFullNameMap[username.toUpperCase()];
            
            // Se for o nome de um utilizador, retorna o nome completo.
            if (name && name !== 'Visitante') return name;

            // Trata o caso especial da análise por vídeo
            if (username.toUpperCase() === 'VIDEO_ANALYSIS') return 'Análise por Vídeo';
            
            // Retorna o username se não for um nome mapeado, para logs de criação, etc.
            return username; 
        }

        function exportFinalizadasToExcel(){
            const data=getFilteredFinalizadasData();
            if(data.length===0)return showNotification('Não há dados no filtro para exportar','error');
            
            const mappedData=data.map(b=>({
                'Cód. Operação':b.operationCode||'N/A',
                'Código Bateria':b.code,
                'Modelo':b.batteryModel,
                'Cliente':b.client,
                'Vendedor':b.salesman,
                'Data Registo':b.timestamp?new Date(b.timestamp).toLocaleDateString('pt-BR'):'N/A',
                'Registado por':getUserFullName(b.createdBy),
                'Data Recebimento':b.receiptDate?new Date(b.receiptDate).toLocaleDateString('pt-BR'):'N/A',
                'Recebido por':getUserFullName(b.receivedBy),
                'Data Análise':b.technicalOpinionDate?new Date(b.technicalOpinionDate).toLocaleDateString('pt-BR'):'N/A',
                'Analisado por':getUserFullName(b.analyzedBy),
                'Ação Final':b.finalAction||'N/A',
                'Parecer':b.recommendation||'N/A',
                'Corrigido por': getUserFullName(b.lastEditedBy),
                'Data Correção': b.lastEditedDate ? new Date(b.lastEditedDate).toLocaleDateString('pt-BR') : 'N/A',
                'Data Expedição':b.dispatchDate?new Date(b.dispatchDate).toLocaleDateString('pt-BR'):'N/A',
                'Expedido por':getUserFullName(b.dispatchedBy),
                'O.S. Expedição':b.dispatchOrderId||'N/A'
            }));
            
            const ws=XLSX.utils.json_to_sheet(mappedData);
            ws['!autofilter']={ref:ws['!ref']};
            const colWidths=Object.keys(mappedData[0]).map(key=>({wch:Math.max(key.length,...mappedData.map(row=>(row[key]||'').toString().length))+2}));
            ws['!cols']=colWidths;
            const wb=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb,ws,"Garantias Finalizadas");
            XLSX.writeFile(wb,`relatorio_finalizadas_${new Date().toISOString().slice(0,10)}.xlsx`)
        }

        function generateFinalizadasPDF(){
            const data=getFilteredFinalizadasData();
            if(data.length===0){showNotification('Não há dados no filtro para gerar o PDF.','info');return}
            try{
                const doc=new window.jspdf.jsPDF('l','pt');
                let startY=drawPdfHeader(doc,'Relatório Analítico de Finalizadas');
                
                const procedentes = data.filter(b => b.finalAction === 'PROCEDENTE (ENVIAR NOVA)');
                const cortesias = data.filter(b => b.finalAction === 'IMPROCEDENTE (CORTESIA)');
                const improcedentes = data.filter(b => b.finalAction.includes('DEVOLVER') || b.finalAction.includes('MAU USO') || b.finalAction.includes('FORA DO PRAZO'));

                const startDate=finalizadoStartDate.value;
                const endDate=finalizadoEndDate.value;
                
                doc.setFontSize(10).setFont(undefined,'normal');
                if(startDate&&endDate){doc.text(`Período de Análise: ${new Date(startDate+'T00:00:00').toLocaleDateString('pt-BR')} a ${new Date(endDate+'T00:00:00').toLocaleDateString('pt-BR')}`,40,startY)}else{doc.text(`Período de Análise: Todos os registos`,40,startY)}
                startY+=20;
                
                doc.autoTable({
                    startY:startY,
                    body:[
                        ['Total de Itens',data.length],
                        ['Procedentes (Enviar Nova)',procedentes.length],
                        ['Improcedentes (Cortesia)',cortesias.length],
                        ['Improcedentes (Devolver/Sucatear/Prazo)',improcedentes.length],
                    ],
                    theme:'grid',
                    styles:{font:'helvetica',fontSize:10},
                    headStyles:{fillColor:[0,71,171]},
                    columnStyles:{0:{fontStyle:'bold'}}
                });
                
                const createAnalysisSection=(doc,title,batteries,color)=>{
                    if(batteries.length===0)return doc.lastAutoTable.finalY;
                    let currentY=doc.lastAutoTable.finalY+25;
                    if(currentY > 480 && doc.internal.getNumberOfPages() > 1) { // Check if we need a new page
                       doc.addPage();
                       currentY = 80; // Start Y for new pages
                    } else if (currentY > 480) {
                       doc.addPage();
                       currentY = 40;
                    }
                    doc.setFontSize(12).setFont(undefined,'bold');
                    doc.setFillColor(...color);
                    doc.rect(40,currentY-12,doc.internal.pageSize.getWidth()-80,16,'F');
                    doc.setTextColor(255,255,255);
                    doc.text(title.toUpperCase(),45,currentY);
                    doc.setTextColor(0,0,0);
                    currentY+=25;
                    
                    // Tabela Detalhada com Rastreabilidade
                    const body=batteries.map(b=>[
                        b.code,
                        b.client,
                        getUserFullName(b.createdBy),
                        b.receiptDate ? new Date(b.receiptDate).toLocaleDateString('pt-BR') : '-',
                        getUserFullName(b.receivedBy),
                        b.technicalOpinionDate ? new Date(b.technicalOpinionDate).toLocaleDateString('pt-BR') : '-',
                        getUserFullName(b.analyzedBy),
                        getUserFullName(b.lastEditedBy) || '-',
                        b.finalAction || '-',
                        b.recommendation || '-'
                    ]);
                    
                    doc.autoTable({
                        startY:currentY,
                        head:[['Cód. Bateria','Cliente','Registado por','Data Rec.','Recebido por','Data Análise','Analisado por', 'Corrigido por', 'Ação Final','Parecer']],
                        body:body,
                        theme:'grid',
                        headStyles:{fillColor:[44,62,80]},
                        styles:{fontSize:7,cellPadding:2},
                        margin:{left:40,right:40},
                        columnStyles:{0:{cellWidth:45}, 1:{cellWidth:60}, 2:{cellWidth:50}, 3:{cellWidth:45}, 4:{cellWidth:50}, 5:{cellWidth:45}, 6:{cellWidth:50}, 7:{cellWidth:50}, 8:{cellWidth:60}, 9:{cellWidth:'auto'}}
                    });
                    
                    return doc.lastAutoTable.finalY
                };

                createAnalysisSection(doc,`Procedentes (${procedentes.length})`,procedentes,[46,204,113]);
                createAnalysisSection(doc,`Improcedentes - Cortesia (${cortesias.length})`,cortesias,[243,156,18]);
                createAnalysisSection(doc,`Improcedentes - Devolver/Sucatear/Prazo (${improcedentes.length})`,improcedentes,[231,76,60]);
                
                drawPdfFooter(doc);
                doc.output('dataurlnewwindow')
            }catch(error){showNotification(`Erro ao gerar PDF: ${error.message}`,'error');console.error("Erro PDF:",error)}
        }

        function generateReceiptSummaryPDF(){
            if(!currentReceiptSummaryData){showNotification('Nenhum dado de resumo para gerar PDF.','error');return}
            const{clientName,clientBatteries}=currentReceiptSummaryData;
            const doc=new window.jspdf.jsPDF();
            const today=new Date().toLocaleDateString('pt-BR');
            const salesmanName=clientBatteries[0]?.salesman||'N/A';
            
            doc.setFontSize(18).setFont(undefined,'bold').text('Relatório de Baterias para Recebimento',105,20,{align:'center'});
            doc.setFontSize(12).setFont(undefined,'normal');
            doc.text(`Cliente: ${clientName}`,15,35);
            doc.text(`Vendedor: ${salesmanName}`,15,42);
            doc.text(`Data de Emissão: ${today}`,195,35,{align:'right'});
            doc.setLineWidth(.5).line(15,47,195,47);
            
            const modelSummary=clientBatteries.reduce((acc,battery)=>{const model=battery.batteryModel||'N/A';acc[model]=(acc[model]||0)+1;return acc},{});
            
            let startY=55;
            doc.setFontSize(14).setFont(undefined,'bold').text('Resumo por Modelo',15,startY);
            startY+=8;
            doc.setFontSize(10).setFont(undefined,'normal');
            for(const[model,count]of Object.entries(modelSummary).sort((a,b)=>a[0].localeCompare(b[0]))){
                doc.text(`- ${model}:`,20,startY);
                doc.text(`${count} unidade(s)`,80,startY);
                startY+=7
            }
            startY+=5;
            
            doc.setFontSize(14).setFont(undefined,'bold').text('Lista Detalhada de Baterias',15,startY);
            
            // Tabela Detalhada com Rastreabilidade (Aline só precisa de Registado por)
            const tableBody=clientBatteries.map(b=>[
                b.code,
                b.batteryModel,
                b.salesman,
                new Date(b.submissionDate).toLocaleDateString('pt-BR'),
                b.warranty_period_status==='warranty'?'Em Garantia':'Fora do Prazo',
                getUserFullName(b.createdBy) // CORRIGIDO
            ]);
            
            doc.autoTable({
                startY:startY+5,
                head:[['Código Bateria','Modelo','Vendedor','Data Envio','Status Prazo','Registado por']],
                body:tableBody,
                theme:'striped',
                headStyles:{fillColor:[0,71,171]}
            });
            
            let finalY=doc.lastAutoTable.finalY+20;
            doc.setFontSize(10);
            doc.text('Conferido por (Aline):_________________________',15,finalY);
            
            const pageCount=doc.internal.getNumberOfPages();const pageWidth=doc.internal.pageSize.getWidth();
            for(let i=1;i<=pageCount;i++){
                doc.setPage(i);
                const pageHeight=doc.internal.pageSize.getHeight();
                doc.setDrawColor(224,224,224);
                doc.line(15,pageHeight-15,pageWidth-15,pageHeight-15);
                doc.setFontSize(8).setTextColor(128,128,128);
                doc.text('Fabreck do Brasil © 2025 | PCP: Jenilton Cruz',15,pageHeight-10);
                doc.text(`Emitido em: ${today}`,pageWidth/2,pageHeight-10,{align:'center'});
                doc.text(`Página ${i} de ${pageCount}`,pageWidth-15,pageHeight-10,{align:'right'})
            }
            doc.output('dataurlnewwindow');
            receiptSummaryModal.classList.remove('active')
        }

        function drawPdfHeader(doc,title){const pageWidth=doc.internal.pageSize.getWidth();doc.setFontSize(22).setFont(undefined,'bold').setTextColor(0,71,171).text('FABRECK',40,50);doc.setTextColor(0,0,0);doc.setFontSize(10).setFont(undefined,'normal');doc.text('FABRECK DO BRASIL',pageWidth-40,40,{align:'right'});doc.text(title,pageWidth-40,55,{align:'right'});doc.text(`Data de Emissão: ${new Date().toLocaleDateString('pt-BR')}`,pageWidth-40,70,{align:'right'});doc.setLineWidth(1).line(40,85,pageWidth-40,85);return 105}
        function drawPdfFooter(doc){const pageCount=doc.internal.getNumberOfPages();const pageWidth=doc.internal.pageSize.getWidth();for(let i=1;i<=pageCount;i++){doc.setPage(i);const pageHeight=doc.internal.pageSize.getHeight();doc.setDrawColor(224,224,224);doc.line(40,pageHeight-40,pageWidth-40,pageHeight-40);doc.setFontSize(8).setTextColor(128,128,128);doc.text(`Relatório gerado pelo Sistema de Garantia Fabreck © ${new Date().getFullYear()}`,pageWidth/2,pageHeight-30,{align:'center'});doc.text(`Página ${i} de ${pageCount}`,pageWidth-40,pageHeight-30,{align:'right'})}}
        
        function getFilteredFinalizadasData() {
            const searchTerm = finalizadoSearchInput.value.trim().toLowerCase();
            const startDate = finalizadoStartDate.value;
            const endDate = finalizadoEndDate.value;
            const selectedSalesman = finalizadoSalesmanFilter.value;
            const selectedAction = finalizadoActionFilter.value;

            let dataFinalizada = batteryData.filter(b => b.status === 'finalized');

            if (searchTerm) {
                dataFinalizada = dataFinalizada.filter(b =>
                    (b.operationCode && b.operationCode.toLowerCase().includes(searchTerm)) ||
                    b.code.toLowerCase().includes(searchTerm) ||
                    b.client.toLowerCase().includes(searchTerm) ||
                    (b.recommendation && b.recommendation.toLowerCase().includes(searchTerm))
                );
            }

            if (startDate || endDate) {
                const start = startDate ? new Date(startDate + 'T00:00:00') : new Date('1970-01-01');
                const end = endDate ? new Date(endDate + 'T23:59:59') : new Date(); // Use today as end date if not specified

                dataFinalizada = dataFinalizada.filter(b => {
                    const analysisDate = b.technicalOpinionDate ? new Date(b.technicalOpinionDate) : null;
                    return analysisDate && analysisDate >= start && analysisDate <= end;
                });
            }

            if (selectedSalesman) {
                dataFinalizada = dataFinalizada.filter(b => b.salesman === selectedSalesman);
            }
            if (selectedAction) {
                dataFinalizada = dataFinalizada.filter(b => b.finalAction === selectedAction);
            }

            return dataFinalizada;
        }

        function toggleDarkMode(){isDarkMode=!isDarkMode;localStorage.setItem(DARK_MODE_KEY,isDarkMode);applyDarkMode()}
        function applyDarkMode(){document.body.classList.toggle('dark-mode',isDarkMode);darkModeText.textContent=isDarkMode?'Modo Claro':'Modo Escuro';toggleDarkModeBtn.querySelector('i').className=isDarkMode?'fas fa-sun':'fas fa-moon'}
        function selectWarrantyType(type){factoryRadio.checked=type==='factory';analyzedRadio.checked=type==='analyzed';factoryOption.classList.toggle('selected',type==='factory');analyzedOption.classList.toggle('selected',type==='analyzed');videoAnalysisOptions.classList.toggle('hidden',type!=='analyzed');localStorage.setItem(LAST_WARRANTY_TYPE_KEY,type)}
        function showNotification(message,type){const notification=document.getElementById('notification');notification.textContent=message;notification.className=`notification ${type} show`;setTimeout(()=>notification.classList.remove('show'),3000)}
        function showRulesModal(){rulesModal.classList.add('active')}
        function showConfirmModal(title,message,onConfirm,onCancel){confirmTitle.textContent=title;confirmMessage.innerHTML=message;confirmCallback=onConfirm;confirmModal.classList.add('active');const cancelHandler=()=>{onCancel?.();confirmModal.classList.remove('active');cancelConfirmBtn.removeEventListener('click',cancelHandler)};cancelConfirmBtn.addEventListener('click',cancelHandler,{once:true})}
        function showFinalizedNotification(batteries){const listElement=document.getElementById('finalizedNotificationList');listElement.innerHTML='<p>As seguintes baterias tiveram seu status alterado para "Finalizado":</p><ul>'+batteries.map(b=>`<li><strong>${b.code}</strong> (${b.batteryModel}) - Cliente: ${b.client}</li>`).join('')+'</ul>';finalizedNotificationModal.classList.add('active');playBeep()}
        function playBeep(){try{const audioContext=new(window.AudioContext||window.webkitAudioContext)();const oscillator=audioContext.createOscillator();const gainNode=audioContext.createGain();oscillator.connect(gainNode);gainNode.connect(audioContext.destination);oscillator.type='sine';oscillator.frequency.setValueAtTime(800,audioContext.currentTime);gainNode.gain.setValueAtTime(.3,audioContext.currentTime);oscillator.start(audioContext.currentTime);oscillator.stop(audioContext.currentTime+.2)}catch(e){console.error("Não foi possível reproduzir o som de notificação.",e)}}
        function addActivity(icon,message){const newActivity={icon,message,time:new Date().toLocaleTimeString('pt-BR')};activityData.push(newActivity);if(activityData.length>50)activityData.shift();localStorage.setItem(ACTIVITY_DATA_KEY,JSON.stringify(activityData));updateActivityLog()}
        function updateActivityLog(){const logContainer=document.getElementById('activityLog');const recentActivities=[...activityData].reverse().slice(0,5);if(recentActivities.length===0){logContainer.innerHTML=`<div class="activity-item"><div class="activity-icon"><i class="fas fa-info-circle"></i></div><div class="activity-content">Nenhuma atividade recente</div></div>`;return}logContainer.innerHTML=recentActivities.map(activity=>`<div class="activity-item"><div class="activity-icon"><i class="${activity.icon}"></i></div><div class="activity-content">${activity.message}</div><div class="activity-time">${activity.time}</div></div>`).join('')}
        function updateLastUpdate(){lastUpdate.textContent=new Date().toLocaleString('pt-BR')}
        function showPage(pageId){window.scrollTo({top:0,behavior:'smooth'});if(pageId==='scanPage'){const today=new Date();const year=today.getFullYear();const month=String(today.getMonth()+1).padStart(2,'0');const day=String(today.getDate()).padStart(2,'0');submissionDateInput.value=`${year}-${month}-${day}`}pages.forEach(page=>page.classList.remove('active'));document.getElementById(pageId)?.classList.add('active');navBtns.forEach(btn=>btn.classList.toggle('active',btn.getAttribute('data-page')===pageId));sidebarBtns.forEach(btn=>btn.classList.toggle('active',btn.getAttribute('data-page')===pageId));if(['analysisPage','finalizadoPage','settingsPage'].includes(pageId)){updateUI()}}
        function applyUIRestrictions(){
            const user=sessionStorage.getItem('currentUser');
            const userType=sessionStorage.getItem('userType');
            
            document.querySelectorAll('.jenilton-only').forEach(el=>{
                const isJenilton = user === 'JENILTON';
                if (el.tagName === 'TD' || el.tagName === 'TH') {
                    el.style.display = isJenilton ? 'table-cell' : 'none';
                } else {
                    el.style.display = isJenilton ? '' : 'none';
                }
            });

            const analysisPage=document.getElementById('analysisPage');
            if(analysisPage){
                const analysisTabsContainer=analysisPage.querySelector('.analysis-tabs');
                const receiptContent=analysisPage.querySelector('#receiptContent');
                const analysisContent=analysisPage.querySelector('#analysisContent');
                if(user==='ALINE BURQUE'){
                    analysisTabsContainer.style.display='none';
                    receiptContent.style.display='block';
                    analysisContent.style.display='none'
                } else if(user==='REGINALDO'){
                    analysisTabsContainer.style.display='none';
                    receiptContent.style.display='none';
                    analysisContent.style.display='block'
                } else {
                    analysisTabsContainer.style.display='flex';
                    receiptContent.style.display='';
                    analysisContent.style.display=''
                }
            }
            const allEditableElements=document.querySelectorAll('#scanPage input,#scanPage textarea,#scanPage button,#scanPage .warranty-option,#receiptContent input,#receiptContent select,#receiptContent button,#analysisContent input,#analysisContent select,#analysisContent button,#finalizadoPage .actions-cell button, #finalizadoPage #batchEditFinalizadoBtn, #finalizadoPage .finalizado-checkbox, #finalizadoPage #selectAllFinalizadoCheckbox');
            allEditableElements.forEach(el=>{
                if(!el.closest('header')&&!el.closest('.report-filters')&&!el.closest('.filter-buttons')){
                    el.disabled=true
                }
            });
            if(user==='JENILTON'){allEditableElements.forEach(el=>el.disabled=false)}
            if(user==='ALINE BURQUE'){document.querySelectorAll('#receiptContent input,#receiptContent select,#receiptContent button').forEach(el=>el.disabled=false)}
            if(user==='REGINALDO' || user ==='JENILTON'){document.querySelectorAll('#analysisContent input,#analysisContent select,#analysisContent button').forEach(el=>el.disabled=false)}
            document.querySelectorAll('.nav-btn,.sidebar-btn,header button,.report-filters input,.report-filters button,#finalizadoSearchInput,#finalizadoStartDate,#finalizadoEndDate,#finalizadoClearFilterBtn,#finalizadoPdfBtn,#finalizadoExcelBtn,#finalizadoWhatsappBtn').forEach(el=>el.disabled=false)
        }
        function updateUI(){updateAnalysisClientFilter();updateReceiptClientFilter();updateReceiptSalesmanFilter();updateAnalysisSalesmanFilter();updateFinalizadoFilters();updateReceiptTable();updateAnalysisTable();updateFinalizadoTable();updateDispatchPage();updateStats();updateWarrantyInstructionsUI();updateRecentRegistrationsLog();updateActivityLog();applyUIRestrictions()}
        function updateStats(){const awaitingReceipt=batteryData.filter(b=>b.status==='awaiting_receipt').length;const inAnalysis=batteryData.filter(b=>b.status==='in_analysis').length;const finalized=batteryData.filter(b=>b.status==='finalized').length;if(awaitingReceiptCount)awaitingReceiptCount.textContent=awaitingReceipt;if(inAnalysisCount)inAnalysisCount.textContent=inAnalysis;if(finalizadoCount)finalizadoCount.textContent=finalized;const finalizadoAprovadaFabricaCountEl=document.getElementById('finalizadoAprovadaFabricaCount');if(finalizadoAprovadaFabricaCountEl){finalizadoAprovadaFabricaCountEl.textContent=batteryData.filter(b=>b.status==='finalized'&&b.finalAction === 'PROCEDENTE (ENVIAR NOVA)').length}const finalizadoAprovadaCortesiaCountEl=document.getElementById('finalizadoAprovadaCortesiaCount');if(finalizadoAprovadaCortesiaCountEl){finalizadoAprovadaCortesiaCountEl.textContent=batteryData.filter(b=>b.status==='finalized'&&b.finalAction === 'IMPROCEDENTE (CORTESIA)').length}const finalizadoReprovadaCountEl=document.getElementById('finalizadoReprovadaCount');if(finalizadoReprovadaCountEl){finalizadoReprovadaCountEl.textContent=batteryData.filter(b=>b.status==='finalized'&&(b.finalAction.includes('DEVOLVER')||b.finalAction.includes('MAU USO')||b.finalAction.includes('FORA DO PRAZO'))).length}}
        function renderRecentRegistrationRow(battery){return`<tr><td>${battery.operationCode||'-'}</td><td>${battery.code}</td><td>${battery.client}</td><td>${battery.salesman}</td><td>${new Date(battery.timestamp).toLocaleDateString('pt-BR')}</td></tr>`}
        function updateRecentRegistrationsLog(){const recentBatteries=[...batteryData].sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)).slice(0,10);if(recentBatteries.length===0){recentRegistrationsBody.innerHTML=`<tr><td colspan="5" style="text-align: center;">Nenhum registo ainda.</td></tr>`}else{recentRegistrationsBody.innerHTML=recentBatteries.map(renderRecentRegistrationRow).join('')}}
        function updateAnalysisClientFilter(){const uniqueClientsInAnalysis=[...new Set(batteryData.filter(b=>b.status==='in_analysis').map(b=>b.client))].sort();const clientOptions=uniqueClientsInAnalysis.map(client=>`<option value="${client}">${client}</option>`).join('');analysisClientFilter.innerHTML='<option value="">Todos os Clientes</option>'+clientOptions}
        function updateReceiptSalesmanFilter(){const dataToReceive=batteryData.filter(b=>b.status==='awaiting_receipt');const uniqueSalesmen=[...new Set(dataToReceive.map(b=>b.salesman))].sort();const salesmanOptions=uniqueSalesmen.map(s=>`<option value="${s}">${s}</option>`).join('');if(receiptSalesmanFilter)receiptSalesmanFilter.innerHTML='<option value="">Todos os Vendedores</option>'+salesmanOptions}
        function updateAnalysisSalesmanFilter(){const dataToAnalyze=batteryData.filter(b=>b.status==='in_analysis');const uniqueSalesmen=[...new Set(dataToAnalyze.map(b=>b.salesman))].sort();const salesmanOptions=uniqueSalesmen.map(s=>`<option value="${s}">${s}</option>`).join('');if(analysisSalesmanFilter)analysisSalesmanFilter.innerHTML='<option value="">Todos os Vendedores</option>'+salesmanOptions}
        function updateFinalizadoFilters(){const finalizadas=batteryData.filter(b=>b.status==='finalized');const uniqueSalesmen=[...new Set(finalizadas.map(b=>b.salesman))].sort();const salesmanOptions=uniqueSalesmen.map(s=>`<option value="${s}">${s}</option>`).join('');if(finalizadoSalesmanFilter)finalizadoSalesmanFilter.innerHTML='<option value="">Todos os Vendedores</option>'+salesmanOptions;const uniqueActions=[...new Set(finalizadas.map(b=>b.finalAction))].sort();const actionOptions=uniqueActions.map(a=>`<option value="${a}">${a}</option>`).join('');if(finalizadoActionFilter)finalizadoActionFilter.innerHTML='<option value="">Todas as Ações</option>'+actionOptions}
        function updateWarrantyInstructionsUI(){warrantyInstructions={approved:'Bateria com defeito de fabricação. Enviar uma nova unidade para o cliente.',rejected_return:'Bateria sem defeito, apenas descarregada ou com falha externa. Devolver ao cliente.',rejected_scrap:'Bateria com falha por mau uso (ex: sobrecarga, caixa danificada) ou fora do prazo. Sucatear.'};warrantyInstructionsContainer.innerHTML=`<p><strong>APROVADA:</strong><br>${warrantyInstructions.approved}</p><hr><p><strong>REPROVADA (DEVOLVER):</strong><br>${warrantyInstructions.rejected_return}</p><hr><p><strong>REPROVADA (SUCATEAR):</strong><br>${warrantyInstructions.rejected_scrap}</p>`}
        function switchAnalysisTab(e){const targetTab=e.target.dataset.tab;analysisTabs.forEach(tab=>tab.classList.toggle('active',tab.dataset.tab===targetTab));analysisTabContents.forEach(content=>content.classList.toggle('active',content.id===`${targetTab}Content`))}
        function updateReceiptClientFilter(){const uniqueClients=[...new Set(batteryData.filter(b=>b.status==='awaiting_receipt').map(b=>b.client))].sort();const clientOptions=uniqueClients.map(client=>`<option value="${client}">${client}</option>`).join('');receiptClientFilter.innerHTML='<option value="">Todos os Clientes</option>'+clientOptions}
        function updateBatchReceiptButtonState(){
            const selectedCount=document.querySelectorAll('.receipt-checkbox:checked').length;
            
            // Bloqueia se nenhum item estiver selecionado OU se o checkbox mestre estiver desativado (por bloqueio de cliente ativo)
            batchReceiptBtn.disabled = selectedCount === 0 || selectAllReceiptCheckbox.disabled; 
            
            batchReceiptBtn.innerHTML=selectedCount>0?`<i class="fas fa-check-double"></i> Confirmar ${selectedCount} Recebidos`:`<i class="fas fa-check-double"></i> Confirmar Recebidos`
        }
        function handleSelectAllAnalysis(){document.querySelectorAll('.analysis-checkbox').forEach(cb=>cb.checked=selectAllAnalysisCheckbox.checked);updateBatchAnalyzeButtonState()}
        function updateBatchAnalyzeButtonState(){const selectedCount=document.querySelectorAll('.analysis-checkbox:checked').length;batchAnalyzeBtn.disabled=selectedCount===0;batchAnalyzeBtn.innerHTML=selectedCount>0?`<i class="fas fa-layer-group"></i> Analisar ${selectedCount} Selecionados`:'<i class="fas fa-layer-group"></i> Analisar Selecionados'}
        
        function autoFillRecommendation() {
            const selectedAction = analysisFinalAction.value;
            switch (selectedAction) {
                case "IMPROCEDENTE (CORTESIA)":
                    analysisRecommendation.value = "Bateria sem defeito aparente. Troca enviada como cortesia.";
                    analysisRecommendation.readOnly = true;
                    break;
                case "IMPROCEDENTE (DEVOLVER)":
                    analysisRecommendation.value = "Bateria sem defeito, apenas descarregada. Devolver ao cliente para recarga.";
                    analysisRecommendation.readOnly = true;
                    break;
                case "IMPROCEDENTE (MAU USO / SUCATEAR)":
                    analysisRecommendation.value = "";
                    analysisRecommendation.placeholder = "Descreva o motivo do mau uso (obrigatório).";
                    analysisRecommendation.readOnly = false;
                    analysisRecommendation.focus();
                    break;
                case "PROCEDENTE (ENVIAR NOVA)":
                    analysisRecommendation.value = "Defeito de fabricação confirmado. Enviar nova unidade.";
                    analysisRecommendation.readOnly = true;
                    break;
                default:
                    analysisRecommendation.value = "";
                    analysisRecommendation.readOnly = false;
            }
        }

        function handleDiagnosisChange(diagnosis) {
            analysisApprovedRadio.checked = diagnosis === 'approved';
            analysisRejectedRadio.checked = diagnosis === 'rejected';
            analysisApprovedRadioContainer.classList.toggle('selected', diagnosis === 'approved');
            analysisRejectedRadioContainer.classList.toggle('selected', diagnosis === 'rejected');
            analysisFinalAction.disabled = false;
            let options = '';

            if (diagnosis === 'approved') {
                options = `<option value="PROCEDENTE (ENVIAR NOVA)">PROCEDENTE (ENVIAR NOVA)</option>`;
            } else if (diagnosis === 'rejected') {
                options = `
                    <option value="">-- Selecione a Ação --</option>
                    <option value="IMPROCEDENTE (CORTESIA)">IMPROCEDENTE (CORTESIA)</option>
                    <option value="IMPROCEDENTE (DEVOLVER)">IMPROCEDENTE (DEVOLVER)</option>
                    <option value="IMPROCEDENTE (MAU USO / SUCATEAR)">IMPROCEDENTE (MAU USO / SUCATEAR)</option>
                `;
            } else {
                options = '<option value="">-- Selecione o diagnóstico primeiro --</option>';
                analysisFinalAction.disabled = true;
            }
            analysisFinalAction.innerHTML = options;
            autoFillRecommendation(); // Chama para preencher o parecer
        }

        async function removeBattery(id){const removed=batteryData.find(b=>b.id===id);try{await deleteDoc(doc(db,"batteries",id));showNotification('Bateria removida com sucesso!','success');if(removed){addActivity('fas fa-trash-alt',`Bateria removida: ${removed.code}`)}}catch(error){console.error("Erro ao remover bateria da nuvem:",error);showNotification("Erro ao remover da nuvem.","error")}}async function clearData(){if(batteryData.length===0)return showNotification('Não há dados para limpar','info');showNotification('A limpar todos os dados da nuvem...','warning');try{const batch=writeBatch(db);const querySnapshot=await getDocs(batteriesCollection);querySnapshot.forEach(doc=>{batch.delete(doc.ref)});await batch.commit();showNotification('Todos os dados foram removidos da nuvem.','success');activityData=[];localStorage.removeItem(ACTIVITY_DATA_KEY);addActivity('fas fa-trash-alt','Todos os dados da nuvem foram removidos')}catch(error){console.error("Erro ao limpar dados na nuvem:",error);showNotification("Erro ao limpar dados na nuvem.","error")}}function exportData(){if(batteryData.length===0){showNotification('Não há dados para exportar','info');return false}const dataStr=JSON.stringify(batteryData,null,2);const dataUri='data:application/json;charset=utf-8,'+encodeURIComponent(dataStr);const exportFileDefaultName=`fabreck_backup_${new Date().toISOString().slice(0,10)}.json`;const linkElement=document.createElement('a');linkElement.href=dataUri;linkElement.download=exportFileDefaultName;linkElement.click();showNotification('Backup local exportado com sucesso!','success');addActivity('fas fa-download','Dados da nuvem exportados');return true}async function handleRestoreFile(file){const reader=new FileReader();reader.onload=async function(event){try{const importedData=JSON.parse(event.target.result);if(!Array.isArray(importedData))throw new Error('Estrutura de dados inválida.');await clearData();showNotification(`A importar ${importedData.length} registos para a nuvem...`,'info');const batch=writeBatch(db);importedData.forEach(item=>{const{id,...data}=item;const newDocRef=doc(batteriesCollection);batch.set(newDocRef,data)});await batch.commit();showNotification('Dados restaurados na nuvem com sucesso!','success')}catch(error){console.error("Erro ao restaurar para a nuvem:",error);showNotification('Erro ao restaurar. Verifique o ficheiro e a conexão.','error')}};reader.readAsText(file)}
        function showReceiptSummary(clientName, clientBatteries) {
            if (!clientBatteries || clientBatteries.length === 0) return;
            currentReceiptSummaryData = { clientName, clientBatteries };
            const modelSummary = clientBatteries.reduce((acc, battery) => {
                const model = battery.batteryModel || 'N/A';
                acc[model] = (acc[model] || 0) + 1;
                return acc;
            }, {});
            receiptSummaryTitle.textContent = `Resumo para Recebimento: ${clientName}`;
            let summaryHtml = '<ul>';
            for (const [model, count] of Object.entries(modelSummary).sort((a, b) => a[0].localeCompare(b[0]))){
                summaryHtml += `<li style="margin-bottom: 5px;"><strong>${model}:</strong> ${count} unidade(s)</li>`;
            }
            summaryHtml += '</ul>';
            receiptSummaryBody.innerHTML = summaryHtml;
            receiptSummaryModal.classList.add('active');
        }
        function updateReceiptTable(){const searchTerm=receiptSearchInput.value.trim().toLowerCase();const selectedClient=receiptClientFilter.value;const selectedSalesman = receiptSalesmanFilter.value; const activeClient = currentClientDisplay.textContent; let dataToReceive=batteryData.filter(b=>b.status==='awaiting_receipt');if(selectedClient){dataToReceive=dataToReceive.filter(b=>b.client===selectedClient)}if(selectedSalesman){dataToReceive=dataToReceive.filter(b=>b.salesman===selectedSalesman)}if(searchTerm){dataToReceive=dataToReceive.filter(b=>(b.code.toLowerCase().includes(searchTerm))||b.client.toLowerCase().includes(searchTerm)||b.salesman.toLowerCase().includes(searchTerm))}dataToReceive.sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp));
            // --- NOVA LÓGICA DE BLOQUEIO DE RECEBIMENTO ---
            const isAnyClientActive = activeClient !== 'N/A';
            receiptLockMessage.style.display = isAnyClientActive ? 'block' : 'none';
            
            // Variável para determinar se a seleção em lote deve ser desativada
            let shouldDisableSelectAll = false; 
            // --- FIM DA NOVA LÓGICA ---
            
            if(dataToReceive.length===0){receiptBody.innerHTML=`<tr><td colspan="8" style="text-align: center;">Nenhuma bateria aguardando recebimento.</td></tr>`}else{receiptBody.innerHTML=dataToReceive.map(b=>{const warrantyStatus=b.warranty_period_status==='warranty'?'<span class="status-badge status-warranty">Em Garantia</span>':'<span class="status-badge status-expired">Fora do Prazo</span>';
            // --- ATUALIZAÇÃO DA CONDIÇÃO DE BLOQUEIO POR CLIENTE ATIVO ---
            const isClientLocked=(isAnyClientActive&&b.client===activeClient);
            const disabledAttribute=isClientLocked?'disabled':'';
            const lockIcon=isClientLocked?'<i class="fas fa-lock"></i>':'';

            if (isClientLocked) {
                shouldDisableSelectAll = true;
            }
            // --- FIM DA ATUALIZAÇÃO ---

            return`<tr><td><input type="checkbox" class="receipt-checkbox" data-id="${b.id}" ${disabledAttribute}></td><td>${b.code}</td><td>${b.batteryModel}</td><td>${b.client}</td><td>${b.salesman}</td><td>${new Date(b.submissionDate).toLocaleDateString('pt-BR')}</td><td>${warrantyStatus}</td><td class="actions-cell">${lockIcon}<button class="confirm-receipt-btn btn btn-success" data-id="${b.id}" style="padding: 8px 12px; width: auto; margin: 0;" ${disabledAttribute}><i class="fas fa-check"></i> Receber</button></td></tr>`}).join('')}if(selectedClient&&dataToReceive.length>0&&!activeClient.includes(selectedClient)){showReceiptSummary(selectedClient,dataToReceive)}
            
            // Bloqueia o checkbox mestre se houver qualquer item bloqueado por cliente ativo.
            selectAllReceiptCheckbox.disabled = shouldDisableSelectAll; 

            // CORREÇÃO: Adicionar listener SÓ SE o botão NÃO estiver desativado
            receiptBody.querySelectorAll('.confirm-receipt-btn').forEach(btn=>{
                if (!btn.disabled) { // Verifica se o botão não foi desabilitado pelo bloqueio
                    btn.addEventListener('click',function(){
                        openReceiptConfirmModal([this.dataset.id])
                    });
                }
            });
            
            receiptBody.querySelectorAll('.receipt-checkbox').forEach(cb=>cb.addEventListener('change',updateBatchReceiptButtonState));
            selectAllReceiptCheckbox.checked=false;
            updateBatchReceiptButtonState();
            applyUIRestrictions();
        }
        async function confirmReceipt(ids){if(!Array.isArray(ids)||ids.length===0)return;const operationCode=receiptOperationCode.value.trim().toUpperCase();if(!operationCode){return showNotification('O Código da Operação é obrigatório.','error')}showNotification(`A confirmar recebimento de ${ids.length} bateria(s)...`,'info');try{const batch=writeBatch(db);const receiptTimestamp=new Date().toISOString();const receiptUser=sessionStorage.getItem('currentUser')||'Aline Burque';ids.forEach(id=>{const battery=batteryData.find(b=>b.id===id);if(battery){const docRef=doc(db,"batteries",id);let updateData;if(battery.warranty_period_status==='expired'){updateData={status:'finalized',receivedBy:receiptUser,receiptDate:receiptTimestamp,operationCode:operationCode,technicalOpinionDate:receiptTimestamp,finalAction:'REPROVADA - FORA DO PRAZO',recommendation:'Finalizada automaticamente no recebimento: Bateria fora do prazo de garantia.',analyzedBy:receiptUser}}else{updateData={status:'in_analysis',receivedBy:receiptUser,receiptDate:receiptTimestamp,operationCode:operationCode}}batch.update(docRef,updateData)}});await batch.commit();receiptConfirmModal.classList.remove('active');showNotification('Recebimento confirmado com sucesso!','success');addActivity('fas fa-dolly',`${ids.length} bateria(s) recebida(s) por ${receiptUser}.`)}catch(error){console.error("Erro ao confirmar recebimento:",error);showNotification("Erro ao confirmar recebimento.","error")}}
        async function returnToAnalysis(id){const battery=batteryData.find(b=>b.id===id);if(!battery)return;showNotification(`A retornar a bateria ${battery.code} para análise...`,'info');try{const docRef=doc(db,"batteries",id);await updateDoc(docRef,{status:'in_analysis',recommendation:'',finalAction:'',technicalOpinionDate:null,analyzedBy:null, lastEditedBy: null, lastEditedDate: null});showNotification('Bateria retornada para a fila de análise!','success');addActivity('fas fa-undo',`Bateria ${battery.code} retornada para análise por Jenilton.`)}catch(error){console.error("Erro ao retornar para análise:",error);showNotification("Erro ao reverter o status.","error")}}
        async function revertToReceipt(id){const battery=batteryData.find(b=>b.id===id);if(!battery)return;showNotification(`A retroceder a bateria ${battery.code} para recebimento...`,'info');try{const docRef=doc(db,"batteries",id);await updateDoc(docRef,{status:'awaiting_receipt',operationCode:'',receivedBy:null,receiptDate:null});showNotification('Bateria retrocedida para a fila de recebimento!','success');addActivity('fas fa-step-backward',`Bateria ${battery.code} retrocedida para recebimento por Jenilton.`)}catch(error){console.error("Erro ao retroceder para recebimento:",error);showNotification("Erro ao reverter o status.","error")}}
        
        async function saveAnalysis() {
            const user = sessionStorage.getItem('currentUser') || 'Reginaldo';
            const newRecommendation = analysisRecommendation.value.trim();
            const newFinalAction = analysisFinalAction.value;

            if (!newFinalAction) {
                return showNotification('Selecione uma Ação Final.', 'error');
            }
            if (newFinalAction === 'IMPROCEDENTE (MAU USO / SUCATEAR)' && !newRecommendation) {
                return showNotification('Para "Mau Uso", o Parecer Técnico é obrigatório.', 'error');
            }
            if (!newRecommendation) {
                return showNotification('O Parecer Técnico é obrigatório.', 'error');
            }

            const idsToUpdate = analysisMode === 'single' ? [analyzingBatteryId] : batchAnalysisIds;
            const updatedData = {
                status: 'finalized',
                recommendation: newRecommendation,
                finalAction: newFinalAction,
                technicalOpinionDate: new Date().toISOString(),
                analyzedBy: user
            };

            const batteriesToNotify = batteryData.filter(b => idsToUpdate.includes(b.id));

            try {
                const batch = writeBatch(db);
                idsToUpdate.forEach(id => {
                    const docRef = doc(db, "batteries", id);
                    batch.update(docRef, updatedData);
                });
                await batch.commit();
                analysisModal.classList.remove('active');
                showNotification(`${idsToUpdate.length} análise(s) salva(s)!`, 'success');
                addActivity('fas fa-clipboard-check', `${idsToUpdate.length} bateria(s) analisada(s) por ${user}.`);
            } catch (error) {
                console.error("Erro ao salvar análise na nuvem:", error);
                showNotification("Erro ao salvar análise.", "error");
            }
        }

        async function saveEditedClientData(){const originalBattery=batteryData.find(b=>b.id===editingBatteryId);if(!originalBattery)return;const newClientName=editClientNameInput.value.trim().toUpperCase();const newSalesmanName=editSalesmanNameInput.value.trim().toUpperCase();const newClientPhone=editClientPhoneInput.value.trim();if(!newClientName||!newSalesmanName)return showNotification('Os nomes não podem estar em branco.','error');const{client:oldClientName,salesman:oldSalesmanName}=originalBattery;try{const batch=writeBatch(db);const clientQuery=query(batteriesCollection,where("client","==",oldClientName));const clientSnapshot=await getDocs(clientQuery);clientSnapshot.forEach((document)=>{batch.update(document.ref,{client:newClientName,clientPhone:newClientPhone})});const salesmanQuery=query(batteriesCollection,where("salesman","==",oldSalesmanName));const salesmanSnapshot=await getDocs(salesmanQuery);salesmanSnapshot.forEach((document)=>{batch.update(document.ref,{salesman:newSalesmanName})});await batch.commit();clientEditModal.classList.remove('active');showNotification('Dados atualizados em todos os registos!','success')}catch(error){console.error("Erro ao editar dados em lote:",error);showNotification("Erro ao atualizar dados.","error")}}
        function openClientEditModal(id){const battery=batteryData.find(b=>b.id===id);if(!battery)return;editingBatteryId=id;editClientNameInput.value=battery.client;editSalesmanNameInput.value=battery.salesman;const allClientEntries=batteryData.filter(b=>b.client===battery.client&&b.clientPhone);const latestEntry=allClientEntries.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp))[0];editClientPhoneInput.value=latestEntry?latestEntry.clientPhone:'';clientEditModal.classList.add('active')}
        function openObservationModal(currentObservation,callback){observationText.value=currentObservation||'';observationCallback=callback;observationModal.classList.add('active')}
        function openReceiptConfirmModal(ids){if(!ids||ids.length===0)return;receiptIdsToConfirm=ids;receiptOperationCode.value='';receiptBatteryInfo.style.display='none';if(ids.length===1){const battery=batteryData.find(b=>b.id===ids[0]);receiptConfirmTitle.textContent=`Confirmar Recebimento`;receiptBatteryInfo.innerHTML=`<p><strong>Cód. Bateria:</strong> ${battery.code}</p><p><strong>Cliente:</strong> ${battery.client}</p>`;receiptBatteryInfo.style.display='block'}else{receiptConfirmTitle.textContent=`Confirmar Recebimento de ${ids.length} Baterias`}receiptConfirmModal.classList.add('active')}
        function openSingleAnalysisModal(id){const battery=batteryData.find(b=>b.id===id);if(!battery)return;analysisMode='single';analyzingBatteryId=id;analysisModalTitle.textContent=`Analisar Bateria: ${battery.code}`;analysisSingleInfo.style.display='block';analysisClientName.textContent=battery.client;analysisSalesmanName.textContent=battery.salesman;analysisBatteryModel.textContent=battery.batteryModel;analysisWarrantyStatus.innerHTML=battery.warranty_period_status==='warranty'?'<span class="status-badge status-warranty">Em Garantia</span>':'<span class="status-badge status-expired">Fora do Prazo</span>';analysisApprovedRadio.checked=false;analysisRejectedRadio.checked=false;analysisApprovedRadioContainer.classList.remove('selected');analysisRejectedRadioContainer.classList.remove('selected');analysisFinalAction.innerHTML='<option value="">-- Selecione o diagnóstico primeiro --</option>';analysisFinalAction.disabled=true;analysisRecommendation.value=battery.recommendation||'';analysisRecommendation.readOnly = false; analysisModal.classList.add('active')}
        function openBatchAnalysisModal(){const selectedCheckboxes=document.querySelectorAll('.analysis-checkbox:checked');if(selectedCheckboxes.length===0)return showNotification('Nenhuma bateria selecionada.','error');batchAnalysisIds=Array.from(selectedCheckboxes).map(cb=>cb.dataset.id);analysisMode='batch';analysisModalTitle.textContent=`Analisar ${batchAnalysisIds.length} Baterias em Lote`;analysisSingleInfo.style.display='none';analysisApprovedRadio.checked=false;analysisRejectedRadio.checked=false;analysisApprovedRadioContainer.classList.remove('selected');analysisRejectedRadioContainer.classList.remove('selected');analysisFinalAction.innerHTML='<option value="">-- Selecione o diagnóstico primeiro --</option>';analysisFinalAction.disabled=true;analysisRecommendation.value='';analysisRecommendation.readOnly = false; analysisModal.classList.add('active')}
        
        function handleSelectAllFinalizado() {
            document.querySelectorAll('.finalizado-checkbox').forEach(cb => {
                if (!cb.disabled) {
                    cb.checked = selectAllFinalizadoCheckbox.checked;
                }
            });
            updateBatchEditFinalizadoButtonState();
        }


        function updateBatchEditFinalizadoButtonState() {
            const selectedCount = document.querySelectorAll('.finalizado-checkbox:checked').length;
            batchEditFinalizadoBtn.disabled = selectedCount === 0;
            batchEditFinalizadoBtn.innerHTML = selectedCount > 0 ? `<i class="fas fa-edit"></i> Alterar ${selectedCount} Selecionadas` : '<i class="fas fa-edit"></i> Alterar Selecionadas';
        }

        function openBatchEditFinalizadoModal() {
            const selectedCheckboxes = document.querySelectorAll('.finalizado-checkbox:checked');
            if (selectedCheckboxes.length === 0) return showNotification('Nenhuma garantia selecionada.', 'error');
            batchEditFinalizadoIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.id);
            document.getElementById('batchEditFinalizadoModalTitle').textContent = `Alterar ${batchEditFinalizadoIds.length} Análises em Lote`;
            
            // Reset modal fields
            batchEditApprovedRadio.checked = false;
            batchEditRejectedRadio.checked = false;
            batchEditApprovedRadioContainer.classList.remove('selected');
            batchEditRejectedRadioContainer.classList.remove('selected');
            batchEditFinalAction.innerHTML = '<option value="">-- Selecione o diagnóstico primeiro --</option>';
            batchEditFinalAction.disabled = true;
            batchEditRecommendation.value = '';
            batchEditRecommendation.readOnly = false;

            batchEditFinalizadoModal.classList.add('active');
        }

        function autoFillBatchEditRecommendation() {
            const selectedAction = batchEditFinalAction.value;
             switch (selectedAction) {
                case "IMPROCEDENTE (CORTESIA)":
                    batchEditRecommendation.value = "Bateria sem defeito aparente. Troca enviada como cortesia.";
                    batchEditRecommendation.readOnly = true;
                    break;
                case "IMPROCEDENTE (DEVOLVER)":
                    batchEditRecommendation.value = "Bateria sem defeito, apenas descarregada. Devolver ao cliente para recarga.";
                    batchEditRecommendation.readOnly = true;
                    break;
                case "IMPROCEDENTE (MAU USO / SUCATEAR)":
                    batchEditRecommendation.value = "";
                    batchEditRecommendation.placeholder = "Descreva o motivo do mau uso (obrigatório).";
                    batchEditRecommendation.readOnly = false;
                    batchEditRecommendation.focus();
                    break;
                case "PROCEDENTE (ENVIAR NOVA)":
                    batchEditRecommendation.value = "Defeito de fabricação confirmado. Enviar nova unidade.";
                    batchEditRecommendation.readOnly = true;
                    break;
                default:
                    batchEditRecommendation.value = "";
                    batchEditRecommendation.readOnly = false;
            }
        }

        function handleBatchEditDiagnosisChange(diagnosis) {
            batchEditApprovedRadio.checked = diagnosis === 'approved';
            batchEditRejectedRadio.checked = diagnosis === 'rejected';
            batchEditApprovedRadioContainer.classList.toggle('selected', diagnosis === 'approved');
            batchEditRejectedRadioContainer.classList.toggle('selected', diagnosis === 'rejected');
            batchEditFinalAction.disabled = false;
            let options = '';

            if (diagnosis === 'approved') {
                options = `<option value="PROCEDENTE (ENVIAR NOVA)">PROCEDENTE (ENVIAR NOVA)</option>`;
            } else if (diagnosis === 'rejected') {
                options = `
                    <option value="">-- Selecione a Ação --</option>
                    <option value="IMPROCEDENTE (CORTESIA)">IMPROCEDENTE (CORTESIA)</option>
                    <option value="IMPROCEDENTE (DEVOLVER)">IMPROCEDENTE (DEVOLVER)</option>
                    <option value="IMPROCEDENTE (MAU USO / SUCATEAR)">IMPROCEDENTE (MAU USO / SUCATEAR)</option>
                `;
            } else {
                options = '<option value="">-- Selecione o diagnóstico primeiro --</option>';
                batchEditFinalAction.disabled = true;
            }
            batchEditFinalAction.innerHTML = options;
            autoFillBatchEditRecommendation(); // Chama para preencher o parecer
        }

        async function saveBatchEditedFinalizado() {
            const user = sessionStorage.getItem('currentUser') || 'Jenilton';
            const newRecommendation = batchEditRecommendation.value.trim();
            const newFinalAction = batchEditFinalAction.value;

            if (!newFinalAction) {
                return showNotification('Selecione uma Nova Ação Final.', 'error');
            }
            if (newFinalAction === 'IMPROCEDENTE (MAU USO / SUCATEAR)' && !newRecommendation) {
                return showNotification('Para "Mau Uso", o Novo Parecer Técnico é obrigatório.', 'error');
            }
            if (!newRecommendation) {
                return showNotification('O Novo Parecer Técnico é obrigatório.', 'error');
            }

            const updatedData = {
                recommendation: newRecommendation,
                finalAction: newFinalAction,
                lastEditedBy: user,
                lastEditedDate: new Date().toISOString()
            };

            showNotification(`A atualizar ${batchEditFinalizadoIds.length} análises...`, 'info');

            try {
                const batch = writeBatch(db);
                batchEditFinalizadoIds.forEach(id => {
                    const docRef = doc(db, "batteries", id);
                    batch.update(docRef, updatedData);
                });
                await batch.commit();
                batchEditFinalizadoModal.classList.remove('active');
                showNotification(`${batchEditFinalizadoIds.length} análises alteradas com sucesso!`, 'success');
                addActivity('fas fa-edit', `${batchEditFinalizadoIds.length} análises finalizadas foram corrigidas em lote por ${user}.`);
            } catch (error) {
                console.error("Erro ao salvar alterações em lote:", error);
                showNotification("Erro ao salvar alterações.", "error");
            }
        }
        
        function updateAnalysisTable(){const selectedClient=analysisClientFilter.value;const selectedSalesman=analysisSalesmanFilter.value;const searchTerm=analysisSearchInput.value.trim().toLowerCase();let dataToAnalyze=batteryData.filter(b=>b.status==='in_analysis');if(selectedClient){dataToAnalyze=dataToAnalyze.filter(b=>b.client===selectedClient)}if(selectedSalesman){dataToAnalyze=dataToAnalyze.filter(b=>b.salesman===selectedSalesman)}if(searchTerm){dataToAnalyze=dataToAnalyze.filter(b=>(b.operationCode&&b.operationCode.toLowerCase().includes(searchTerm))||b.code.toLowerCase().includes(searchTerm)||b.batteryModel.toLowerCase().includes(searchTerm))}dataToAnalyze.sort((a,b)=>new Date(a.receiptDate)-new Date(b.receiptDate));selectAllAnalysisCheckbox.checked=false;if(dataToAnalyze.length===0){analysisBody.innerHTML=`<tr><td colspan="8" style="text-align: center;">Nenhuma bateria na fila para análise técnica.</td></tr>`}else{analysisBody.innerHTML=dataToAnalyze.map(renderAnalysisTableRow).join('')}analysisBody.querySelectorAll('.analyze-btn').forEach(btn=>btn.addEventListener('click',function(){openSingleAnalysisModal(this.dataset.id)}));analysisBody.querySelectorAll('.revert-to-receipt-btn').forEach(btn=>btn.addEventListener('click',function(){showConfirmModal('Retroceder para Recebimento?','Esta bateria voltará para a fila da Aline. Os dados de recebimento serão apagados.',()=>revertToReceipt(this.dataset.id))}));analysisBody.querySelectorAll('.analysis-checkbox').forEach(box=>box.addEventListener('change',updateBatchAnalyzeButtonState));updateBatchAnalyzeButtonState();applyUIRestrictions()}
        function updateFinalizadoTable(){const searchTerm=finalizadoSearchInput.value.trim().toLowerCase();const startDate=finalizadoStartDate.value;const endDate=finalizadoEndDate.value;const selectedSalesman=finalizadoSalesmanFilter.value;const selectedAction=finalizadoActionFilter.value;let dataFinalizada=batteryData.filter(b=>b.status==='finalized');if(searchTerm){dataFinalizada=dataFinalizada.filter(b=>(b.operationCode&&b.operationCode.toLowerCase().includes(searchTerm))||b.code.toLowerCase().includes(searchTerm)||b.client.toLowerCase().includes(searchTerm)||(b.recommendation&&b.recommendation.toLowerCase().includes(searchTerm)))}if(startDate||endDate){const start=startDate?new Date(startDate+'T00:00:00'):new Date('1970-01-01');const end=endDate?new Date(endDate+'T23:59:59'):new Date();dataFinalizada=dataFinalizada.filter(b=>{const analysisDate=b.technicalOpinionDate?new Date(b.technicalOpinionDate):null;return analysisDate&&analysisDate>=start&&analysisDate<=end})}if(selectedSalesman){dataFinalizada=dataFinalizada.filter(b=>b.salesman===selectedSalesman)}if(selectedAction){dataFinalizada=dataFinalizada.filter(b=>b.finalAction===selectedAction)}dataFinalizada.sort((a,b)=>new Date(b.technicalOpinionDate)-new Date(b.technicalOpinionDate));if(dataFinalizada.length===0){finalizadoBody.innerHTML=`<tr><td colspan="8" style="text-align: center;">Nenhuma garantia finalizada encontrada com estes filtros.</td></tr>`}else{finalizadoBody.innerHTML=dataFinalizada.map(renderFinalizadoTableRow).join('')}
        finalizadoBody.querySelectorAll('.finalizado-checkbox').forEach(box => box.addEventListener('change', updateBatchEditFinalizadoButtonState));
        finalizadoBody.querySelectorAll('.return-to-analysis-btn').forEach(btn=>btn.addEventListener('click',function(){showConfirmModal('Retornar para Análise?','Esta bateria voltará para a fila de análise do Reginaldo. O parecer anterior será apagado.',()=>returnToAnalysis(this.dataset.id))}));finalizadoBody.querySelectorAll('.name-edit-btn').forEach(btn=>btn.addEventListener('click',function(){openClientEditModal(this.dataset.id)}));finalizadoBody.querySelectorAll('.remove-btn').forEach(btn=>btn.addEventListener('click',function(){showConfirmModal('Remover Bateria da Nuvem','Tem a certeza que deseja remover esta bateria? A ação é irreversível.',()=>removeBattery(this.dataset.id))}));updateBatchEditFinalizadoButtonState();applyUIRestrictions()}
        function renderAnalysisTableRow(battery){const warrantyStatus=battery.warranty_period_status==='warranty'?'<span class="status-badge status-warranty">Em Garantia</span>':'<span class="status-badge status-expired">Fora do Prazo</span>';return`<tr><td><input type="checkbox" class="analysis-checkbox" data-id="${battery.id}"></td><td>${battery.operationCode||'-'}</td><td>${battery.code}</td><td>${battery.client}</td><td>${battery.batteryModel}</td><td>${new Date(battery.submissionDate).toLocaleDateString('pt-BR')}</td><td>${warrantyStatus}</td><td class="actions-cell" style="display: flex; gap: 8px;"><button class="revert-to-receipt-btn jenilton-only btn btn-warning" data-id="${battery.id}" title="Retroceder para Recebimento" style="padding: 5px 10px; width: auto; margin: 0;"><i class="fas fa-step-backward"></i></button><button class="analyze-btn btn btn-primary" data-id="${battery.id}" style="padding: 8px 12px; width: auto; margin: 0;"><i class="fas fa-edit"></i> Analisar</button></td></tr>`}
        function renderFinalizadoTableRow(battery){let actionClass='';if(battery.finalAction.includes('PROCEDENTE'))actionClass='action-approved';else if(battery.finalAction.includes('CORTESIA'))actionClass='action-courtesy';else if(battery.finalAction.includes('DEVOLVER'))actionClass='action-rejected';else if(battery.finalAction.includes('MAU USO')||battery.finalAction.includes('PRAZO'))actionClass='action-scrapped';const finalActionBadge=battery.finalAction?`<span class="status-badge ${actionClass}">${battery.finalAction}</span>`:'-';return`<tr><td class="jenilton-only"><input type="checkbox" class="finalizado-checkbox" data-id="${battery.id}"></td><td>${battery.operationCode||'-'}</td><td>${battery.code}</td><td>${battery.client}</td><td>${battery.technicalOpinionDate?new Date(battery.technicalOpinionDate).toLocaleDateString('pt-BR'):'-'}</td><td>${finalActionBadge}</td><td style="white-space: normal; max-width: 200px;">${battery.recommendation}</td><td class="actions-cell"><button class="return-to-analysis-btn jenilton-only btn btn-warning" data-id="${battery.id}" title="Retornar para Análise" style="padding: 5px 10px; width: auto; margin: 0;"><i class="fas fa-undo"></i></button><button class="name-edit-btn btn btn-info" data-id="${battery.id}" title="Editar Nomes" style="padding: 5px 10px; width: auto; margin: 0;"><i class="fas fa-pencil-alt"></i></button><button class="remove-btn btn btn-danger" data-id="${battery.id}" title="Remover" style="padding: 5px 10px; width: auto; margin: 0;"><i class="fas fa-trash-alt"></i></button></td></tr>`}
        function updateDispatchPage(){const searchTerm=dispatchSearchInput.value.trim().toLowerCase();const pendingDispatch=batteryData.filter(b=>b.status==='finalized'&&(b.finalAction.includes('PROCEDENTE')||b.finalAction.includes('CORTESIA'))&&!b.dispatchOrderId);let groupedByClient=pendingDispatch.reduce((acc,battery)=>{const key=`${battery.client}|${battery.salesman}`;if(!acc[key]){acc[key]=[]}acc[key].push(battery);return acc},{});if(searchTerm){groupedByClient=Object.fromEntries(Object.entries(groupedByClient).filter(([key])=>key.toLowerCase().includes(searchTerm)))}dispatchClientList.innerHTML='';if(Object.keys(groupedByClient).length===0){dispatchClientList.innerHTML='<div class="info-section"><p>Nenhuma expedição pendente encontrada.</p></div>';return}for(const key in groupedByClient){const[client,salesman]=key.split('|');const batteries=groupedByClient[key];const clientCard=document.createElement('div');clientCard.className='card';const tableRows=batteries.map(b=>`<tr><td>${b.code}</td><td>${b.batteryModel}</td><td><span class="status-badge ${b.finalAction.includes('PROCEDENTE')?'action-approved':'action-courtesy'}">${b.finalAction}</span></td><td>${b.operationCode||'-'}</td></tr>`).join('');clientCard.innerHTML=`<div class="card-header" style="align-items: flex-start;"><div><h3 class="card-title" style="margin-bottom: 5px;">Cliente: ${client}</h3><p style="font-size: 14px; color: var(--fabreck-gray);">Vendedor: ${salesman}</p></div><div style="display:flex; gap:10px;"><button class="btn btn-info summary-dispatch-btn" data-key="${key}" style="margin-top:0; white-space: nowrap; width: auto;"><i class="fas fa-file-alt"></i> Resumo</button><button class="btn btn-primary generate-dispatch-order-btn" data-key="${key}" style="margin-top: 0; white-space: nowrap; width: auto;"><i class="fas fa-print"></i> Gerar Pedido (${batteries.length})</button></div></div><div class="table-container" style="margin-top: 10px;"><table style="font-size: 12px;"><thead><tr><th>Código Bateria</th><th>Modelo</th><th>Ação</th><th>Cód. Operação</th></tr></thead><tbody>${tableRows}</tbody></table></div>`;dispatchClientList.appendChild(clientCard)}document.querySelectorAll('.summary-dispatch-btn').forEach(btn=>{btn.addEventListener('click',function(){const key=this.dataset.key;const batteries=groupedByClient[key];showDispatchSummary(key.split('|')[0],batteries)})});document.querySelectorAll('.generate-dispatch-order-btn').forEach(btn=>{btn.addEventListener('click',function(){const key=this.dataset.key;const batteries=groupedByClient[key];openDispatchConfirmModal(batteries)})})}
        function showDispatchSummary(clientName,clientBatteries){if(!clientBatteries||clientBatteries.length===0)return;currentDispatchSummaryData={clientName,clientBatteries};const modelSummary=clientBatteries.reduce((acc,battery)=>{const model=battery.batteryModel||'N/A';acc[model]=(acc[model]||0)+1;return acc},{});dispatchSummaryTitle.textContent=`Resumo para Expedição: ${clientName}`;let summaryHtml='<ul>';for(const[model,count]of Object.entries(modelSummary).sort((a,b)=>a[0].localeCompare(b[0]))){summaryHtml+=`<li style="margin-bottom: 5px;"><strong>${model}:</strong> ${count} unidade(s)</li>`}summaryHtml+='</ul>';dispatchSummaryBody.innerHTML=summaryHtml;dispatchSummaryModal.classList.add('active')}
        function generateDispatchSummaryPDF(){if(!currentDispatchSummaryData){showNotification('Nenhum dado de resumo para gerar PDF.','error');return}const{clientName,clientBatteries}=currentDispatchSummaryData;const doc=new window.jspdf.jsPDF();const today=new Date().toLocaleDateString('pt-BR');const salesmanName=clientBatteries[0]?.salesman||'N/A';doc.setFontSize(18).setFont(undefined,'bold').text('Relatório de Resumo de Expedição',105,20,{align:'center'});doc.setFontSize(12).setFont(undefined,'normal');doc.text(`Cliente: ${clientName}`,15,35);doc.text(`Vendedor: ${salesmanName}`,15,42);doc.text(`Data de Emissão: ${today}`,195,35,{align:'right'});doc.setLineWidth(.5).line(15,47,195,47);const modelSummary=clientBatteries.reduce((acc,battery)=>{const model=battery.batteryModel||'N/A';acc[model]=(acc[model]||0)+1;return acc},{});let startY=55;doc.setFontSize(14).setFont(undefined,'bold').text('Resumo por Modelo',15,startY);startY+=8;doc.setFontSize(10).setFont(undefined,'normal');for(const[model,count]of Object.entries(modelSummary).sort((a,b)=>a[0].localeCompare(b[0]))){doc.text(`- ${model}:`,20,startY);doc.text(`${count} unidade(s)`,80,startY);startY+=7}startY+=5;doc.setFontSize(14).setFont(undefined,'bold').text('Lista Detalhada de Baterias',15,startY);const tableBody=clientBatteries.map(b=>[b.code,b.batteryModel,getUserFullName(b.createdBy),getUserFullName(b.analyzedBy),b.finalAction]);doc.autoTable({startY:startY+5,head:[['Cód. Bateria','Modelo','Registado por','Analisado por','Ação Final']],body:tableBody,theme:'striped',headStyles:{fillColor:[0,71,171]}});let finalY=doc.lastAutoTable.finalY+20;doc.setFontSize(10);doc.text('Conferido por: Jenilton Cruz',15,finalY);const pageCount=doc.internal.getNumberOfPages();const pageWidth=doc.internal.pageSize.getWidth();for(let i=1;i<=pageCount;i++){doc.setPage(i);const pageHeight=doc.internal.pageSize.getHeight();doc.setDrawColor(224,224,224);doc.line(15,pageHeight-15,pageWidth-15,pageHeight-15);doc.setFontSize(8).setTextColor(128,128,128);doc.text('Fabreck do Brasil © 2025 | PCP: Jenilton Cruz',15,pageHeight-10);doc.text(`Emitido em: ${today}`,pageWidth/2,pageHeight-10,{align:'center'});doc.text(`Página ${i} de ${pageCount}`,pageWidth-15,pageHeight-10,{align:'right'})}doc.output('dataurlnewwindow');dispatchSummaryModal.classList.remove('active')}
        function openDispatchConfirmModal(batteries){if(!batteries||batteries.length===0)return;dispatchBatteriesToConfirm=batteries;const orderId=`PED-${Date.now()}`;generateDispatchPDF(orderId,batteries);dispatchConfirmModal.classList.add('active');document.getElementById('dispatchConfirmTitle').textContent=`Finalizar Expedição para ${batteries[0].client}`;dispatchOSCode.value='';dispatchOSCode.focus()}
        async function confirmDispatch(batteries){if(!batteries||batteries.length===0)return showNotification('Nenhuma bateria para finalizar.','error');const osCode=dispatchOSCode.value.trim().toUpperCase();if(!osCode)return showNotification('A Ordem de Serviço (O.S.) é obrigatória para finalizar a expedição.','error');showNotification(`A finalizar expedição com O.S. ${osCode}...`,'info');try{const batch=writeBatch(db);const dispatchTimestamp=new Date().toISOString();const user=sessionStorage.getItem('currentUser')||'Jenilton';batteries.forEach(battery=>{const docRef=doc(db,"batteries",battery.id);batch.update(docRef,{dispatchOrderId:osCode,dispatchDate:dispatchTimestamp,dispatchedBy:user})});await batch.commit();dispatchConfirmModal.classList.remove('active');showNotification(`Expedição finalizada! O.S. ${osCode} aplicada a ${batteries.length} itens.`,'success');addActivity('fas fa-truck',`Expedição O.S. ${osCode} com ${batteries.length} itens finalizada por ${user}.`)}catch(error){console.error("Erro ao finalizar expedição:",error);showNotification("Erro ao finalizar expedição.","error")}}
        function generateDispatchPDF(orderId,batteries){const doc=new window.jspdf.jsPDF('l','pt');const today=new Date().toLocaleDateString('pt-BR');const clientName=batteries[0].client;const salesmanName=batteries[0].salesman;doc.setFontSize(20).setFont(undefined,'bold').text('PEDIDO DE EXPEDIÇÃO - GARANTIA',doc.internal.pageSize.getWidth()/2,40,{align:'center'});doc.setFontSize(14).setFont(undefined,'normal').text(`Pedido Nº: ${orderId}`,doc.internal.pageSize.getWidth()/2,58,{align:'center'});let startY=85;doc.setFontSize(12);doc.text(`Cliente:`,40,startY);doc.setFont(undefined,'bold').text(clientName,90,startY);doc.setFont(undefined,'normal').text(`Vendedor:`,40,startY+20);doc.setFont(undefined,'bold').text(salesmanName,100,startY+20);doc.text(`Data de Emissão:`,doc.internal.pageSize.getWidth()-40,startY,{align:'right',baseline:'middle',x:doc.internal.pageSize.getWidth()-120,y:startY});doc.setFont(undefined,'bold').text(today,doc.internal.pageSize.getWidth()-40,startY,{align:'right'});startY+=45;const modelSummary=batteries.reduce((acc,battery)=>{const model=battery.batteryModel||'N/A';acc[model]=(acc[model]||0)+1;return acc},{});startY+=10;doc.setFontSize(14).setFont(undefined,'bold').text('Resumo por Modelo',40,startY);startY+=8;const summaryBody=Object.entries(modelSummary).map(([model,count])=>[model,count]);doc.autoTable({startY:startY,head:[['Modelo','Quantidade']],body:summaryBody,theme:'grid',headStyles:{fillColor:[0,71,171]},columnStyles:{1:{halign:'center'}},tableWidth:300});startY=doc.lastAutoTable.finalY+20;const tableBody=batteries.map(b=>[b.code,b.batteryModel,b.timestamp?new Date(b.timestamp).toLocaleDateString('pt-BR'):'-',getUserFullName(b.createdBy),b.receiptDate?new Date(b.receiptDate).toLocaleDateString('pt-BR'):'-',getUserFullName(b.receivedBy),b.technicalOpinionDate?new Date(b.technicalOpinionDate).toLocaleDateString('pt-BR'):'-',getUserFullName(b.analyzedBy),b.finalAction,b.recommendation||'-']);doc.autoTable({startY:startY,head:[['Cód. Bateria','Modelo','Data Reg.','Registado por','Data Rec.','Recebido por','Data Análise','Analisado por','Ação Final','Parecer Técnico']],body:tableBody,theme:'grid',styles:{fontSize:8},headStyles:{fillColor:[30,30,30]},columnStyles:{9:{cellWidth:'auto'}}});let finalY=doc.lastAutoTable.finalY+40;if(finalY>doc.internal.pageSize.getHeight()-100){doc.addPage();finalY=80}doc.line(40,finalY,240,finalY);doc.text('Separado por',140,finalY+15,{align:'center'});doc.line(doc.internal.pageSize.getWidth()-240,finalY,doc.internal.pageSize.getWidth()-40,finalY);doc.text('Conferido por',doc.internal.pageSize.getWidth()-140,finalY+15,{align:'center'});drawPdfFooter(doc)}
        function saveNewPassword(e){e.preventDefault();const currentPassword=document.getElementById('currentPassword').value;const newPassword=document.getElementById('newPassword').value;const confirmNewPassword=document.getElementById('confirmNewPassword').value;const loggedInUser=sessionStorage.getItem('currentUser');if(!loggedInUser)return showNotification('Erro: Utilizador não identificado.','error');let adminUsers=JSON.parse(localStorage.getItem(ADMIN_USERS_KEY));const userToUpdate=adminUsers.find(admin=>admin.user===loggedInUser);if(!userToUpdate||currentPassword!==userToUpdate.pass)return showNotification('A palavra-passe atual está incorreta.','error');if(newPassword.length<3)return showNotification('A nova palavra-passe deve ter pelo menos 3 caracteres.','error');if(newPassword!==confirmNewPassword)return showNotification('As novas palavras-passe não coincidem.','error');userToUpdate.pass=newPassword;localStorage.setItem(ADMIN_USERS_KEY,JSON.stringify(adminUsers));showNotification('Palavra-passe alterada com sucesso!','success');passwordModal.classList.remove('active');passwordChangeForm.reset()}
        function handleClearDataConfirmation(e){e.preventDefault();const enteredPassword=adminPasswordConfirmInput.value;const loggedInUser=sessionStorage.getItem('currentUser');if(loggedInUser!=='JENILTON')return;const adminUsers=JSON.parse(localStorage.getItem(ADMIN_USERS_KEY));const userToUpdate=adminUsers.find(admin=>admin.user===loggedInUser);if(userToUpdate&&enteredPassword===userToUpdate.pass){showNotification('Senha correta. A limpar os dados...','warning');passwordConfirmModal.classList.remove('active');clearData()}else{showNotification('Palavra-passe incorreta. A limpeza foi cancelada.','error');adminPasswordConfirmInput.value=''}}
        function generateDetailedFilteredReport(){const data=getFilteredFinalizadasData();if(data.length===0)return showNotification('Nenhum dado no filtro para gerar o relatório.','error');let message=`*Relatório Detalhado de Garantias Finalizadas*\n`;message+=`*Data:* ${new Date().toLocaleDateString('pt-BR')}\n`;message+=`====================================\n\n`;const groupedBySalesman=data.reduce((acc,battery)=>{(acc[battery.salesman]=acc[battery.salesman]||[]).push(battery);return acc},{});for(const salesman in groupedBySalesman){message+=`*VENDEDOR:* ${salesman}\n`;message+=`------------------------------------\n`;const clientData=groupedBySalesman[salesman];const groupedByClient=clientData.reduce((acc,battery)=>{(acc[battery.client]=acc[battery.client]||[]).push(battery);return acc},{});for(const client in groupedByClient){message+=`  *CLIENTE:* ${client}\n`;const batteryData=groupedByClient[client];batteryData.forEach(b=>{message+=`    - ${b.batteryModel} (${b.code}): *${b.finalAction}*\n`});message+=`\n`}}openWhatsAppModal('custom',{message})}
        function generateTodaySummaryReport(){const today=new Date();today.setHours(0,0,0,0);const todaysEntries=batteryData.filter(b=>{const entryDate=new Date(b.timestamp);return entryDate>=today});if(todaysEntries.length===0){return showNotification('Nenhum registo de garantia feito hoje.','info')}let message=`*Resumo de Registos de Garantia - ${new Date().toLocaleDateString('pt-BR')}*\n\n`;const groupedBySalesman=todaysEntries.reduce((acc,battery)=>{(acc[battery.salesman]=acc[battery.salesman]||[]).push(battery);return acc},{});let totalToday=0;Object.keys(groupedBySalesman).sort().forEach(salesman=>{const entries=groupedBySalesman[salesman];const count=entries.length;totalToday+=count;message+=`*Vendedor: ${salesman}*\n`;message+=`Total de Baterias Registadas: ${count}\n\n`});message+=`*Total Geral do Dia: ${totalToday} baterias*\n\n`;message+=`_Relatório gerado pelo Sistema de Garantia Fabreck._`;openWhatsAppModal('custom',{message:message})}
        function generatePendingAnalysisReport(){const pendingData=batteryData.filter(b=>b.status==='awaiting_receipt'||b.status==='in_analysis');if(pendingData.length===0){return showNotification('Nenhuma bateria pendente.','info')}let message=`*Resumo de Baterias Pendentes*\n`;message+=`*Data:* ${new Date().toLocaleDateString('pt-BR')}\n\n`;const groupedByClient=pendingData.reduce((acc,battery)=>{(acc[battery.client]=acc[battery.client]||[]).push(battery);return acc},{});for(const client in groupedByClient){const batteries=groupedByClient[client];message+=`*CLIENTE: ${client}* (${batteries.length} unid.)\n`;batteries.forEach(b=>{const statusText=b.status==='awaiting_receipt'?'Aguardando recebimento':'Em análise';message+=` • ${b.batteryModel} (${b.code}) - ${statusText}\n`});message+='\n'}openWhatsAppModal('custom',{message})}
        function generateGeneralSummaryReport(){const finalizedData=batteryData.filter(b=>b.status==='finalized');if(finalizedData.length===0)return showNotification('Nenhuma garantia finalizada para gerar resumo.','info');let message=`*Resumo Geral de Garantias Finalizadas*\n`;message+=`*Data:* ${new Date().toLocaleDateString('pt-BR')}\n\n`;const groupedBySalesman=finalizedData.reduce((acc,battery)=>{(acc[battery.salesman]=acc[battery.salesman]||[]).push(battery);return acc},{});for(const salesman in groupedBySalesman){message+=`*VENDEDOR:* ${salesman}\n`;const clientData=groupedBySalesman[salesman];const summary=clientData.reduce((acc,b)=>{let category='Reprovadas';if(b.finalAction.includes('PROCEDENTE'))category='Aprovadas';else if(b.finalAction.includes('CORTESIA'))category='Cortesias';acc[category]=(acc[category]||0)+1;return acc},{Aprovadas:0,Cortesias:0,Reprovadas:0});message+=`  - Aprovadas: ${summary.Aprovadas}\n`;message+=`  - Cortesias: ${summary.Cortesias}\n`;message+=`  - Reprovadas: ${summary.Reprovadas}\n\n`}openWhatsAppModal('custom',{message})}
        function openWhatsAppModal(type,data=null){let message='';let targetPhone='';whatsappOptionsMenuModal.classList.remove('active');if(type==='custom'){message=data.message;if(data.phone)targetPhone=data.phone}if(!message){showNotification('Não foi possível gerar a mensagem.','error');return}whatsappMessagePreview.textContent=message;const encodedMessage=encodeURIComponent(message);whatsappUrl=targetPhone?`https://wa.me/${targetPhone.replace(/\D/g,'')}?text=${encodedMessage}`:`https://web.whatsapp.com/send?text=${encodedMessage}`;whatsappPreviewModal.classList.add('active')}

        init();
    });
</script></body></html>
