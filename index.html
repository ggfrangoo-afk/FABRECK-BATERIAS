<!DOCTYPE html><html lang="pt-BR"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>FABRECK DO BRASIL - App de Garantia (Nuvem com Login)</title><script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script><script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"><script type="module">import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getFirestore,collection,onSnapshot,addDoc,doc,deleteDoc,updateDoc,writeBatch,getDocs,query,where,setDoc,getDoc}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import{getAuth,signInAnonymously,onAuthStateChanged}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";window.firebase={initializeApp,getFirestore,collection,onSnapshot,addDoc,doc,deleteDoc,updateDoc,writeBatch,getDocs,query,where,setDoc,getDoc,getAuth,signInAnonymously,onAuthStateChanged};</script><style>:root{--fabreck-red:#D22630;--fabreck-blue:#0047AB;--fabreck-white:#FFFFFF;--fabreck-light:#F5F7FA;--fabreck-dark:#1A2A3A;--fabreck-gray:#7F8C8D;--fabreck-success:#2ECC71;--fabreck-warning:#F39C12;--fabreck-danger:#E74C3C;--dark-bg:#121212;--dark-card-bg:#1E1E1E;--dark-text:#FFFFFF;--dark-light-text:#BDBDBD;--dark-border:#333333;--dark-header-bg-start:#002244;--dark-header-bg-end:#000000;--dark-blue-light:#64B5F6}*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;-webkit-tap-highlight-color:transparent}html{scroll-behavior:smooth}html,body{height:100%;overflow:hidden}body.loaded{}.jenilton-only{display:none}.aline-only{display:none}.reginaldo-only{display:none}#loadingOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,var(--fabreck-dark),#000);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .5s ease-out;overflow:hidden}.loading-text{color:var(--fabreck-white);text-align:center;z-index:10;animation:pulse-logo 2.5s infinite ease-in-out}@keyframes pulse-logo{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}.loading-text p{font-size:16px;opacity:.8;letter-spacing:1px;margin-top:15px}.loading-text .logo-main{font-size:8vw;max-font-size:96px;-webkit-text-stroke:3px var(--fabreck-white);color:var(--fabreck-red)}.loading-text .logo-sub{font-size:3vw;max-font-size:32px;margin-top:-15px;color:var(--fabreck-white)}#lightning-container{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}.lightning{position:absolute;width:100px;height:150px;fill:rgba(0,100,224,.6);opacity:0;animation:flash 3.5s infinite ease-in-out;transform-origin:center}.bolt1{top:10%;left:15%;transform:rotate(-20deg);animation-delay:0s}.bolt2{top:20%;right:10%;transform:rotate(30deg) scale(.8);animation-delay:.7s}.bolt3{bottom:15%;left:25%;transform:rotate(-10deg) scale(1.2);animation-delay:1.5s}.bolt4{bottom:5%;right:20%;transform:rotate(15deg) scale(1.1);animation-delay:2.2s}.bolt5{top:50%;left:5%;transform:rotate(-30deg) scale(.7);animation-delay:2.8s}@keyframes flash{0%,100%{opacity:0;transform:scale(.8)}2%{opacity:.7;transform:scale(1.1)}4%{opacity:0}6%{opacity:.5;transform:scale(1)}8%,95%{opacity:0}}.login-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,var(--fabreck-blue),var(--fabreck-dark));display:flex;align-items:center;justify-content:center;z-index:3000;transition:opacity .3s ease}.login-overlay.hidden{opacity:0;pointer-events:none}.login-card{background:var(--fabreck-white);padding:30px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.2);width:90%;max-width:400px;text-align:center;transition:opacity .5s ease}#screensaverOverlay{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.9);opacity:0;pointer-events:none;transition:opacity .5s ease;z-index:3001;cursor:pointer}#screensaverOverlay .loading-text p{animation:pulse-text 2s infinite ease-in-out}@keyframes pulse-text{0%,100%{opacity:.6}50%{opacity:1}}body.dark-mode .login-card{background:var(--dark-card-bg)}.login-card .logo-img{width:180px;margin-bottom:20px}.login-card h2{color:var(--fabreck-blue);margin-bottom:20px}body.dark-mode .login-card h2{color:var(--dark-blue-light)}.login-card .logo-main{color:var(--fabreck-red);-webkit-text-stroke-color:var(--fabreck-blue)}.login-card .logo-sub{color:var(--fabreck-blue)}#layoutContainer{display:flex;width:100%;visibility:hidden}#sidebar{width:260px;background:var(--fabreck-dark);color:var(--fabreck-white);display:none;flex-direction:column;padding:20px;box-shadow:5px 0 15px rgba(0,0,0,.1);transition:background .3s ease;position:sticky;top:0;height:100vh}#mainContentWrapper{flex:1;position:relative;padding:10px;height:100vh;overflow-y:auto}.container{max-width:100%;margin:0 auto}.footer{position:fixed;bottom:0;left:0;right:0;background:var(--fabreck-white);display:flex;justify-content:space-around;padding:10px 5px;border-top:1px solid rgba(0,0,0,.08);z-index:100;box-shadow:0 -4px 12px rgba(0,0,0,.05);transition:background .3s ease,border-top .3s ease}.page{display:none;animation:fadeIn .3s ease-in-out}.page.active{display:block}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}@media (min-width:992px){#sidebar{display:flex}.footer{display:none}#mainContentWrapper{padding:20px}.container{width:100%;max-width:none;margin:0}}@media (max-width:991px){#mainContentWrapper{padding-bottom:90px}}body.dark-mode #sidebar{background:var(--dark-card-bg);border-right:1px solid var(--dark-border)}.sidebar-header{text-align:center;margin-bottom:30px}.sidebar-header .logo-img{width:150px;margin-bottom:10px}.sidebar-header h3{font-size:16px;opacity:.8}.sidebar-nav{flex-grow:1}.sidebar-btn{display:flex;align-items:center;padding:15px;color:var(--fabreck-white);opacity:.7;text-decoration:none;border-radius:12px;margin-bottom:8px;font-weight:500;transition:all .3s ease}body.dark-mode .sidebar-btn{color:var(--dark-text)}.sidebar-btn i{font-size:20px;width:30px;margin-right:15px}.sidebar-btn:hover{opacity:1;background:rgba(255,255,255,.1)}.sidebar-btn.active{opacity:1;background:var(--fabreck-blue);color:var(--fabreck-white);font-weight:600}body.dark-mode .sidebar-btn.active{background:var(--dark-blue-light)}.sidebar-footer{font-size:12px;text-align:center;opacity:.5;padding-top:20px;border-top:1px solid rgba(255,255,255,.1)}body.dark-mode .sidebar-footer{border-top-color:var(--dark-border)}body.dark-mode{background:var(--dark-bg);color:var(--dark-text)}body.dark-mode .status-badge{color:#FFF}body.dark-mode .status-warranty,body.dark-mode .action-approved{background:#27ae60;border:none}body.dark-mode .status-expired,body.dark-mode .action-rejected{background:#c0392b;border:none}body.dark-mode .status-factory,body.dark-mode .status-awaiting-receipt{background:#2980b9;border:none}body.dark-mode .status-in-analysis,body.dark-mode .action-courtesy{background:#f39c12;border:none}body.dark-mode .status-finalized,body.dark-mode .action-scrapped{background:#8e44ad;border:none}body.dark-mode .footer{background:var(--dark-card-bg);border-top:1px solid var(--dark-border);box-shadow:0 -4px 12px rgba(0,0,0,.3)}body.dark-mode .nav-btn{color:var(--dark-light-text)}body.dark-mode .nav-btn.active{color:var(--dark-blue-light);background:rgba(0,71,171,.2)}body.dark-mode .rules-modal .rules-content,body.dark-mode .edit-modal .edit-content,body.dark-mode #receiptConfirmModal .modal-content, body.dark-mode #batchEditFinalizadoModal .modal-content{background:var(--dark-card-bg);border:2px solid var(--dark-blue-light)}body.dark-mode .rules-title,body.dark-mode .edit-title,body.dark-mode #receiptConfirmModal .modal-title, body.dark-mode #batchEditFinalizadoModal .modal-title{color:var(--dark-blue-light)}body.dark-mode .rules-list li,body.dark-mode .edit-modal label,body.dark-mode #receiptConfirmModal label, body.dark-mode #batchEditFinalizadoModal label{color:var(--dark-light-text)}body.dark-mode .rules-highlight{background:rgba(0,71,171,.2);color:var(--dark-blue-light);border:1px solid rgba(0,71,171,.3)}body.dark-mode .warranty-option{background:rgba(0,71,171,.1);border:1px solid rgba(0,71,171,.2);color:var(--dark-light-text)}body.dark-mode .warranty-option.selected{background:var(--dark-blue-light);color:var(--fabreck-white);border-color:var(--dark-blue-light)}body.dark-mode .persisted-field::after{color:var(--fabreck-success);background:rgba(46,204,113,.1)}body.dark-mode #testCredentialsInfo{background:var(--dark-card-bg);border-color:var(--dark-border)}body.dark-mode #testCredentialsInfo p{color:var(--dark-text)!important}body.dark-mode #testCredentialsInfo p strong{color:var(--dark-blue-light)}header{background:linear-gradient(135deg,var(--fabreck-blue),var(--fabreck-dark));padding:15px;border-radius:16px;margin-bottom:15px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,.15);border:1px solid rgba(255,255,255,.1);position:sticky;top:0;z-index:101;transition:padding .3s ease, transform .3s ease}.logo-text-container{padding:5px 0;line-height:1;margin-bottom:10px}.logo-main{font-family:Impact,Haettenschweiler,'Arial Narrow Bold',sans-serif;font-weight:900;font-size:58px;color:var(--fabreck-red);-webkit-text-stroke:3px var(--fabreck-white);paint-order:stroke fill;text-shadow:0 2px 4px rgba(0,0,0,.3);letter-spacing:1px}.logo-sub{font-family:Arial,sans-serif;font-weight:700;font-size:20px;color:var(--fabreck-white);letter-spacing:2px;margin-top:-5px;text-shadow:0 1px 2px rgba(0,0,0,.3)}.sidebar-header .logo-main{font-size:44px}.sidebar-header .logo-sub{font-size:16px}.system-title{font-size:16px;opacity:.9;color:rgba(255,255,255,.85);margin-top:5px;font-weight:500;position:relative;z-index:1}.company-info{margin-top:10px;padding:10px;background:rgba(0,0,0,.2);border-radius:10px;border:1px solid rgba(255,255,255,.15);font-size:13px;backdrop-filter:blur(5px);position:relative;z-index:1}.company-info p{margin:3px 0;color:var(--fabreck-white)}.active-data-container{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;}.active-data{font-weight:700;color:var(--fabreck-white);font-size:13px;padding:4px 8px;border-radius:8px;display:inline-block;margin-top:5px;}.active-salesman-label{background:var(--fabreck-red);}.active-client-label{background:var(--fabreck-blue);}.card{background:var(--fabreck-white);border-radius:16px;box-shadow:0 5px 20px rgba(0,0,0,.05);padding:20px;border:1px solid rgba(0,0,0,.05);transition:transform .3s ease,box-shadow .3s ease,background .3s ease,color .3s ease;margin-bottom:15px}.card:hover{transform:translateY(-5px);box-shadow:0 8px 25px rgba(0,0,0,.1)}.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:12px;border-bottom:2px solid rgba(0,71,171,.1)}.card-title{font-size:18px;color:var(--fabreck-blue);font-weight:700;letter-spacing:.3px}.card-icon{font-size:24px;color:var(--fabreck-white);background:var(--fabreck-red);width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;box-shadow:0 3px 8px rgba(210,38,48,.3)}.form-group{margin-bottom:15px;position:relative}.form-group label{display:block;margin-bottom:5px;font-weight:600;color:var(--fabreck-blue);font-size:14px;transition:color .3s ease}.form-control{width:100%;padding:14px 16px;border:1px solid rgba(0,0,0,.1);border-radius:12px;font-size:16px;background:var(--fabreck-white);color:var(--fabreck-dark);box-shadow:inset 0 1px 3px rgba(0,0,0,.05);transition:border .3s,box-shadow .3s,background .3s ease,color .3s ease}#clientName,#salesmanName,#editClientName,#editSalesmanName,#usernameInput,#receiptOperationCode{text-transform:uppercase}.form-control:focus{border-color:var(--fabreck-blue);outline:none;box-shadow:0 0 0 3px rgba(0,71,171,.2)}.form-row{display:grid;grid-template-columns:1fr;gap:10px}.btn{padding:12px;border:none;border-radius:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-top:10px;width:100%;font-size:15px;box-shadow:0 4px 8px rgba(0,0,0,.1);transition:all .2s}.btn:disabled{background-color:var(--fabreck-gray);cursor:not-allowed;opacity:.7}.btn:active{transform:translateY(2px);box-shadow:0 2px 4px rgba(0,0,0,.1)}.btn-primary{background:var(--fabreck-blue);color:var(--fabreck-white)}.btn-success{background:var(--fabreck-success);color:var(--fabreck-white)}.btn-warning{background:var(--fabreck-warning);color:var(--fabreck-white)}.btn-danger{background:var(--fabreck-danger);color:var(--fabreck-white)}.btn-info{background:#3498DB;color:var(--fabreck-white)}.table-container{overflow-x:auto;margin-top:15px;border:1px solid rgba(0,0,0,.1);border-radius:12px;padding:3px}table{width:100%;border-collapse:collapse;font-size:14px}th,td{padding:12px 15px;text-align:left;border-bottom:1px solid rgba(0,0,0,.08);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}th:first-child,td:first-child{width:40px;text-align:center}th{background:rgba(0,71,171,.1);color:var(--fabreck-blue);font-weight:700;position:sticky;top:0;z-index:1;font-size:13px}tr:nth-child(even){background:rgba(0,71,171,.03)}.status-badge{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:700;display:inline-block;text-align:center}.status-warranty{background:rgba(46,204,113,.15);color:var(--fabreck-success);border:1px solid rgba(46,204,113,.3)}.status-expired{background:rgba(231,76,60,.15);color:var(--fabreck-danger);border:1px solid rgba(231,76,60,.3)}.status-factory,.status-awaiting-receipt{background:rgba(52,152,219,.15);color:#3498DB;border:1px solid rgba(52,152,219,.3)}.status-in-analysis{background:rgba(243,156,18,.15);color:var(--fabreck-warning);border:1px solid rgba(243,156,18,.3)}.status-finalized{background:rgba(142,68,173,.15);color:#8E44AD;border:1px solid rgba(142,68,173,.3)}.action-approved{background:rgba(46,204,113,.2);color:var(--fabreck-success);border:1px solid rgba(46,204,113,.4)}.action-rejected{background:rgba(231,76,60,.2);color:var(--fabreck-danger);border:1px solid rgba(231,76,60,.4)}.action-courtesy{background:rgba(243,156,18,.2);color:var(--fabreck-warning);border:1px solid rgba(243,156,18,.4)}.action-scrapped{background:rgba(127,140,141,.2);color:var(--fabreck-gray);border:1px solid rgba(127,140,141,.4)}.stat-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:15px}.stat-card{background:var(--fabreck-white);padding:15px;border-radius:12px;text-align:center;border:1px solid rgba(0,0,0,.05);box-shadow:0 3px 10px rgba(0,0,0,.03);transition:transform .3s ease,box-shadow .3s ease,background .3s ease,color .3s ease}.stat-card:hover{transform:translateY(-5px);box-shadow:0 8px 25px rgba(0,0,0,.1)}.stat-title{font-size:12px;color:var(--fabreck-blue);margin-bottom:5px;font-weight:600}.stat-value{font-size:24px;font-weight:800;margin:5px 0;color:var(--fabreck-blue)}.nav-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px;color:var(--fabreck-gray);font-size:11px;text-align:center;border-radius:12px;transition:all .3s;flex-basis:0;flex-grow:1}.nav-btn.active{color:var(--fabreck-blue);background:rgba(0,71,171,.1);transform:translateY(-5px)}.nav-btn i{font-size:20px;margin-bottom:3px}.notification{position:fixed;top:20px;left:50%;transform:translateX(-50%);width:auto;min-width:300px;max-width:90%;padding:15px 20px;border-radius:12px;color:var(--fabreck-white);font-weight:600;box-shadow:0 5px 20px rgba(0,0,0,.15);z-index:2100;transform:translate(-50%,-120px);transition:transform .4s ease}.notification.show{transform:translate(-50%,0)}.notification.success{background:var(--fabreck-success);border-left:5px solid rgba(0,0,0,.1)}.notification.error{background:var(--fabreck-danger);border-left:5px solid rgba(0,0,0,.1)}.notification.info{background:var(--fabreck-blue);border-left:5px solid rgba(0,0,0,.1)}.info-section{background:rgba(0,71,171,.05);padding:15px;border-radius:12px;margin-top:15px;border:1px solid rgba(0,71,171,.1);font-size:14px;transition:background .3s ease,border .3s ease,color .3s ease}.report-filters{background:rgba(0,71,171,.05);padding:15px;border-radius:12px;margin-bottom:15px;border:1px solid rgba(0,71,171,.1);transition:background .3s ease,border .3s ease}.filter-row{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:10px}.filter-group{margin-bottom:8px}.filter-buttons{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}.hidden{display:none!important}.status-tabs{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}.status-tab{flex:1;padding:10px;border:1px solid var(--fabreck-blue);background:transparent;color:var(--fabreck-blue);border-radius:8px;cursor:pointer;font-weight:600;transition:all .2s;min-width:100px}.status-tab.active{background:var(--fabreck-blue);color:var(--fabreck-white)}body.dark-mode .status-tab{border-color:var(--dark-blue-light);color:var(--dark-blue-light)}body.dark-mode .status-tab.active{background:var(--dark-blue-light);color:var(--dark-card-bg)}.code-preview{font-size:20px;text-align:center;font-weight:700;margin-top:10px;letter-spacing:2px;color:var(--fabreck-blue);font-family:monospace;transition:color .3s ease}.help-icon{position:absolute;right:10px;top:35px;color:var(--fabreck-blue);cursor:pointer;background:rgba(0,71,171,.1);width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center}.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:2000;opacity:0;pointer-events:none;transition:opacity .3s}.modal.active{opacity:1;pointer-events:all}.modal-content{background:var(--fabreck-white);border-radius:16px;padding:25px;width:90%;max-width:500px;border:2px solid var(--fabreck-blue);position:relative;box-shadow:0 15px 30px rgba(0,0,0,.2);transition:background .3s ease,border .3s ease}.modal-close{position:absolute;top:15px;right:15px;color:var(--fabreck-red);font-size:24px;cursor:pointer;transition:transform .2s}.modal-close:hover{transform:scale(1.1)}.modal-title{color:var(--fabreck-blue);margin-bottom:15px;text-align:center;font-size:20px;font-weight:700}.rules-list{padding-left:20px;margin-bottom:20px}.rules-list li{margin-bottom:12px;line-height:1.5}.rules-highlight{background:rgba(0,71,171,.1);padding:2px 8px;border-radius:4px;font-weight:700;color:var(--fabreck-blue);border:1px solid rgba(0,71,171,.2);transition:background .3s ease,border .3s ease,color .3s ease}.warranty-type{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:15px}.warranty-option{display:flex;align-items:center;background:rgba(0,71,171,.05);padding:12px 15px;border-radius:12px;border:1px solid rgba(0,71,171,.1);cursor:pointer;transition:all .2s}.warranty-option.selected{background:var(--fabreck-blue);color:var(--fabreck-white);border-color:var(--fabreck-blue)}.warranty-option input{margin-right:10px}.persisted-field{position:relative}.persisted-field::after{content:'Salvo';position:absolute;right:10px;top:40px;font-size:10px;color:var(--fabreck-success);background:rgba(46,204,113,.1);padding:2px 5px;border-radius:10px}.code-input-row{display:flex;gap:10px}.code-input-row .form-control{flex:1}.code-input-row .btn{width:auto;flex:0 0 auto;margin-top:0;padding:14px 20px}.activity-log{margin-top:15px;max-height:200px;overflow-y:auto;border:1px solid rgba(0,0,0,.05);border-radius:12px;padding:10px;background:var(--fabreck-white);transition:background .3s ease,border .3s ease}.activity-item{padding:12px;border-bottom:1px dashed rgba(0,0,0,.08);display:flex;gap:10px;align-items:center;border-radius:8px;transition:background .2s,border-bottom .3s ease}.activity-item:hover{background:rgba(0,71,171,.03)}.activity-icon{width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:rgba(0,71,171,.1);color:var(--fabreck-blue);flex-shrink:0}.activity-content{flex:1;font-size:14px}.activity-time{color:var(--fabreck-gray);font-size:12px;white-space:nowrap}
/* AUTOCORRECT STYLES */
.suggestions-list {
    position: absolute;
    z-index: 100;
    border: 1px solid #ccc;
    border-top: none;
    background-color: white;
    max-height: 200px;
    overflow-y: auto;
    width: 100%;
    border-radius: 0 0 12px 12px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}
.suggestion-item {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
    font-size: 14px;
    color: var(--fabreck-dark);
}
.suggestion-item:last-child {
    border-bottom: none;
}
.suggestion-item:hover, .suggestion-item.active {
    background-color: var(--fabreck-light);
    font-weight: 600;
}
body.dark-mode .suggestions-list {
    background-color: var(--dark-card-bg);
    border-color: var(--dark-border);
}
body.dark-mode .suggestion-item {
    color: var(--dark-text);
    border-bottom-color: var(--dark-border);
}
body.dark-mode .suggestion-item:hover, body.dark-mode .suggestion-item.active {
    background-color: rgba(100, 181, 246, 0.1);
}
/* CORREÇÃO DO LAYOUT PARA ACOMODAR 5 CARDS */
@media (min-width:600px){.form-row{grid-template-columns:1fr 1fr}.filter-row{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
#finalizadoPage .stat-cards{grid-template-columns:repeat(auto-fit,minmax(150px,1fr));}
}
/* FIM DA CORREÇÃO DE LAYOUT */
@media (min-width:992px){.total-box{min-width:200px}}@media (min-width:1200px){#scanPage.active{display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start}#scanPage.active .card{margin-bottom:0}#settingsPage.active{display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start}}body.dark-mode .card,body.dark-mode .stat-card,body.dark-mode .total-box,body.dark-mode .activity-log{background:var(--dark-card-bg);border-color:var(--dark-border)}body.dark-mode .card-title,body.dark-mode .form-group label,body.dark-mode .stat-title,body.dark-mode .stat-value,body.dark-mode .total-title,body.dark-mode .code-preview{color:var(--dark-blue-light)}body.dark-mode .form-control{background-color:#2a2a2a;color:var(--dark-text);border-color:var(--dark-border)}body.dark-mode .form-control:focus{border-color:var(--dark-blue-light);box-shadow:0 0 0 3px rgba(100,181,246,.3)}body.dark-mode th{background-color:rgba(100,181,246,.15);color:var(--dark-blue-light)}body.dark-mode tr:nth-child(even){background-color:rgba(100,181,246,.05)}.active-salesman .active-data{background:var(--fabreck-red);}.active-client .active-data{background:var(--fabreck-blue);}.active-salesman, .active-client {display: inline-flex; align-items: center; white-space: nowrap; margin-top: 5px; font-weight: 600;}.active-salesman{margin-right: 15px;}body.dark-mode .info-section,body.dark-mode .report-filters{background:rgba(0,71,171,.15);border-color:rgba(0,71,171,.25)}.logo-minimal-container{display:none}.logo-minimal-container .logo-main{font-size:28px;-webkit-text-stroke:1.5px var(--fabreck-white);text-shadow:none;line-height:1;margin:0}header.minimal{padding:8px 15px;flex-direction:row;display:flex;justify-content:space-between;align-items:center}header.minimal .header-main-content{display:none}header.minimal .header-controls{display:flex;width:100%;justify-content:space-between;align-items:center}header.minimal .logo-minimal-container{display:block}header.minimal .header-buttons{margin-top:0}#header-scroll-trigger{height:1px}</style></head><body><div id="loadingOverlay"><div id="lightning-container"><svg class="lightning bolt1" viewBox="0 0 50 120"><path d="M 50 0 L 20 60 L 45 60 L 15 120 L 50 70 L 25 70 L 50 0 Z"></path></svg><svg class="lightning bolt2" viewBox="0 0 50 120"><path d="M 50 0 L 20 60 L 45 60 L 15 120 L 50 70 L 25 70 L 50 0 Z"></path></svg><svg class="lightning bolt3" viewBox="0 0 50 120"><path d="M 50 0 L 20 60 L 45 60 L 15 120 L 50 70 L 25 70 L 50 0 Z"></path></svg><svg class="lightning bolt4" viewBox="0 0 50 120"><path d="M 50 0 L 20 60 L 45 60 L 15 120 L 50 70 L 25 70 L 50 0 Z"></path></svg><svg class="lightning bolt5" viewBox="0 0 50 120"><path d="M 50 0 L 20 60 L 45 60 L 15 120 L 50 70 L 25 70 L 50 0 Z"></path></svg></div><div class="loading-text"><h1 class="logo-main">FABRECK</h1><h2 class="logo-sub">DO BRASIL</h2><p>A carregar sistema...</p></div></div><div class="login-overlay hidden" id="loginOverlay"><div id="screensaverOverlay"><div id="lightning-container"><svg class="lightning bolt1" viewBox="0 0 50 120"><path d="M 50 0 L 20 60 L 45 60 L 15 120 L 50 70 L 25 70 L 50 0 Z"></path></svg><svg class="lightning bolt2" viewBox="0 0 50 120"><path d="M 50 0 L 20 60 L 45 60 L 15 120 L 50 70 L 25 70 L 50 0 Z"></path></svg><svg class="lightning bolt3" viewBox="0 0 50 120"><path d="M 50 0 L 20 60 L 45 60 L 15 120 L 50 70 L 25 70 L 50 0 Z"></path></svg><svg class="lightning bolt4" viewBox="0 0 50 120"><path d="M 50 0 L 20 60 L 45 60 L 15 120 L 50 70 L 25 70 L 50 0 Z"></path></svg><svg class="lightning bolt5" viewBox="0 0 50 120"><path d="M 50 0 L 20 60 L 45 60 L 15 120 L 50 70 L 25 70 L 50 0 Z"></path></svg></div><div class="loading-text"><h1 class="logo-main">FABRECK</h1><h2 class="logo-sub">DO BRASIL</h2><p>Toque para voltar</p></div></div><div class="login-card"><div class="logo-text-container"><h1 class="logo-main">FABRECK</h1><h2 class="logo-sub">BATERIAS</h2></div><h2>Acesso Restrito</h2><form id="loginForm"><div class="form-group"><label for="usernameInput">Utilizador</label><input type="text" id="usernameInput" class="form-control" required></div><div class="form-group"><label for="passwordInput">Palavra-passe</label><input type="password" id="passwordInput" class="form-control" required></div><button type="submit" class="btn btn-primary">Entrar</button></form><div style="margin-top: 15px; border-top: 1px solid #e0e0e0; padding-top: 15px;"><button id="viewerLoginBtn" class="btn btn-info" style="margin-top:0;">Acesso Rápido (Somente Consulta)</button></div>
<p id="appVersionLogin" style="font-size: 12px; color: var(--fabreck-gray); margin-top: 20px;"></p></div></div><div id="layoutContainer"><nav id="sidebar"><div class="sidebar-header"><div class="logo-text-container"><h1 class="logo-main">FABRECK</h1><h2 class="logo-sub">BATERIAS</h2></div><h3>Garantia</h3></div><div class="sidebar-nav"><a href="#" class="sidebar-btn active" data-page="scanPage"><i class="fas fa-bolt"></i><span>Registo</span></a><a href="#" class="sidebar-btn jenilton-only-nav aline-only" data-page="receiptPage"><i class="fas fa-dolly"></i><span>Meus Recebimentos</span></a><a href="#" class="sidebar-btn jenilton-only-nav reginaldo-only" data-page="analysisPage"><i class="fas fa-clipboard-check"></i><span>Minhas Análises</span></a><a href="#" class="sidebar-btn" data-page="finalizadoPage"><i class="fas fa-check-double"></i><span>Finalizadas</span></a><a href="#" class="sidebar-btn jenilton-only" data-page="dispatchPage"><i class="fas fa-truck"></i><span>Expedição</span></a><a href="#" class="sidebar-btn jenilton-only" data-page="settingsPage"><i class="fas fa-cog"></i><span>Ajustes</span></a></div><div class="sidebar-footer"><p>&copy; 2025 FABRECK DO BRASIL | PCP Jenilton Cruz<br>Versão <span id="appVersionSidebar"></span></p></div></nav><div id="mainContentWrapper"><div class="container"><header><div class="header-main-content"><div class="logo-text-container"><h1 class="logo-main">FABRECK</h1><h2 class="logo-sub">BATERIAS</h2></div><div class="system-title">Sistema de Controle de Garantia</div><div class="company-info"><div class="active-data-container">
    <span class="active-salesman">Vendedor Ativo: <span class="active-data active-salesman-label" id="currentSalesman">N/A</span></span>
    <span class="active-client">Cliente Ativo: <span class="active-data active-client-label" id="currentClient">N/A</span></span>
</div></div></div><div class="header-controls"><div class="logo-minimal-container"><h1 class="logo-main">FABRECK</h1></div><div id="connectionStatus" style="font-size: 12px; font-weight: 600; color: white; opacity: 0.8;">A Ligar...</div><div class="header-buttons" style="display: flex; gap: 10px; margin-left: auto;"><button id="toggleDarkModeBtn" class="btn btn-info" style="width: auto; margin-top:0;"><i class="fas fa-moon"></i> <span id="darkModeText">Modo Escuro</span></button><button id="logoutBtn" class="btn btn-danger" style="width: auto; margin-top:0;"><i class="fas fa-sign-out-alt"></i> Sair</button></div></div></header><div id="header-scroll-trigger"></div><div id="scanPage" class="page active"><div class="card"><div class="card-header"><h2 class="card-title">Registo de Garantia</h2><div class="card-icon"><i class="fas fa-bolt"></i></div></div><div class="form-row"><div class="form-group autocomplete-container"><label for="clientName">Nome do Cliente</label><input type="text" id="clientName" class="form-control" placeholder="Nome completo" autocomplete="off"></div><div class="form-group"><label for="clientPhone">Telefone (WhatsApp)</label><input type="tel" id="clientPhone" class="form-control" placeholder="Ex: 5511999998888"></div><div class="form-group autocomplete-container"><label for="salesmanName">Nome do Vendedor</label><input type="text" id="salesmanName" class="form-control" placeholder="Nome do vendedor" autocomplete="off"></div></div><div class="form-group"><label for="submissionDateInput">Data do Envio</label><input type="date" id="submissionDateInput" class="form-control"></div><div class="warranty-type"><div class="warranty-option" id="factoryOption"><input type="radio" id="factoryRadio" name="warrantyType" value="factory" style="display:none;"><label for="factoryRadio" style="width:100%; cursor:pointer;">Garantia p/ Fábrica</label></div><div class="warranty-option" id="analyzedOption"><input type="radio" id="analyzedRadio" name="warrantyType" value="analyzed" style="display:none;"><label for="analyzedRadio" style="width:100%; cursor:pointer;">Análise por Vídeo</label></div></div><div id="videoAnalysisOptions" class="hidden"><div class="form-group"><label>Parecer Rápido (Análise por Vídeo)</label><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"><button id="procedenteBtn" class="btn btn-success" style="margin-top:0;">Procedente</button><button id="descarregadaBtn" class="btn btn-warning" style="margin-top:0;">Descarregada</button></div></div><div class="form-group"><label for="recommendation">Parecer Técnico (Obrigatório)</label><textarea id="recommendation" class="form-control" placeholder="Clique em uma opção acima ou digite o parecer."></textarea></div><button id="addObservationBtn" class="btn btn-info" style="margin-top: -10px; margin-bottom: 10px;"><i class="fas fa-comment-alt"></i> Adicionar Observações</button></div><div class="form-group"><label for="serialCode">Código de Série<i class="fas fa-question-circle help-icon" id="helpBtn"></i></label><div class="code-input-row"><div style="position: relative; flex: 1;"><input type="text" id="serialCode" class="form-control" placeholder="Ex: 3524A2623" maxlength="9"></div><button id="addBtn" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Adicionar</button></div><div id="codePreview" class="code-preview"></div><div id="warrantyDebugInfo" class="info-section" style="margin-top: 10px; display: none;"><p><strong>Informações de Cálculo da Garantia:</strong></p><p>Fabricação: <span id="debugManufDate"></span></p><p>Fim da Garantia: <span id="debugWarrantyEndDate"></span></p><p>Status Calculado: <span id="debugCalculatedStatus"></span></p></div></div><div class="form-row" style="margin-top: 10px;"><button id="clearFormBtn" class="btn btn-danger"><i class="fas fa-eraser"></i> Limpar Formulário e Desbloquear</button><button id="showRequirementsBtn" class="btn btn-info"><i class="fas fa-info-circle"></i> Requisitos para Análise</button><button id="registerScrapBtn" class="btn btn-warning jenilton-only"><i class="fas fa-trash-alt"></i> Recebimento de Sucatas</button></div><div class="activity-log" id="activityLog"></div></div><div class="card"><div class="card-header"><h2 class="card-title">Últimos Registos</h2><div class="card-icon"><i class="fas fa-history"></i></div></div><div class="table-container" style="margin-top:0; max-height: 65vh;"><table id="recentRegistrationsTable"><thead><tr><th>Cód. Operação</th><th>Código Bateria</th><th>Cliente</th><th>Vendedor</th><th>Data</th></tr></thead><tbody id="recentRegistrationsBody"></tbody></table></div></div></div>

<!-- PÁGINA EXCLUSIVA DA ALINE: RECEBIMENTO -->
<div id="receiptPage" class="page"><div class="card"><div class="card-header"><h2 class="card-title">Meus Recebimentos (Aline)</h2><div class="card-icon"><i class="fas fa-dolly"></i></div></div><div class="info-section"><p><b>Função:</b> Esta é a sua área para confirmar o recebimento físico das baterias e fazer a triagem inicial.</p><div id="receiptLockMessage" class="info-section" style="margin-top: 10px; background-color: var(--fabreck-danger); color: var(--fabreck-white); display: none;"><i class="fas fa-lock"></i> **ATENÇÃO!** Não pode receber baterias enquanto um registo estiver em curso (Cliente/Vendedor Ativo no Cabeçalho). Peça para o registo ser finalizado.</div></div><div class="report-filters"><div class="filter-row" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
        <div class="form-group" style="margin: 0;"><label for="receiptSearchInput" style="margin-bottom: 2px;">Pesquisa Rápida:</label><input type="search" id="receiptSearchInput" class="form-control" placeholder="Pesquisar por cliente, códigos de bateria..."></div>
        <div class="form-group" style="margin: 0;"><label for="receiptClientFilter" style="margin-bottom: 2px;">Filtrar por Cliente:</label><select id="receiptClientFilter" class="form-control"></select></div>
    </div>
</div><div class="stat-cards"><div class="stat-card"><div class="stat-title">Aguardando Recebimento</div><div class="stat-value" id="awaitingReceiptCount">0</div></div></div><div class="batch-actions"><button id="batchReceiptBtn" class="btn btn-success" disabled><i class="fas fa-check-double"></i> Confirmar Recebidos</button></div><div class="table-container"><table id="receiptTable"><thead><tr><th><input type="checkbox" id="selectAllReceiptCheckbox"></th><th>Código Bateria</th><th>Modelo</th><th>Cliente</th><th>Vendedor</th><th>Data Envio</th><th>Status Prazo</th><th class="actions-cell">Ação</th></tr></thead><tbody id="receiptBody"></tbody></table></div></div></div>

<!-- PÁGINA EXCLUSIVA DO REGINALDO: ANÁLISE TÉCNICA -->
<div id="analysisPage" class="page"><div class="card"><div class="card-header"><h2 class="card-title">Minhas Análises (Reginaldo)</h2><div class="card-icon"><i class="fas fa-clipboard-check"></i></div></div><div class="info-section"><p><b>Função:</b> Esta lista contém apenas baterias que já foram recebidas e estão prontas para o seu teste técnico. Utilize os filtros para organizar a fila de trabalho.</p></div><div class="report-filters"><div class="filter-row" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
        <div class="form-group" style="margin: 0;"><label for="analysisSearchInput" style="margin-bottom: 2px;">Pesquisa Rápida:</label><input type="search" id="analysisSearchInput" class="form-control" placeholder="Pesquisar por códigos, modelo..."></div>
        <div class="form-group" style="margin: 0;"><label for="analysisClientFilter">Filtrar por Cliente:</label><select id="analysisClientFilter" class="form-control"></select></div>
        <div class="form-group" style="margin: 0;"><label for="analysisSalesmanFilter">Filtrar por Vendedor:</label><select id="analysisSalesmanFilter" class="form-control"></select></div>
    </div>
</div><div class="stat-cards"><div class="stat-card"><div class="stat-title">Prontas para Análise</div><div class="stat-value" id="inAnalysisCount">0</div></div></div><div class="batch-actions"><button id="batchAnalyzeBtn" class="btn btn-success" disabled><i class="fas fa-layer-group"></i> Analisar Selecionados</button></div><div class="table-container"><table id="analysisTable"><thead><tr><th><input type="checkbox" id="selectAllAnalysisCheckbox"></th><th>Cód. Operação</th><th>Código Bateria</th><th>Cliente</th><th>Modelo</th><th>Data Envio</th><th>Status Garantia</th><th class="actions-cell">Ação</th></tr></thead><tbody id="analysisBody"></tbody></table></div></div></div>

<!-- PÁGINA DE FINALIZADAS (Para todos, mas com ações exclusivas Jenilton) -->
<div id="finalizadoPage" class="page"><div class="card"><div class="card-header"><h2 class="card-title">Garantias Finalizadas</h2><div class="card-icon"><i class="fas fa-check-double"></i></div></div><div class="info-section"><p><b>Função do Jenilton:</b> Use esta página para consultar garantias já finalizadas, gerar relatórios para os clientes e preparar os pedidos de envio.</p></div><div class="stat-cards">
    <div class="stat-card">
        <div class="stat-title">TOTAL FINALIZADAS</div>
        <div class="stat-value" id="finalizadoCount">0</div>
        <span class="stat-percent" id="finalizadoTotalPercent" style="font-size: 11px; opacity: 0.7;">100%</span>
    </div>
    <div class="stat-card">
        <div class="stat-title">PROCEDENTE (ENVIAR NOVA)</div>
        <div class="stat-value" id="finalizadoAprovadaFabricaCount">0</div>
        <span class="stat-percent" id="finalizadoAprovadaFabricaPercent" style="font-size: 11px; font-weight: 600; color: var(--fabreck-success);">0%</span>
    </div>
    <div class="stat-card">
        <div class="stat-title">IMPROCEDENTES (CORTESIA)</div>
        <div class="stat-value" id="finalizadoAprovadaCortesiaCount">0</div>
        <span class="stat-percent" id="finalizadoAprovadaCortesiaPercent" style="font-size: 11px; font-weight: 600; color: var(--fabreck-warning);">0%</span>
    </div>
    <div class="stat-card" style="border: 2px solid var(--fabreck-danger);">
        <div class="stat-title">REPROVADA - FORA DO PRAZO</div>
        <div class="stat-value" id="finalizadoReprovadaForaPrazoCount">0</div>
        <span class="stat-percent" id="finalizadoReprovadaForaPrazoPercent" style="font-size: 11px; font-weight: 600; color: var(--fabreck-danger);">0%</span>
    </div>
    <!-- NOVO CARD: IMPROCEDENTE (DEVOLVER) -->
    <div class="stat-card" style="border: 2px solid var(--fabreck-warning);">
        <div class="stat-title">IMPROCEDENTE (DEVOLVER)</div>
        <div class="stat-value" id="finalizadoReprovadaDevolverCount">0</div>
        <span class="stat-percent" id="finalizadoReprovadaDevolverPercent" style="font-size: 11px; font-weight: 600; color: var(--fabreck-warning);">0%</span>
    </div>
    <!-- CARD REPROVADA (MAU USO / SUCATEAR) -->
    <div class="stat-card">
        <div class="stat-title">REPROVADA (MAU USO / SUCATEAR)</div>
        <div class="stat-value" id="finalizadoReprovadaMauUsoSucatearCount">0</div>
        <span class="stat-percent" id="finalizadoReprovadaMauUsoSucatearPercent" style="font-size: 11px; font-weight: 600; color: var(--fabreck-danger);">0%</span>
    </div>
</div><div class="report-filters"><div class="form-group" style="margin-bottom: 10px;"><label for="finalizadoSearchInput">Pesquisa Rápida</label><input type="search" id="finalizadoSearchInput" class="form-control" placeholder="Pesquisar por cliente, códigos, parecer..."></div><div class="filter-row" style="margin-top: 15px;"><div class="filter-group"><label for="finalizadoStartDate">Data Inicial da Análise:</label><input type="date" id="finalizadoStartDate" class="form-control"></div><div class="filter-group"><label for="finalizadoEndDate">Data Final da Análise:</label><input type="date" id="finalizadoEndDate" class="form-control"></div><div class="filter-group"><label for="finalizadoClientFilter">Filtrar por Cliente:</label><select id="finalizadoClientFilter" class="form-control"></select></div><div class="filter-group"><label for="finalizadoSalesmanFilter">Filtrar por Vendedor:</label><select id="finalizadoSalesmanFilter" class="form-control"></select></div><div class="filter-group"><label for="finalizadoActionFilter">Filtrar por Ação Final:</label><select id="finalizadoActionFilter" class="form-control"></select></div></div><div class="filter-buttons" style="grid-template-columns: 1fr; margin-top: 10px;"><button id="finalizadoClearFilterBtn" class="btn btn-danger">Limpar Filtros</button></div></div><div class="filter-buttons" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); margin-top: 15px; margin-bottom: 15px;"><button id="batchEditFinalizadoBtn" class="btn btn-warning jenilton-only" disabled><i class="fas fa-edit"></i> Alterar Selecionadas</button><button id="finalizadoPdfBtn" class="btn btn-primary"><i class="fas fa-file-pdf"></i> Gerar PDF</button><button id="finalizadoExcelBtn" class="btn btn-success"><i class="fas fa-file-excel"></i> Exportar Excel</button><button id="finalizadoWhatsappBtn" class="btn btn-info"><i class="fab fa-whatsapp"></i> Enviar Resumo</button></div><div class="table-container"><table id="finalizadoTable"><thead><tr><th class="jenilton-only"><input type="checkbox" id="selectAllFinalizadoCheckbox"></th><th>Cód. Operação</th><th>Código Bateria</th><th>Cliente</th><th>Data da Análise</th><th>Ação Final</th><th>Parecer</th><th class="actions-cell">Ação</th></tr></thead><tbody id="finalizadoBody"></tbody></table></div></div></div><div id="dispatchPage" class="page jenilton-only"><div class="card"><div class="card-header"><h2 class="card-title">Pedidos de Expedição Pendentes</h2><div class="card-icon"><i class="fas fa-truck-loading"></i></div></div><div class="info-section"><p>Esta é a sua área para gerar os pedidos de envio para as garantias aprovadas. As baterias são agrupadas por cliente. Ao gerar um pedido, elas saem desta lista para evitar duplicidade.</p></div><div class="report-filters"><div class="form-group" style="margin-bottom: 0;"><label for="dispatchSearchInput">Pesquisar Cliente ou Vendedor</label><input type="search" id="dispatchSearchInput" class="form-control" placeholder="Digite o nome do cliente ou vendedor..."></div></div><div id="dispatchClientList"></div></div></div><div id="settingsPage" class="page jenilton-only"><div class="card"><div class="card-header"><h2 class="card-title">Backup e Restauração (Nuvem)</h2><div class="card-icon"><i class="fas fa-cloud-upload-alt"></i></div></div><div class="info-section" style="margin-top:0;"><p>Use os botões abaixo para guardar uma cópia de segurança de todos os dados da nuvem para o seu computador, ou para restaurar os dados de um ficheiro de backup para a nuvem.</p></div><div class="form-row"><button id="backupBtn" class="btn btn-primary"><i class="fas fa-download"></i> Exportar Dados (Backup)</button><button id="restoreBtn" class="btn btn-primary"><i class="fas fa-upload"></i> Importar Dados (Restaurar)</button></div><input type="file" id="restoreFile" accept=".json" style="display: none;"><div class="info-section"><h3>Última Sincronização com a Nuvem</h3><p id="lastUpdate">A ligar...</p></div></div><div class="card"><div class="card-header"><h2 class="card-title">Instruções de Garantia</h2><div class="card-icon"><i class="fas fa-info-circle"></i></div></div><div id="warrantyInstructionsContainer" class="info-section" style="margin-top:0;"></div></div><div class="card"><div class="card-header"><h2 class="card-title">Segurança</h2><div class="card-icon"><i class="fas fa-shield-alt"></i></div></div><div class="info-section" style="margin-top:0;"><p>Altere a sua palavra-passe de administrador regularmente para manter a segurança da sua conta.</p></div><button id="changePasswordBtn" class="btn btn-warning" style="margin-top: 20px;"><i class="fas fa-key"></i> Alterar Palavra-passe</button></div><div class="card"><div class="card-header"><h2 class="card-title">Sobre a Aplicação</h2><div class="card-icon"><i class="fas fa-code-branch"></i></div></div><div class="info-section" style="margin-top:0;"><p><strong>Versão da Aplicação:</strong> <span id="appVersionSettings"></span></p></div></div></div></div><div class="footer"><div class="nav-btn active" data-page="scanPage"><div><i class="fas fa-bolt"></i></div><span>Registo</span></div><div class="nav-btn jenilton-only-nav aline-only" data-page="receiptPage"><div><i class="fas fa-dolly"></i></div><span>Recebimentos</span></div><div class="nav-btn jenilton-only-nav reginaldo-only" data-page="analysisPage"><div><i class="fas fa-clipboard-check"></i></div><span>Análise</span></div><div class="nav-btn" data-page="finalizadoPage"><div><i class="fas fa-check-double"></i></div><span>Finalizadas</span></div><div class="nav-btn jenilton-only" data-page="dispatchPage"><div><i class="fas fa-truck"></i></div><span>Expedição</span></div><div class="nav-btn jenilton-only" data-page="settingsPage"><div><i class="fas fa-cog"></i></div><span>Ajustes</span></div></div></div><div id="notification" class="notification"></div><div class="modal" id="rulesModal"><div class="modal-content"><span class="modal-close" id="closeRulesModal">&times;</span><h3 class="modal-title">Formato do Código de Série</h3><ul class="rules-list"><li>O código deve ter exatamente <span class="rules-highlight">9 caracteres</span></li><li>Os primeiros 4 caracteres devem ser <span class="rules-highlight">números</span></li><li>O quinto caractere deve ser uma <span class="rules-highlight">letra</span></li><li>Os últimos 4 caracteres devem ser <span class="rules-highlight">números</span></li><li>Exemplo válido: <span class="rules-highlight">3524A2623</span></li></ul><button class="btn btn-primary" id="confirmRules" style="width: 100%;">Entendi</button></div></div><div class="modal" id="receiptConfirmModal"><div class="modal-content"><span class="modal-close" id="closeReceiptConfirmModal">&times;</span><h3 class="modal-title" id="receiptConfirmTitle">Confirmar Recebimento</h3><div id="receiptBatteryInfo" class="info-section" style="margin-top:0; margin-bottom: 15px; text-align: left; display: none;"></div><div class="form-group"><label for="receiptOperationCode">Código da Operação (Obrigatório)</label><input type="text" id="receiptOperationCode" class="form-control" placeholder="Insira o código da operação"></div><div style="display: flex; gap: 10px; margin-top: 20px;"><button type="button" id="cancelReceiptConfirmBtn" class="btn btn-info" style="margin-top:0;">Cancelar</button><button type="button" id="confirmReceiptBtn" class="btn btn-success" style="margin-top:0;">Confirmar Recebimento</button></div></div></div><div class="modal" id="analysisModal"><div class="modal-content"><span class="modal-close" id="closeAnalysisModal">&times;</span><h3 class="modal-title" id="analysisModalTitle">Analisar Bateria</h3><div id="analysisSingleInfo"><div class="analysis-info"><p><strong>Cliente:</strong> <span id="analysisClientName"></span></p><p><strong>Vendedor:</strong> <span id="analysisSalesmanName"></span></p><p><strong>Modelo:</strong> <span id="analysisBatteryModel"></span></p><p><strong>Status Garantia:</strong> <span id="analysisWarrantyStatus"></span></p></div></div><div class="form-group"><label>Diagnóstico Técnico</label><div class="warranty-type"><div class="warranty-option" id="analysisApprovedRadioContainer"><input type="radio" id="analysisApprovedRadio" name="analysisDiagnosis" value="approved" style="display:none;"><label for="analysisApprovedRadio" style="width:100%; cursor:pointer;">Procedente</label></div><div class="warranty-option" id="analysisRejectedRadioContainer"><input type="radio" id="analysisRejectedRadio" name="analysisDiagnosis" value="rejected" style="display:none;"><label for="analysisRejectedRadio" style="width:100%; cursor:pointer;">Improcedente</label></div></div></div><div class="form-group"><label for="analysisRecommendation">Parecer Técnico (Descrição)</label><textarea id="analysisRecommendation" class="form-control" placeholder="Descreva o defeito ou o motivo da reprovação..."></textarea></div><div class="form-group"><label for="analysisFinalAction">Ação Comercial Final</label><select id="analysisFinalAction" class="form-control" disabled><option value="">-- Selecione o diagnóstico primeiro --</option></select></div><button id="analysisAddObservationBtn" class="btn btn-info" style="margin-top: -10px; margin-bottom: 10px;"><i class="fas fa-comment-alt"></i> Adicionar Observações</button><button id="saveAnalysisBtn" class="btn btn-success"><i class="fas fa-save"></i> Salvar Análise e Finalizar</button></div></div><div class="modal" id="batchEditFinalizadoModal"><div class="modal-content"><span class="modal-close" id="closeBatchEditFinalizadoModal">&times;</span><h3 class="modal-title" id="batchEditFinalizadoModalTitle">Alterar Análises em Lote</h3><p style="text-align: center; font-size: 14px; margin-bottom: 15px;">A ação e parecer abaixo serão aplicados a todos os itens selecionados.</p><div class="form-group"><label>Novo Diagnóstico Técnico</label><div class="warranty-type"><div class="warranty-option" id="batchEditApprovedRadioContainer"><input type="radio" id="batchEditApprovedRadio" name="batchEditDiagnosis" value="approved" style="display:none;"><label for="batchEditApprovedRadio" style="width:100%; cursor:pointer;">Procedente</label></div><div class="warranty-option" id="batchEditRejectedRadioContainer"><input type="radio" id="batchEditRejectedRadio" name="batchEditDiagnosis" value="rejected" style="display:none;"><label for="batchEditRejectedRadio" style="width:100%; cursor:pointer;">Improcedente</label></div></div></div><div class="form-group"><label for="batchEditFinalAction">Nova Ação Comercial Final</label><select id="batchEditFinalAction" class="form-control" disabled><option value="">-- Selecione o diagnóstico primeiro --</option></select></div><div class="form-group"><label for="batchEditRecommendation">Novo Parecer Técnico (Descrição)</label><textarea id="batchEditRecommendation" class="form-control" placeholder="Selecione uma ação para preenchimento automático..."></textarea></div><button id="saveBatchEditBtn" class="btn btn-success"><i class="fas fa-save"></i> Salvar Alterações em Lote</button></div></div><div class="modal" id="clientEditModal"><div class="modal-content"><span class="modal-close" id="closeClientEditModal">&times;</span><h3 class="modal-title">Editar Dados do Cliente</h3><p style="text-align: center; font-size: 14px; margin-bottom: 15px;">A alteração será aplicada a todos os registos com este cliente.</p><div class="form-group"><label for="editClientName">Nome do Cliente</label><input type="text" id="editClientName" class="form-control"></div><div class="form-group"><label for="editClientPhone">Telefone (WhatsApp)</label><input type="tel" id="editClientPhone" class="form-control" placeholder="Ex: 5511999998888"></div><div class="form-group"><label for="editSalesmanName">Nome do Vendedor</label><input type="text" id="editSalesmanName" class="form-control"></div><button id="saveClientEditBtn" class="btn btn-success"><i class="fas fa-save"></i> Salvar Alterações</button></div></div><div class="modal" id="observationModal"><div class="modal-content"><span class="modal-close" id="closeObservationModal">&times;</span><h3 class="modal-title">Observações para o Cliente</h3><div class="form-group"><label for="observationText">Observação</label><textarea id="observationText" class="form-control" rows="4" placeholder="Digite aqui informações adicionais para o cliente..."></textarea></div><button id="saveObservationBtn" class="btn btn-primary"><i class="fas fa-check"></i> Confirmar</button></div></div><div class="modal" id="procedenteModal"><div class="modal-content"><span class="modal-close" id="closeProcedenteModal">&times;</span><h3 class="modal-title">Motivo - Procedente</h3><p style="text-align: center; font-size: 14px; margin-bottom: 15px;">Selecione o motivo pelo qual a garantia foi aprovada.</p><div style="display: grid; grid-template-columns: 1fr; gap: 10px;"><button id="capacidadeBaixaBtn" class="btn btn-success">Capacidade Baixa</button><button id="ccaBaixoBtn" class="btn btn-success">CCA Baixo</button></div></div></div><div class="modal" id="confirmModal"><div class="modal-content"><h3 class="modal-title" id="confirmTitle">Confirmar Ação</h3><p id="confirmMessage" style="text-align: center; font-size: 14px; margin-bottom: 20px;">Tem a certeza que deseja prosseguir?</p><div style="display: flex; gap: 10px;"><button id="cancelConfirmBtn" class="btn btn-info" style="margin-top:0;">Cancelar</button><button id="confirmActionBtn" class="btn btn-danger" style="margin-top:0;">Confirmar</button></div></div></div><div class="modal" id="passwordConfirmModal"><div class="modal-content"><span class="modal-close" id="closePasswordConfirmModal">&times;</span><h3 class="modal-title">Confirmação de Segurança</h3><p style="text-align: center; font-size: 14px; margin-bottom: 15px;">Para apagar todos os dados da nuvem, confirme a palavra-passe MASTER de administrador.</p><form id="passwordConfirmForm"><div class="form-group"><label for="adminPasswordConfirm">Palavra-passe MASTER</label><input type="password" id="adminPasswordConfirm" class="form-control" required></div><div style="display: flex; gap: 10px; margin-top: 20px;"><button id="cancelPasswordConfirmBtn" class="btn btn-info" style="margin-top:0;">Cancelar</button><button type="submit" id="confirmActionBtn" class="btn btn-danger" style="margin-top:0;">Confirmar e Apagar Tudo</button></div></form></div></div><div class="modal" id="whatsappPreviewModal"><div class="modal-content" style="max-width: 600px;"><span class="modal-close" id="closeWhatsappPreviewModal">&times;</span><h3 class="modal-title">Pré-visualização da Mensagem</h3><div class="info-section" style="margin-top: 0; margin-bottom: 20px; max-height: 40vh; overflow-y: auto;"><pre id="whatsappMessagePreview" style="white-space: pre-wrap; word-wrap: break-word; font-size: 14px;"></pre></div><div style="display: flex; gap: 10px;"><button id="cancelWhatsappBtn" class="btn btn-warning" style="margin-top:0;">Cancelar</button><button id="sendWhatsappBtn" class="btn btn-success" style="margin-top:0;"><i class="fab fa-whatsapp"></i> Enviar Agora</button></div></div></div><div class="modal" id="whatsappOptionsMenuModal"><div class="modal-content"><span class="modal-close" id="closeWhatsappOptionsMenuModal">&times;</span><h3 class="modal-title">Escolha o Relatório para Enviar</h3><div class="info-section" style="margin-top:0; margin-bottom: 20px;"><p>Selecione uma das opções abaixo para gerar e enviar um relatório via WhatsApp.</p></div><div style="display: grid; grid-template-columns: 1fr; gap: 10px;"><button id="sendFilteredReportBtn" class="btn btn-primary"><i class="fas fa-filter"></i> Resumo Detalhado do Filtro</button><button id="sendTodaySummaryBtn" class="btn btn-info"><i class="fas fa-calendar-day"></i> Resumo de Registos de Hoje</button><button id="sendPendingAnalysisBtn" class="btn btn-warning"><i class="fas fa-hourglass-half"></i> Notificar Pendentes de Análise</button><button id="sendGeneralSummaryBtn" class="btn btn-success"><i class="fas fa-globe-americas"></i> Resumo Geral de Finalizadas</button></div></div></div><div class="modal" id="finalizedNotificationModal"><div class="modal-content"><span class="modal-close" id="closeFinalizedNotificationModal">&times;</span><h3 class="modal-title"><i class="fas fa-bell" style="color: var(--fabreck-warning);"></i> Novas Baterias Finalizadas!</h3><div id="finalizedNotificationList" class="info-section" style="margin-top:0; text-align: left; max-height: 40vh; overflow-y: auto;"></div></div></div><div class="modal" id="receiptSummaryModal"><div class="modal-content"><span class="modal-close" id="closeReceiptSummaryModal">&times;</span><h3 class="modal-title" id="receiptSummaryTitle">Resumo de Baterias</h3><div id="receiptSummaryBody" class="info-section" style="margin-top:0; text-align: left;"></div><button id="printReceiptSummaryBtn" class="btn btn-primary" style="margin-top: 15px;"><i class="fas fa-print"></i> Visualizar para Impressão</button></div></div><div class="modal" id="dispatchConfirmModal"><div class="modal-content"><span class="modal-close" id="closeDispatchConfirmModal">&times;</span><h3 class="modal-title" id="dispatchConfirmTitle">Finalizar Expedição</h3><div id="dispatchInfo" class="info-section" style="margin-top:0; margin-bottom: 15px; text-align: center;"><p>A finalizar o pedido de expedição. Insira a Ordem de Serviço (O.S.) para confirmar o envio.</p></div><div class="form-group"><label for="dispatchOSCode">Ordem de Serviço (O.S.)</label><input type="text" id="dispatchOSCode" class="form-control" placeholder="Insira o código da O.S."></div><div style="display: flex; gap: 10px; margin-top: 20px;"><button type="button" id="cancelDispatchConfirmBtn" class="btn btn-info" style="margin-top:0;">Cancelar</button><button type="button" id="confirmDispatchBtn" class="btn btn-success" style="margin-top:0;">Confirmar Expedição</button></div></div></div><div class="modal" id="dispatchSummaryModal"><div class="modal-content"><span class="modal-close" id="closeDispatchSummaryModal">&times;</span><h3 class="modal-title" id="dispatchSummaryTitle">Resumo de Expedição</h3><div id="dispatchSummaryBody" class="info-section" style="margin-top:0; text-align: left;"></div><button id="printDispatchSummaryBtn" class="btn btn-primary" style="margin-top: 15px;"><i class="fas fa-print"></i> Visualizar para Impressão</button></div></div><div class="modal" id="passwordModal"><div class="modal-content"><span class="modal-close" id="closePasswordModal">&times;</span><h3 class="modal-title">Alterar Palavra-passe</h3><form id="passwordChangeForm"><div class="form-group"><label for="currentPassword">Palavra-passe Atual</label><input type="password" id="currentPassword" class="form-control" required></div><div class="form-group"><label for="newPassword">Nova Palavra-passe</label><input type="password" id="newPassword" class="form-control" required></div><div class="form-group"><label for="confirmNewPassword">Confirmar Nova Palavra-passe</label><input type="password" id="confirmNewPassword" class="form-control" required></div><button type="submit" id="savePasswordBtn" class="btn btn-success"><i class="fas fa-save"></i> Guardar Nova Palavra-passe</button></form></div></div><script>
    document.addEventListener('DOMContentLoaded', () => {
        const {initializeApp,getFirestore,collection,onSnapshot,addDoc,doc,deleteDoc,updateDoc,writeBatch,getDocs,query,where,setDoc,getDoc,getAuth,signInAnonymously,onAuthStateChanged}=window.firebase;const layoutContainer=document.getElementById('layoutContainer');const loginOverlay=document.getElementById('loginOverlay');const loginForm=document.getElementById('loginForm');const usernameInput=document.getElementById('usernameInput');const passwordInput=document.getElementById('passwordInput');const viewerLoginBtn=document.getElementById('viewerLoginBtn');const logoutBtn=document.getElementById('logoutBtn');const clientNameInput=document.getElementById('clientName');const salesmanNameInput=document.getElementById('salesmanName');const serialCodeInput=document.getElementById('serialCode');const addBtn=document.getElementById('addBtn');const clearFormBtn=document.getElementById('clearFormBtn');const backupBtn=document.getElementById('backupBtn');const restoreBtn=document.getElementById('restoreBtn');const restoreFileInput=document.getElementById('restoreFile');const totalCount=document.getElementById('totalCount');const lastUpdate=document.getElementById('lastUpdate');const navBtns=document.querySelectorAll('.nav-btn');const sidebarBtns=document.querySelectorAll('.sidebar-btn');const pages=document.querySelectorAll('.page');const codePreview=document.getElementById('codePreview');const activityLog=document.getElementById('activityLog');const currentUserDisplay=document.getElementById('currentUserDisplay');const helpBtn=document.getElementById('helpBtn');const rulesModal=document.getElementById('rulesModal');const closeRulesModal=document.getElementById('closeRulesModal');const confirmRules=document.getElementById('confirmRules');const factoryRadio=document.getElementById('factoryRadio');const analyzedRadio=document.getElementById('analyzedRadio');const factoryOption=document.getElementById('factoryOption');const analyzedOption=document.getElementById('analyzedOption');const recommendationInput=document.getElementById('recommendation');const warrantyDebugInfo=document.getElementById('warrantyDebugInfo');const debugManufDate=document.getElementById('debugManufDate');const debugWarrantyEndDate=document.getElementById('debugWarrantyEndDate');const debugCalculatedStatus=document.getElementById('debugCalculatedStatus');const submissionDateInput=document.getElementById('submissionDateInput');const toggleDarkModeBtn=document.getElementById('toggleDarkModeBtn');const darkModeText=document.getElementById('darkModeText');const warrantyInstructionsContainer=document.getElementById('warrantyInstructionsContainer');const analysisTabs=document.querySelectorAll('.analysis-tab');const analysisTabContents=document.querySelectorAll('.analysis-tab-content');const awaitingReceiptCount=document.getElementById('awaitingReceiptCount');const receiptBody=document.getElementById('receiptBody');const selectAllReceiptCheckbox=document.getElementById('selectAllReceiptCheckbox');const batchReceiptBtn=document.getElementById('batchReceiptBtn');const receiptSearchInput=document.getElementById('receiptSearchInput');const receiptClientFilter=document.getElementById('receiptClientFilter');const analysisBody=document.getElementById('analysisBody');const inAnalysisCount=document.getElementById('inAnalysisCount');const analysisClientFilter=document.getElementById('analysisClientFilter');const analysisSalesmanFilter=document.getElementById('analysisSalesmanFilter');const selectAllAnalysisCheckbox=document.getElementById('selectAllAnalysisCheckbox');const batchAnalyzeBtn=document.getElementById('batchAnalyzeBtn');const analysisSearchInput=document.getElementById('analysisSearchInput');const recentRegistrationsBody=document.getElementById('recentRegistrationsBody');const finalizadoBody=document.getElementById('finalizadoBody');const finalizadoCount=document.getElementById('finalizadoCount');const finalizadoSearchInput=document.getElementById('finalizadoSearchInput');const finalizadoStartDate=document.getElementById('finalizadoStartDate');const finalizadoEndDate=document.getElementById('finalizadoEndDate');const finalizadoSalesmanFilter=document.getElementById('finalizadoSalesmanFilter');const finalizadoActionFilter=document.getElementById('finalizadoActionFilter');const finalizadoClearFilterBtn=document.getElementById('finalizadoClearFilterBtn');const finalizadoPdfBtn=document.getElementById('finalizadoPdfBtn');const finalizadoExcelBtn=document.getElementById('finalizadoExcelBtn');const finalizadoWhatsappBtn=document.getElementById('finalizadoWhatsappBtn');const whatsappPreviewModal=document.getElementById('whatsappPreviewModal');const closeWhatsappPreviewModal=document.getElementById('closeWhatsappPreviewModal');const whatsappMessagePreview=document.getElementById('whatsappMessagePreview');const sendWhatsappBtn=document.getElementById('sendWhatsappBtn');const cancelWhatsappBtn=document.getElementById('cancelWhatsappBtn');const whatsappOptionsMenuModal=document.getElementById('whatsappOptionsMenuModal');const closeWhatsappOptionsMenuModal=document.getElementById('closeWhatsappOptionsMenuModal');const sendFilteredReportBtn=document.getElementById('sendFilteredReportBtn');const sendTodaySummaryBtn=document.getElementById('sendTodaySummaryBtn');const sendPendingAnalysisBtn=document.getElementById('sendPendingAnalysisBtn');const sendGeneralSummaryBtn=document.getElementById('sendGeneralSummaryBtn');const receiptConfirmModal=document.getElementById('receiptConfirmModal');const closeReceiptConfirmModal=document.getElementById('closeReceiptConfirmModal');const receiptConfirmTitle=document.getElementById('receiptConfirmTitle');const receiptBatteryInfo=document.getElementById('receiptBatteryInfo');const receiptOperationCode=document.getElementById('receiptOperationCode');const cancelReceiptConfirmBtn=document.getElementById('cancelReceiptConfirmBtn');const confirmReceiptBtn=document.getElementById('confirmReceiptBtn');const analysisModal=document.getElementById('analysisModal');const closeAnalysisModal=document.getElementById('closeAnalysisModal');const analysisModalTitle=document.getElementById('analysisModalTitle');const analysisSingleInfo=document.getElementById('analysisSingleInfo');const analysisClientName=document.getElementById('analysisClientName');const analysisSalesmanName=document.getElementById('analysisSalesmanName');const analysisBatteryModel=document.getElementById('analysisBatteryModel');const analysisWarrantyStatus=document.getElementById('analysisWarrantyStatus');const analysisRecommendation=document.getElementById('analysisRecommendation');const analysisFinalAction=document.getElementById('analysisFinalAction');const saveAnalysisBtn=document.getElementById('saveAnalysisBtn');const analysisAddObservationBtn=document.getElementById('analysisAddObservationBtn');const analysisApprovedRadio=document.getElementById('analysisApprovedRadio');const analysisRejectedRadio=document.getElementById('analysisRejectedRadio');const analysisApprovedRadioContainer=document.getElementById('analysisApprovedRadioContainer');const analysisRejectedRadioContainer=document.getElementById('analysisRejectedRadioContainer');const clientEditModal=document.getElementById('clientEditModal');const closeClientEditModal=document.getElementById('closeClientEditModal');const editClientNameInput=document.getElementById('editClientName');const editSalesmanNameInput=document.getElementById('editSalesmanName');const editClientPhoneInput=document.getElementById('editClientPhone');const saveClientEditBtn=document.getElementById('saveClientEditBtn');const observationModal=document.getElementById('observationModal');const closeObservationModal=document.getElementById('closeObservationModal');const observationText=document.getElementById('observationText');const saveObservationBtn=document.getElementById('saveObservationBtn');const videoAnalysisOptions=document.getElementById('videoAnalysisOptions');const procedenteBtn=document.getElementById('procedenteBtn');const descarregadaBtn=document.getElementById('descarregadaBtn');const addObservationBtn=document.getElementById('addObservationBtn');const clientPhoneInput=document.getElementById('clientPhone');const procedenteModal=document.getElementById('procedenteModal');const closeProcedenteModal=document.getElementById('closeProcedenteModal');const capacidadeBaixaBtn=document.getElementById('capacidadeBaixaBtn');const ccaBaixoBtn=document.getElementById('ccaBaixoBtn');const confirmModal=document.getElementById('confirmModal');const confirmTitle=document.getElementById('confirmTitle');const confirmMessage=document.getElementById('confirmMessage');const confirmActionBtn=document.getElementById('confirmActionBtn');const cancelConfirmBtn=document.getElementById('cancelConfirmBtn');const finalizedNotificationModal=document.getElementById('finalizedNotificationModal');const closeFinalizedNotificationModal=document.getElementById('closeFinalizedNotificationModal');const receiptSummaryModal=document.getElementById('receiptSummaryModal');const closeReceiptSummaryModal=document.getElementById('closeReceiptSummaryModal');const receiptSummaryTitle=document.getElementById('receiptSummaryTitle');const receiptSummaryBody=document.getElementById('receiptSummaryBody');const printReceiptSummaryBtn=document.getElementById('printReceiptSummaryBtn');const dispatchSummaryModal=document.getElementById('dispatchSummaryModal');const closeDispatchSummaryModal=document.getElementById('closeDispatchSummaryModal');const dispatchSummaryTitle=document.getElementById('dispatchSummaryTitle');const dispatchSummaryBody=document.getElementById('dispatchSummaryBody');const printDispatchSummaryBtn=document.getElementById('printDispatchSummaryBtn');const dispatchConfirmModal=document.getElementById('dispatchConfirmModal');const closeDispatchConfirmModal=document.getElementById('closeDispatchConfirmModal');const dispatchOSCode=document.getElementById('dispatchOSCode');const confirmDispatchBtn=document.getElementById('confirmDispatchBtn');const dispatchClientList=document.getElementById('dispatchClientList');const connectionStatus=document.getElementById('connectionStatus');const passwordConfirmModal=document.getElementById('passwordConfirmModal');const closePasswordConfirmModal=document.getElementById('closePasswordConfirmModal');const passwordConfirmForm=document.getElementById('passwordConfirmForm');const cancelPasswordConfirmBtn=document.getElementById('cancelPasswordConfirmBtn');const adminPasswordConfirmInput=document.getElementById('adminPasswordConfirm');const changePasswordBtn=document.getElementById('changePasswordBtn');const passwordModal=document.getElementById('passwordModal');const closePasswordModal=document.getElementById('closePasswordModal');const passwordChangeForm=document.getElementById('passwordChangeForm');const showRequirementsBtn=document.getElementById('showRequirementsBtn');const registerScrapBtn=document.getElementById('registerScrapBtn');const batchEditFinalizadoBtn=document.getElementById('batchEditFinalizadoBtn');const selectAllFinalizadoCheckbox=document.getElementById('selectAllFinalizadoCheckbox');const batchEditFinalizadoModal=document.getElementById('batchEditFinalizadoModal');const closeBatchEditFinalizadoModal=document.getElementById('closeBatchEditFinalizadoModal');const batchEditApprovedRadioContainer=document.getElementById('batchEditApprovedRadioContainer');const batchEditRejectedRadioContainer=document.getElementById('batchEditRejectedRadioContainer');const batchEditApprovedRadio=document.getElementById('batchEditApprovedRadio');const batchEditRejectedRadio=document.getElementById('batchEditRejectedRadio');const batchEditFinalAction=document.getElementById('batchEditFinalAction');const batchEditRecommendation=document.getElementById('batchEditRecommendation');const saveBatchEditBtn=document.getElementById('saveBatchEditBtn');const finalizadoClientFilter=document.getElementById('finalizadoClientFilter');const finalizadoReprovadaForaPrazoCountEl=document.getElementById('finalizadoReprovadaForaPrazoCount');const finalizadoReprovadaDevolverCountEl=document.getElementById('finalizadoReprovadaDevolverCount');const finalizadoReprovadaMauUsoSucatearCountEl=document.getElementById('finalizadoReprovadaMauUsoSucatearCount');const finalizadoTotalPercentEl=document.getElementById('finalizadoTotalPercent');const finalizadoAprovadaFabricaPercentEl=document.getElementById('finalizadoAprovadaFabricaPercent');const finalizadoAprovadaCortesiaPercentEl=document.getElementById('finalizadoAprovadaCortesiaPercent');const finalizadoReprovadaForaPrazoPercentEl=document.getElementById('finalizadoReprovadaForaPrazoPercent');const finalizadoReprovadaDevolverPercentEl=document.getElementById('finalizadoReprovadaDevolverPercent');const finalizadoReprovadaMauUsoSucatearPercentEl=document.getElementById('finalizadoReprovadaMauUsoSucatearPercent');const GLOBAL_ACTIVE_ID="FABRECK_GLOBAL_ACTIVE_STATUS";const ACTIVITY_DATA_KEY='fabreck_activity_data_v2';const LAST_WARRANTY_TYPE_KEY='fabreck_last_warranty_type_v12';const DARK_MODE_KEY='fabreck_dark_mode';const ADMIN_USERS_KEY='fabreck_admin_users_local';let batteryData=[];let previousBatteryData=[];let activityData=[];let warrantyInstructions={};let rulesShown=localStorage.getItem('rulesShown')==='true';let analysisMode='single';let analyzingBatteryId=null;let batchAnalysisIds=[];let batchEditFinalizadoIds=[];let editingBatteryId=null;let observationCallback=null;let confirmCallback=null;let tempObservation='';let isDarkMode=localStorage.getItem(DARK_MODE_KEY)==='true';let filterDebounceTimer=null;let whatsappUrl='';let idleTimer=null;let receiptIdsToConfirm=[];let currentReceiptSummaryData=null;let dispatchBatteriesToConfirm=[];let currentDispatchSummaryData=null;let db;let auth;let batteriesCollection;let unsubscribeFromFirestore=null;let unsubscribeGlobalStatus=null;let uniqueClients = []; // Added for autocompletion
let uniqueSalesmen = []; // Added for autocompletion
const batteryModelMap={'A':'FA6AD','B':'FA4D','C':'FA5AD','D':'FA5D','E':'FA5,5D','F':'FA6D','G':'FA7E','H':'FA8AE','I':'FA8E','J':'FA7AE','K':'FA7D'};const userFullNameMap={'JENILTON':'Jenilton Cruz','ALINE BURQUE':'Aline Burque','REGINALDO':'Reginaldo','VIEWER':'Visitante','VIDEO_ANALYSIS':'Análise por Vídeo'};const currentClientDisplay=document.getElementById('currentClient');const currentSalesmanDisplay=document.getElementById('currentSalesman');const receiptLockMessage=document.getElementById('receiptLockMessage');function validateSerialCode(code){return/^\d{4}[A-Za-z]\d{4}$/.test(code)}function parseCode(code){return{week:parseInt(code.substring(0,2)),year:parseInt("20"+code.substring(2,4))}}function getBatteryModelFromCode(code){return code?.length>=5?(batteryModelMap[code[4].toUpperCase()]||'Desconhecido'):'N/A'}function getManufacturingDate(week,year){return new Date(year,0,1+(week-1)*7)}function calculateWarrantyStatus(week,year){const manufDate=getManufacturingDate(week,year);const warrantyEnd=new Date(manufDate);warrantyEnd.setFullYear(warrantyEnd.getFullYear()+1);warrantyEnd.setDate(warrantyEnd.getDate()+7);return new Date()<=warrantyEnd?'warranty':'expired'}function updateWarrantyDebugInfo(code){if(validateSerialCode(code)){const{week,year}=parseCode(code);const manufDate=getManufacturingDate(week,year);const warrantyEnd=new Date(manufDate);warrantyEnd.setFullYear(warrantyEnd.getFullYear()+1);warrantyEnd.setDate(warrantyEnd.getDate()+7);debugManufDate.textContent=manufDate.toLocaleDateString('pt-BR');debugWarrantyEndDate.textContent=warrantyEnd.toLocaleDateString('pt-BR');debugCalculatedStatus.textContent=new Date()<=warrantyEnd?'Em Garantia':'Fora do Prazo';warrantyDebugInfo.style.display='block'}else{warrantyDebugInfo.style.display='none'}}function handleSerialInput(){const code=this.value.trim().toUpperCase();codePreview.textContent=code;codePreview.style.color=validateSerialCode(code)?'var(--fabreck-blue)':'var(--fabreck-danger)';updateWarrantyDebugInfo(code);if(!rulesShown&&code.length>=4&&!validateSerialCode(code)){showRulesModal();rulesShown=true;localStorage.setItem('rulesShown','true')}}function clearCode(){serialCodeInput.value='';codePreview.textContent='';warrantyDebugInfo.style.display='none';serialCodeInput.focus()}async function initializeCredentials(){const initialAdmins=[{user:'JENILTON',pass:'32582190'},{user:'REGINALDO',pass:'123456'},{user:'ALINE BURQUE',pass:'123'}];let currentAdmins=JSON.parse(localStorage.getItem(ADMIN_USERS_KEY)||'[]');let updated=!1;initialAdmins.forEach(defaultUser=>{if(!currentAdmins.some(admin=>admin.user===defaultUser.user)){currentAdmins.push(defaultUser);updated=!0}});if(updated){localStorage.setItem(ADMIN_USERS_KEY,JSON.stringify(currentAdmins));console.log('Lista de administradores locais atualizada com utilizadores padrão em falta.')}else{console.log('Credenciais de administrador locais já existem e estão completas.')}}function debounce(func, delay){let timeoutId;return function(...args){clearTimeout(timeoutId);timeoutId=setTimeout(()=>{func.apply(this,args);},delay);};}async function updateGlobalStatusFromInput(){if(document.querySelector('.page.active')?.id!=='scanPage'||sessionStorage.getItem('userType')!=='admin'){return;}const client=clientNameInput.value.trim().toUpperCase();const salesman=salesmanNameInput.value.trim().toUpperCase();try{const globalDocRef=doc(db,"batteries",GLOBAL_ACTIVE_ID);await setDoc(globalDocRef,{lastClient:client,lastSalesman:salesman,timestamp:new Date().toISOString()},{merge:true});}catch(error){console.error("Erro ao atualizar status global em tempo real:",error);}}const debouncedUpdateGlobalStatus=debounce(updateGlobalStatusFromInput,500);async function loadLastUsedData(){const lastType=localStorage.getItem(LAST_WARRANTY_TYPE_KEY)||'factory';selectWarrantyType(lastType);}function updateActivityLog(){if(!activityLog)return;const sortedActivities=[...activityData].reverse();activityLog.innerHTML=sortedActivities.map(activity=>`<div class="activity-item"><div class="activity-icon"><i class="${activity.icon}"></i></div><div class="activity-content">${activity.message}</div><div class="activity-time">${activity.time}</div></div>`).join('')}async function handleRestoreFile(file){const reader=new FileReader();reader.onload=async function(event){try{const data=JSON.parse(event.target.result);if(!Array.isArray(data))throw new Error('Formato de ficheiro inválido. Esperava-se uma lista de baterias.');const batch=writeBatch(db);let count=0;data.forEach(battery=>{const docRef=doc(batteriesCollection);batch.set(docRef,battery);count++});await batch.commit();showNotification(`${count} registos restaurados com sucesso para a nuvem!`, 'success');addActivity('fas fa-cloud-upload-alt',`Restauração concluída: ${count} baterias importadas.`);}catch(error){console.error("Erro ao importar dados:",error);showNotification(`Falha na restauração: ${error.message}`,'error');}};reader.readAsText(file);}async function exportData(){if(batteryData.length===0)return showNotification('Não há dados na nuvem para exportar.','warning');const dataToExport=batteryData.map(b=>({...b}));const jsonString=JSON.stringify(dataToExport,null,2);const blob=new Blob([jsonString],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`fabreck_backup_${new Date().toISOString().slice(0,10)}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);showNotification(`Exportação de ${batteryData.length} registos concluída.`, 'success');addActivity('fas fa-download','Backup de todos os dados exportado.');}async function clearData(){try{const docsSnapshot=await getDocs(batteriesCollection);const batch=writeBatch(db);docsSnapshot.docs.forEach(doc=>{if(doc.id!==GLOBAL_ACTIVE_ID){batch.delete(doc.ref)}});await batch.commit();batteryData=[];showNotification('Todos os dados de garantia foram apagados da nuvem.', 'success');addActivity('fas fa-bomb','Limpeza completa dos dados da nuvem.');}catch(error){console.error("Erro ao apagar dados:",error);showNotification("Erro ao apagar dados da nuvem.","error");}}
// --- Funções para a Página de Análise ---
function renderAnalysisTableRow(battery) {
    const warrantyStatus = battery.warranty_period_status === 'warranty' ? '<span class="status-badge status-warranty">Em Garantia</span>' : '<span class="status-badge status-expired">Fora do Prazo</span>';
    return `
        <tr>
            <td><input type="checkbox" class="analysis-checkbox" data-id="${battery.id}"></td>
            <td>${battery.operationCode || '-'}</td>
            <td>${battery.code}</td>
            <td>${battery.client}</td>
            <td>${battery.batteryModel}</td>
            <td>${new Date(battery.submissionDate).toLocaleDateString('pt-BR')}</td>
            <td>${warrantyStatus}</td>
            <td class="actions-cell">
                <button class="analyze-btn btn btn-warning" data-id="${battery.id}" style="padding: 8px 12px; width: auto; margin: 0 5px 0 0;"><i class="fas fa-search"></i> Analisar</button>
                <button class="revert-to-receipt-btn btn btn-danger" data-id="${battery.id}" style="padding: 8px 12px; width: auto; margin: 0;"><i class="fas fa-undo"></i></button>
            </td>
        </tr>
    `;
}
function updateBatchAnalyzeButtonState() {
    const selectedCount = document.querySelectorAll('.analysis-checkbox:checked').length;
    batchAnalyzeBtn.disabled = selectedCount === 0;
    if (batchAnalyzeBtn.disabled) {
        batchAnalyzeBtn.innerHTML = `<i class="fas fa-layer-group"></i> Analisar Selecionados`;
    } else {
        batchAnalyzeBtn.innerHTML = `<i class="fas fa-layer-group"></i> Analisar Selecionados (${selectedCount})`;
    }
}
function handleSelectAllAnalysis() {
    const isChecked = selectAllAnalysisCheckbox.checked;
    document.querySelectorAll('.analysis-checkbox').forEach(cb => cb.checked = isChecked);
    updateBatchAnalyzeButtonState();
}
function openSingleAnalysisModal(batteryId) {
    analysisMode = 'single';
    analyzingBatteryId = batteryId;
    batchAnalysisIds = [];
    const battery = batteryData.find(b => b.id === batteryId);
    if (!battery) return showNotification('Bateria não encontrada.','error');

    analysisModalTitle.textContent = `Analisar Bateria: ${battery.code}`;
    analysisClientName.textContent = battery.client;
    analysisSalesmanName.textContent = battery.salesman;
    analysisBatteryModel.textContent = battery.batteryModel;
    analysisWarrantyStatus.innerHTML = battery.warranty_period_status === 'warranty' ? '<span class="status-badge status-warranty">Em Garantia</span>' : '<span class="status-badge status-expired">Fora do Prazo</span>';
    
    // Clear previous state
    analysisApprovedRadio.checked = false;
    analysisRejectedRadio.checked = false;
    analysisApprovedRadioContainer.classList.remove('selected');
    analysisRejectedRadioContainer.classList.remove('selected');
    analysisRecommendation.value = '';
    analysisFinalAction.innerHTML = '<option value="">-- Selecione o diagnóstico primeiro --</option>';
    analysisFinalAction.disabled = true;

    // Load existing data if available
    if (battery.recommendation) {
        analysisRecommendation.value = battery.recommendation;
        if (battery.finalAction) {
            const diagnosis = battery.finalAction.includes('PROCEDENTE') ? 'approved' : (battery.finalAction.includes('IMPROCEDENTE') || battery.finalAction.includes('REPROVADA') ? 'rejected' : '');
            if (diagnosis) {
                document.getElementById(`analysis${diagnosis.charAt(0).toUpperCase() + diagnosis.slice(1)}Radio`).checked = true;
                document.getElementById(`analysis${diagnosis.charAt(0).toUpperCase() + diagnosis.slice(1)}RadioContainer`).classList.add('selected');
                handleDiagnosisChange(diagnosis, false);
                analysisFinalAction.value = battery.finalAction;
            }
        }
    }

    // Set up button event listener (re-attached to prevent multiple listeners)
    saveAnalysisBtn.onclick = saveAnalysis;
    
    analysisModal.classList.add('active');
}
function openBatchAnalysisModal() {
    batchAnalysisIds = Array.from(document.querySelectorAll('.analysis-checkbox:checked')).map(cb => cb.dataset.id);
    if (batchAnalysisIds.length === 0) return showNotification('Selecione pelo menos uma bateria.','error');
    
    analysisMode = 'batch';
    analyzingBatteryId = null; 

    analysisModalTitle.textContent = `Analisar ${batchAnalysisIds.length} Baterias em Lote`;
    analysisSingleInfo.style.display = 'none';

    // Clear previous state
    analysisApprovedRadio.checked = false;
    analysisRejectedRadio.checked = false;
    analysisApprovedRadioContainer.classList.remove('selected');
    analysisRejectedRadioContainer.classList.remove('selected');
    analysisRecommendation.value = '';
    analysisFinalAction.innerHTML = '<option value="">-- Selecione o diagnóstico primeiro --</option>';
    analysisFinalAction.disabled = true;

    // Change button to batch save function
    saveAnalysisBtn.onclick = saveBatchAnalysis;

    analysisModal.classList.add('active');
}
function handleDiagnosisChange(diagnosis, autofill = true) {
    const isApproved = diagnosis === 'approved';
    analysisApprovedRadio.checked = isApproved;
    analysisRejectedRadio.checked = !isApproved;
    analysisApprovedRadioContainer.classList.toggle('selected', isApproved);
    analysisRejectedRadioContainer.classList.toggle('selected', !isApproved);

    analysisFinalAction.disabled = false;
    analysisFinalAction.innerHTML = '<option value="">-- Selecione a Ação Final --</option>';

    if (isApproved) {
        analysisFinalAction.innerHTML += '<option value="PROCEDENTE (ENVIAR NOVA)">PROCEDENTE (ENVIAR NOVA)</option>';
        analysisFinalAction.innerHTML += '<option value="IMPROCEDENTE (CORTESIA)">IMPROCEDENTE (CORTESIA)</option>';
    } else {
        analysisFinalAction.innerHTML += '<option value="REPROVADA - FORA DO PRAZO">REPROVADA - FORA DO PRAZO</option>';
        analysisFinalAction.innerHTML += '<option value="IMPROCEDENTE (DEVOLVER)">IMPROCEDENTE (DEVOLVER)</option>';
        analysisFinalAction.innerHTML += '<option value="REPROVADA (MAU USO / SUCATEAR)">REPROVADA (MAU USO / SUCATEAR)</option>';
    }

    if (autofill) {
        autoFillRecommendation();
    }
}
function autoFillRecommendation() {
    const action = analysisFinalAction.value;
    switch (action) {
        case 'PROCEDENTE (ENVIAR NOVA)':
            analysisRecommendation.value = 'PROCEDENTE - DEFEITO DE FÁBRICA. ENVIAR NOVA.';
            break;
        case 'IMPROCEDENTE (CORTESIA)':
            analysisRecommendation.value = 'IMPROCEDENTE - BATERIA DESCARREGADA. CORTESIA CONCEDIDA.';
            break;
        case 'REPROVADA - FORA DO PRAZO':
            analysisRecommendation.value = 'REPROVADA - GARANTIA EXPIRADA, FORA DO PRAZO DE 1 ANO.';
            break;
        case 'IMPROCEDENTE (DEVOLVER)':
            analysisRecommendation.value = 'IMPROCEDENTE - BATERIA DESCARREGADA. DEVOLVER AO CLIENTE.';
            break;
        case 'REPROVADA (MAU USO / SUCATEAR)':
            analysisRecommendation.value = 'REPROVADA - FALHA POR MAU USO/APLICAÇÃO INCORRETA. SUCATEAR.';
            break;
        default:
            analysisRecommendation.value = '';
    }
}
async function saveAnalysis() {
    const recommendation = analysisRecommendation.value.trim();
    const finalAction = analysisFinalAction.value;
    const currentUser = sessionStorage.getItem('currentUser') || 'unknown';

    if (!recommendation || !finalAction) {
        return showNotification('Preencha o Parecer Técnico e a Ação Comercial Final.','error');
    }

    try {
        const docRef = doc(db, "batteries", analyzingBatteryId);
        await updateDoc(docRef, {
            status: 'finalized',
            recommendation: recommendation,
            finalAction: finalAction,
            technicalOpinionDate: new Date().toISOString(),
            analyzedBy: currentUser
        });

        addActivity('fas fa-clipboard-check', `Bateria ${batteryData.find(b => b.id === analyzingBatteryId)?.code} finalizada.`);
        analysisModal.classList.remove('active');
        showNotification('Análise salva e garantia finalizada!', 'success');
        
    } catch (error) {
        console.error("Erro ao salvar análise:", error);
        showNotification("Erro ao salvar análise. Tente novamente.", "error");
    }
}
async function saveBatchAnalysis() {
    const recommendation = analysisRecommendation.value.trim();
    const finalAction = analysisFinalAction.value;
    const currentUser = sessionStorage.getItem('currentUser') || 'unknown';
    const batchSize = batchAnalysisIds.length;

    if (!recommendation || !finalAction) {
        return showNotification('Preencha o Parecer Técnico e a Ação Comercial Final para o lote.','error');
    }

    try {
        const batch = writeBatch(db);
        const updateData = {
            status: 'finalized',
            recommendation: recommendation,
            finalAction: finalAction,
            technicalOpinionDate: new Date().toISOString(),
            analyzedBy: currentUser
        };

        batchAnalysisIds.forEach(id => {
            const docRef = doc(db, "batteries", id);
            batch.update(docRef, updateData);
        });

        await batch.commit();

        addActivity('fas fa-layer-group', `${batchSize} baterias analisadas em lote.`);
        analysisModal.classList.remove('active');
        showNotification(`${batchSize} análises salvas e finalizadas!`, 'success');
        
    } catch (error) {
        console.error("Erro ao salvar análise em lote:", error);
        showNotification("Erro ao salvar análise em lote. Tente novamente.", "error");
    }
}
async function revertToReceipt(batteryId) {
    try {
        const docRef = doc(db, "batteries", batteryId);
        await updateDoc(docRef, {
            status: 'awaiting_receipt',
            receiptDate: null,
            receivedBy: null,
            operationCode: '',
        });
        addActivity('fas fa-undo', `Bateria ${batteryData.find(b => b.id === batteryId)?.code} voltou para fila de recebimento.`);
        showNotification('Bateria revertida para Recebimento.', 'info');
    } catch (error) {
        console.error("Erro ao reverter:", error);
        showNotification("Erro ao reverter bateria. Tente novamente.", "error");
    }
}

// --- Funções para a Página de Recebimento ---
function updateBatchReceiptButtonState() {
    const selectedCount = document.querySelectorAll('.receipt-checkbox:checked').length;
    batchReceiptBtn.disabled = selectedCount === 0;
    if (batchReceiptBtn.disabled) {
        batchReceiptBtn.innerHTML = `<i class="fas fa-check-double"></i> Confirmar Recebidos`;
    } else {
        batchReceiptBtn.innerHTML = `<i class="fas fa-check-double"></i> Confirmar Recebidos (${selectedCount})`;
    }
}
function showReceiptSummary(clientName, batteries) {
    currentReceiptSummaryData = { clientName, clientBatteries: batteries };
    receiptSummaryTitle.textContent = `Resumo para Recebimento: ${clientName}`;

    let summaryHtml = `
        <p><strong>Cliente:</strong> ${clientName}</p>
        <p><strong>Vendedor:</strong> ${batteries[0]?.salesman || 'N/A'}</p>
        <p><strong>Total de Baterias:</strong> ${batteries.length}</p>
        <hr style="margin: 10px 0;">
        <p><strong>Resumo por Modelo:</strong></p>
        <ul>
    `;

    const modelSummary = batteries.reduce((acc, battery) => {
        const model = battery.batteryModel || 'N/A';
        acc[model] = (acc[model] || 0) + 1;
        return acc;
    }, {});

    for (const [model, count] of Object.entries(modelSummary).sort((a, b) => a[0].localeCompare(b[0]))) {
        summaryHtml += `<li>- ${model}: ${count} unidade(s)</li>`;
    }

    summaryHtml += '</ul>';

    receiptSummaryBody.innerHTML = summaryHtml;
    receiptSummaryModal.classList.add('active');
}
function openReceiptConfirmModal(ids) {
    receiptIdsToConfirm = ids;
    const isBatch = ids.length > 1;
    receiptConfirmTitle.textContent = isBatch ? `Confirmar Recebimento de ${ids.length} Baterias` : 'Confirmar Recebimento';
    receiptOperationCode.value = '';

    if (isBatch) {
        receiptBatteryInfo.style.display = 'block';
        const clientName = batteryData.find(b => b.id === ids[0])?.client || 'Lote';
        receiptBatteryInfo.innerHTML = `Lote de <strong>${ids.length} baterias</strong> do cliente <strong>${clientName}</strong>.`;
        // Para lote, o código de operação deve ser único para o lote
        receiptOperationCode.placeholder = 'Insira Cód. Op. ÚNICO p/ o lote';
    } else {
        receiptBatteryInfo.style.display = 'block';
        const battery = batteryData.find(b => b.id === ids[0]);
        receiptBatteryInfo.innerHTML = `Confirme o recebimento da bateria <strong>${battery?.code}</strong> (${battery?.batteryModel}) - Cliente: <strong>${battery?.client}</strong>.`;
        // Para item único, o código de operação pode ser o existente se já houver algum
        receiptOperationCode.value = battery?.operationCode || '';
        receiptOperationCode.placeholder = 'Insira o código da operação (obrigatório)';
    }

    receiptConfirmModal.classList.add('active');
}
async function confirmReceipt(ids) {
    const operationCode = receiptOperationCode.value.trim().toUpperCase();
    const currentUser = sessionStorage.getItem('currentUser') || 'unknown';

    if (!operationCode) {
        return showNotification('O Código de Operação é obrigatório.','error');
    }

    try {
        const batch = writeBatch(db);
        const receiptDate = new Date().toISOString();

        ids.forEach(id => {
            const docRef = doc(db, "batteries", id);
            batch.update(docRef, {
                status: 'in_analysis',
                operationCode: operationCode,
                receiptDate: receiptDate,
                receivedBy: currentUser
            });
        });

        await batch.commit();

        const successMessage = ids.length > 1 
            ? `${ids.length} baterias recebidas e movidas para Análise!`
            : `Bateria ${batteryData.find(b => b.id === ids[0])?.code} recebida e movida para Análise!`;

        addActivity('fas fa-dolly', successMessage);
        receiptConfirmModal.classList.remove('active');
        showNotification(successMessage, 'success');
        
        // Uncheck all checkboxes
        document.querySelectorAll('.receipt-checkbox').forEach(cb => cb.checked = false);
        selectAllReceiptCheckbox.checked = false;
        updateBatchReceiptButtonState();

    } catch (error) {
        console.error("Erro ao confirmar recebimento:", error);
        showNotification("Erro ao salvar o recebimento. Tente novamente.", "error");
    }
}

// --- Funções para a Página de Finalizadas ---
function renderFinalizadoTableRow(battery) {
    const actionClass = battery.finalAction?.includes('PROCEDENTE') ? 'action-approved' : 
                        (battery.finalAction?.includes('IMPROCEDENTE (CORTESIA)') ? 'action-courtesy' :
                        (battery.finalAction?.includes('IMPROCEDENTE') ? 'action-rejected' :
                        (battery.finalAction?.includes('REPROVADA') ? 'action-rejected' : 'action-scrapped')));
    
    return `
        <tr>
            <td class="jenilton-only"><input type="checkbox" class="finalizado-checkbox" data-id="${battery.id}"></td>
            <td>${battery.operationCode || '-'}</td>
            <td>${battery.code}</td>
            <td>${battery.client}</td>
            <td>${battery.technicalOpinionDate ? new Date(battery.technicalOpinionDate).toLocaleDateString('pt-BR') : '-'}</td>
            <td><span class="status-badge ${actionClass}">${battery.finalAction || '-'}</span></td>
            <td title="${battery.recommendation || '-'}">${(battery.recommendation || '-').substring(0, 30)}...</td>
            <td class="actions-cell jenilton-only">
                <button class="name-edit-btn btn btn-info" data-id="${battery.id}" style="padding: 8px 12px; width: auto; margin: 0 5px 0 0;" title="Editar Cliente/Vendedor"><i class="fas fa-user-edit"></i></button>
                <button class="return-to-analysis-btn btn btn-warning" data-id="${battery.id}" style="padding: 8px 12px; width: auto; margin: 0 5px 0 0;" title="Retornar para Análise"><i class="fas fa-redo"></i></button>
                <button class="remove-btn btn btn-danger" data-id="${battery.id}" style="padding: 8px 12px; width: auto; margin: 0;" title="Remover Definitivamente"><i class="fas fa-times-circle"></i></button>
            </td>
        </tr>
    `;
}
async function returnToAnalysis(batteryId) {
    try {
        const docRef = doc(db, "batteries", batteryId);
        await updateDoc(docRef, {
            status: 'in_analysis',
            recommendation: '',
            finalAction: '',
            technicalOpinionDate: null,
            analyzedBy: null
        });
        addActivity('fas fa-redo', `Bateria ${batteryData.find(b => b.id === batteryId)?.code} retornada para análise.`);
        showNotification('Bateria retornada para a fila de Análise.', 'info');
    } catch (error) {
        console.error("Erro ao reverter para análise:", error);
        showNotification("Erro ao reverter bateria. Tente novamente.", "error");
    }
}
async function removeBattery(batteryId) {
    try {
        const docRef = doc(db, "batteries", batteryId);
        const code = batteryData.find(b => b.id === batteryId)?.code;
        await deleteDoc(docRef);
        addActivity('fas fa-times-circle', `Bateria ${code} removida permanentemente.`);
        showNotification(`Bateria ${code} removida da nuvem.`, 'danger');
    } catch (error) {
        console.error("Erro ao remover bateria:", error);
        showNotification("Erro ao remover bateria. Tente novamente.", "error");
    }
}
function openClientEditModal(batteryId) {
    editingBatteryId = batteryId;
    const battery = batteryData.find(b => b.id === batteryId);
    if (!battery) return showNotification('Bateria não encontrada.','error');

    editClientNameInput.value = battery.client;
    editSalesmanNameInput.value = battery.salesman;
    editClientPhoneInput.value = battery.clientPhone || '';

    // Set up button listener (removed to prevent duplicates, will re-attach)
    saveClientEditBtn.onclick = saveEditedClientData;

    clientEditModal.classList.add('active');
}
async function saveEditedClientData() {
    const newClientName = editClientNameInput.value.trim().toUpperCase();
    const newSalesmanName = editSalesmanNameInput.value.trim().toUpperCase();
    const newClientPhone = editClientPhoneInput.value.trim();

    if (!newClientName || !newSalesmanName) {
        return showNotification('Nome do Cliente e Vendedor são obrigatórios.','error');
    }

    try {
        // Encontrar o nome do cliente antigo (chave de busca)
        const oldClientName = batteryData.find(b => b.id === editingBatteryId)?.client;
        if (!oldClientName) throw new Error('Cliente original não encontrado.');

        // 1. Buscar todas as baterias com o cliente antigo
        const q = query(batteriesCollection, where("client", "==", oldClientName));
        const querySnapshot = await getDocs(q);

        // 2. Criar um lote de escrita (batch)
        const batch = writeBatch(db);
        
        querySnapshot.forEach((docSnap) => {
            const docRef = doc(batteriesCollection, docSnap.id);
            batch.update(docRef, {
                client: newClientName,
                salesman: newSalesmanName,
                clientPhone: newClientPhone,
                lastEditedBy: sessionStorage.getItem('currentUser') || 'unknown',
                lastEditedDate: new Date().toISOString()
            });
        });

        // 3. Executar o lote
        await batch.commit();

        addActivity('fas fa-user-edit', `Dados do cliente ${oldClientName} atualizados para ${newClientName} em ${querySnapshot.size} registos.`);
        clientEditModal.classList.remove('active');
        showNotification(`Dados atualizados para ${querySnapshot.size} registos do cliente.`, 'success');
        
    } catch (error) {
        console.error("Erro ao salvar edição de cliente:", error);
        showNotification("Erro ao salvar edição de cliente/vendedor. Tente novamente.", "error");
    }
}
function updateBatchEditFinalizadoButtonState() {
    const selectedCount = document.querySelectorAll('.finalizado-checkbox:checked').length;
    batchEditFinalizadoBtn.disabled = selectedCount === 0;
    if (batchEditFinalizadoBtn.disabled) {
        batchEditFinalizadoBtn.innerHTML = `<i class="fas fa-edit"></i> Alterar Selecionadas`;
    } else {
        batchEditFinalizadoBtn.innerHTML = `<i class="fas fa-edit"></i> Alterar Selecionadas (${selectedCount})`;
    }
}
function handleSelectAllFinalizado() {
    const isChecked = selectAllFinalizadoCheckbox.checked;
    document.querySelectorAll('.finalizado-checkbox').forEach(cb => cb.checked = isChecked);
    updateBatchEditFinalizadoButtonState();
}
function openBatchEditFinalizadoModal() {
    batchEditFinalizadoIds = Array.from(document.querySelectorAll('.finalizado-checkbox:checked')).map(cb => cb.dataset.id);
    if (batchEditFinalizadoIds.length === 0) return showNotification('Selecione pelo menos uma bateria.','error');
    
    // Clear previous state
    batchEditApprovedRadio.checked = false;
    batchEditRejectedRadio.checked = false;
    batchEditApprovedRadioContainer.classList.remove('selected');
    batchEditRejectedRadioContainer.classList.remove('selected');
    batchEditRecommendation.value = '';
    batchEditFinalAction.innerHTML = '<option value="">-- Selecione o diagnóstico primeiro --</option>';
    batchEditFinalAction.disabled = true;

    batchEditFinalizadoModal.classList.add('active');
}
function handleBatchEditDiagnosisChange(diagnosis) {
    const isApproved = diagnosis === 'approved';
    batchEditApprovedRadio.checked = isApproved;
    batchEditRejectedRadio.checked = !isApproved;
    batchEditApprovedRadioContainer.classList.toggle('selected', isApproved);
    batchEditRejectedRadioContainer.classList.toggle('selected', !isApproved);

    batchEditFinalAction.disabled = false;
    batchEditFinalAction.innerHTML = '<option value="">-- Selecione a Nova Ação Final --</option>';

    if (isApproved) {
        batchEditFinalAction.innerHTML += '<option value="PROCEDENTE (ENVIAR NOVA)">PROCEDENTE (ENVIAR NOVA)</option>';
        batchEditFinalAction.innerHTML += '<option value="IMPROCEDENTE (CORTESIA)">IMPROCEDENTE (CORTESIA)</option>';
    } else {
        batchEditFinalAction.innerHTML += '<option value="REPROVADA - FORA DO PRAZO">REPROVADA - FORA DO PRAZO</option>';
        batchEditFinalAction.innerHTML += '<option value="IMPROCEDENTE (DEVOLVER)">IMPROCEDENTE (DEVOLVER)</option>';
        batchEditFinalAction.innerHTML += '<option value="REPROVADA (MAU USO / SUCATEAR)">REPROVADA (MAU USO / SUCATEAR)</option>';
    }
    
    autoFillBatchEditRecommendation();
}
function autoFillBatchEditRecommendation() {
    const action = batchEditFinalAction.value;
    switch (action) {
        case 'PROCEDENTE (ENVIAR NOVA)':
            batchEditRecommendation.value = 'PROCEDENTE - DEFEITO DE FÁBRICA. ENVIAR NOVA.';
            break;
        case 'IMPROCEDENTE (CORTESIA)':
            batchEditRecommendation.value = 'IMPROCEDENTE - BATERIA DESCARREGADA. CORTESIA CONCEDIDA.';
            break;
        case 'REPROVADA - FORA DO PRAZO':
            batchEditRecommendation.value = 'REPROVADA - GARANTIA EXPIRADA, FORA DO PRAZO DE 1 ANO.';
            break;
        case 'IMPROCEDENTE (DEVOLVER)':
            batchEditRecommendation.value = 'IMPROCEDENTE - BATERIA DESCARREGADA. DEVOLVER AO CLIENTE.';
            break;
        case 'REPROVADA (MAU USO / SUCATEAR)':
            batchEditRecommendation.value = 'REPROVADA - FALHA POR MAU USO/APLICAÇÃO INCORRETA. SUCATEAR.';
            break;
        default:
            batchEditRecommendation.value = '';
    }
}
async function saveBatchEditedFinalizado() {
    const recommendation = batchEditRecommendation.value.trim();
    const finalAction = batchEditFinalAction.value;
    const currentUser = sessionStorage.getItem('currentUser') || 'unknown';
    const batchSize = batchEditFinalizadoIds.length;

    if (!recommendation || !finalAction) {
        return showNotification('Preencha o Parecer Técnico e a Ação Comercial Final.','error');
    }

    try {
        const batch = writeBatch(db);
        const updateData = {
            recommendation: recommendation,
            finalAction: finalAction,
            lastEditedBy: currentUser,
            lastEditedDate: new Date().toISOString()
        };

        batchEditFinalizadoIds.forEach(id => {
            const docRef = doc(db, "batteries", id);
            batch.update(docRef, updateData);
        });

        await batch.commit();

        addActivity('fas fa-edit', `${batchSize} garantias finalizadas alteradas em lote.`);
        batchEditFinalizadoModal.classList.remove('active');
        showNotification(`${batchSize} garantias alteradas com sucesso!`, 'success');

        // Uncheck all checkboxes
        document.querySelectorAll('.finalizado-checkbox').forEach(cb => cb.checked = false);
        selectAllFinalizadoCheckbox.checked = false;
        updateBatchEditFinalizadoButtonState();
        
    } catch (error) {
        console.error("Erro ao salvar edição em lote:", error);
        showNotification("Erro ao salvar edição em lote. Tente novamente.", "error");
    }
}

// --- Funções para a Página de Expedição ---
function showDispatchSummary(clientName, batteries) {
    currentDispatchSummaryData = { clientName, batteries };
    dispatchSummaryTitle.textContent = `Resumo para Expedição: ${clientName}`;

    let summaryHtml = `
        <p><strong>Cliente:</strong> ${clientName}</p>
        <p><strong>Vendedor:</strong> ${batteries[0]?.salesman || 'N/A'}</p>
        <p><strong>Total de Baterias a Enviar:</strong> ${batteries.length}</p>
        <hr style="margin: 10px 0;">
        <p><strong>Resumo de Ações e Modelos:</strong></p>
        <ul>
    `;

    const summary = batteries.reduce((acc, battery) => {
        const key = `${battery.finalAction} | ${battery.batteryModel}`;
        acc[key] = (acc[key] || 0) + 1;
        return acc;
    }, {});

    for (const [key, count] of Object.entries(summary).sort((a, b) => a[0].localeCompare(b[0]))) {
        summaryHtml += `<li>- ${key} (Cód. Op.: ${batteries.find(b => `${b.finalAction} | ${b.batteryModel}` === key)?.operationCode || '-'}): ${count} unidade(s)</li>`;
    }

    summaryHtml += '</ul>';
    dispatchSummaryBody.innerHTML = summaryHtml;
    dispatchSummaryModal.classList.add('active');
}
function openDispatchConfirmModal(batteries) {
    dispatchBatteriesToConfirm = batteries;
    const clientName = batteries[0]?.client || 'Lote';
    dispatchConfirmTitle.textContent = `Finalizar Expedição para ${clientName}`;
    dispatchOSCode.value = '';

    dispatchConfirmModal.classList.add('active');
}
async function confirmDispatch(batteries) {
    const orderId = dispatchOSCode.value.trim().toUpperCase();
    const currentUser = sessionStorage.getItem('currentUser') || 'unknown';

    if (!orderId) {
        return showNotification('A Ordem de Serviço (O.S.) é obrigatória.','error');
    }

    try {
        const batch = writeBatch(db);
        const dispatchDate = new Date().toISOString();

        batteries.forEach(battery => {
            const docRef = doc(db, "batteries", battery.id);
            batch.update(docRef, {
                dispatchOrderId: orderId,
                dispatchDate: dispatchDate,
                dispatchedBy: currentUser
            });
        });

        await batch.commit();

        generateDispatchPDF(orderId, batteries);

        addActivity('fas fa-truck', `${batteries.length} baterias expedidas com O.S. ${orderId}.`);
        dispatchConfirmModal.classList.remove('active');
        showNotification(`${batteries.length} baterias prontas para envio! Pedido de Expedição gerado.`, 'success');
        
    } catch (error) {
        console.error("Erro ao confirmar expedição:", error);
        showNotification("Erro ao finalizar expedição. Tente novamente.", "error");
    }
}


async function init(){const APP_VERSION="1.2.4";const appVersionLogin=document.getElementById('appVersionLogin');if(appVersionLogin)appVersionLogin.textContent=`Versão ${APP_VERSION}`;const appVersionSidebar=document.getElementById('appVersionSidebar');if(appVersionSidebar)appVersionSidebar.textContent=APP_VERSION;const appVersionSettings=document.getElementById('appVersionSettings');if(appVersionSettings)appVersionSettings.textContent=APP_VERSION;console.log("A preparar a aplicação...");setupEventListeners();const firebasePromise=initializeCredentials().then(()=>initFirebase());const timerPromise=new Promise(resolve=>setTimeout(resolve,3000));try{await Promise.all([firebasePromise,timerPromise]);const loadingOverlay=document.getElementById('loadingOverlay');if(loadingOverlay){loadingOverlay.style.opacity='0';setTimeout(()=>{loadingOverlay.style.display='none';document.body.classList.add('loaded');},500)}checkAuth();loadModules();}catch(error){console.error("Erro CRÍTICO durante a inicialização:",error);showNotification("Erro crítico ao iniciar o sistema. Verifique o console.","error");const loadingOverlay=document.getElementById('loadingOverlay');if(loadingOverlay)loadingOverlay.style.display='none';}}function setupRequirementsModal(){const rulesModal=document.getElementById('rulesModal');const closeRulesModal=document.getElementById('closeRulesModal');const modalTitle=rulesModal.querySelector('.modal-title');const container=rulesModal.querySelector('.rules-list').parentNode;modalTitle.textContent="Requisitos para Análise de Garantia";container.innerHTML=`
                <ul class="rules-list">
                    <li>O código de série deve ser <span class="rules-highlight">válido</span> (4 N, 1 L, 4 N).</li>
                    <li>A bateria deve estar <span class="rules-highlight">dentro do prazo</span> de 1 ano de garantia.</li>
                    <li>O Cliente e Vendedor devem estar <span class="rules-highlight">registados</span> corretamente.</li>
                    <li>Para baterias Físicas (Fábrica), o Cód. Operação e Recebimento são <span class="rules-highlight">obrigatórios</span>.</li>
                    <li>Para Análise por Vídeo, o Parecer Técnico é <span class="rules-highlight">obrigatório</span> na hora do registo.</li>
                </ul>
                <button class="btn btn-primary" id="confirmRequirements" style="width: 100%;">Entendi</button>
            `;const confirmRequirementsBtn=document.getElementById('confirmRequirements');closeRulesModal.onclick=()=>rulesModal.classList.remove('active');if(confirmRequirementsBtn){confirmRequirementsBtn.onclick=()=>rulesModal.classList.remove('active');}window.openRequirementsModal=function(){rulesModal.classList.add('active');};}async function loadModules(){try{setupRequirementsModal();showRequirementsBtn.addEventListener('click',window.openRequirementsModal);helpBtn.addEventListener('click',window.openRequirementsModal);}catch(error){console.error("Erro ao carregar módulos de requisitos:",error);}}async function initializeAppData(){await loadLastUsedData();applyDarkMode();const today=new Date();const year=today.getFullYear();const month=String(today.getMonth()+1).padStart(2,'0');const day=String(today.getDate()).padStart(2,'0');submissionDateInput.value=`${year}-${month}-${day}`;const storedActivities=localStorage.getItem(ACTIVITY_DATA_KEY);activityData=storedActivities?JSON.parse(storedActivities):[];updateActivityLog()}function resetIdleTimer(){clearTimeout(idleTimer);if(sessionStorage.getItem('isAuthenticated')!=='true'){idleTimer=setTimeout(showScreensaver,60000)}}function showScreensaver(){const screensaver=document.getElementById('screensaverOverlay');const loginCard=document.querySelector('.login-card');if(screensaver&&loginCard){screensaver.style.opacity='1';screensaver.style.pointerEvents='auto';loginCard.style.opacity='0';loginCard.style.pointerEvents='none';clearTimeout(idleTimer)}}function hideScreensaver(reset=true){const screensaver=document.getElementById('screensaverOverlay');const loginCard=document.querySelector('.login-card');if(screensaver&&loginCard){screensaver.style.opacity='0';loginCard.style.opacity='1';loginCard.style.pointerEvents='auto'}if(reset){resetIdleTimer()}}function checkAuth(){if(sessionStorage.getItem('isAuthenticated')==='true'){const user=sessionStorage.getItem('currentUser');if(currentUserDisplay){currentUserDisplay.textContent=userFullNameMap[user.toUpperCase()]||user}clearTimeout(idleTimer);loginOverlay.classList.add('hidden');layoutContainer.style.visibility='visible';applyUIRestrictions();if(!db)initializeAppData();if(user==='ALINE BURQUE'){showPage('receiptPage')}else if(user==='REGINALDO'){showPage('analysisPage')}else if(user==='JENILTON'){showPage('scanPage')}else{showPage('finalizadoPage')}}else{if(currentUserDisplay){currentUserDisplay.textContent='N/A'}loginOverlay.classList.remove('hidden');hideScreensaver(false);layoutContainer.style.visibility='hidden';resetIdleTimer()}}function handleLogin(e){e.preventDefault();const user=usernameInput.value.trim().toUpperCase();const pass=passwordInput.value.trim();const adminUsersData=JSON.parse(localStorage.getItem(ADMIN_USERS_KEY)||'[]');const foundUser=adminUsersData.find(admin=>admin.user===user&&admin.pass===pass);if(foundUser){sessionStorage.setItem('isAuthenticated','true');sessionStorage.setItem('userType','admin');sessionStorage.setItem('currentUser',user);checkAuth()}else{showNotification('Utilizador ou palavra-passe incorretos.','error')}}function handleViewerLogin(){sessionStorage.setItem('isAuthenticated','true');sessionStorage.setItem('userType','viewer');sessionStorage.setItem('currentUser','VIEWER');checkAuth()}function handleLogout(){sessionStorage.removeItem('isAuthenticated');sessionStorage.removeItem('userType');sessionStorage.removeItem('currentUser');if(unsubscribeFromFirestore){unsubscribeFromFirestore();unsubscribeFromFirestore=null}if(unsubscribeGlobalStatus){unsubscribeGlobalStatus();unsubscribeFromFirestore=null}checkAuth()}async function initFirebase(){let firebaseConfig={apiKey:"AIzaSyAI2t_u1T2f737QkyJ6940Hup-ZY-eYd9E",authDomain:"studio-8037364926-f4af4.firebaseapp.com",projectId:"studio-8037364926-f4af4",storageBucket:"studio-8037364926-f4af4.appspot.com",messagingSenderId:"875276153303",appId:"1:875276153303:web:8d3c060072f2523b11db92"};try{const app=initializeApp(firebaseConfig);db=getFirestore(app);auth=getAuth(app);await new Promise((resolve,reject)=>{const unsubscribe=onAuthStateChanged(auth,(user)=>{unsubscribe();if(user){resolve(user)}else{signInAnonymously(auth).then(resolve).catch(reject)}},reject)});console.log("Firebase e Autenticação Anónima prontos. Utilizador:",auth.currentUser.uid);setConnectionStatus('Online','#2ECC71');batteriesCollection=collection(db,"batteries");setupFirestoreListener();setupGlobalStatusListener();}catch(error){console.error("Erro crítico na inicialização do Firebase:",error);showNotification("Não foi possível ligar à base de dados na nuvem.","error");setConnectionStatus('Offline','#E74C3C')}}function setConnectionStatus(text,color){if(connectionStatus){connectionStatus.textContent=text;connectionStatus.style.color=color}}function applyUIRestrictions(){const user=sessionStorage.getItem('currentUser');const userIsJenilton=user==='JENILTON';const isAline=user==='ALINE BURQUE';const isReginaldo=user==='REGINALDO';document.querySelectorAll('.jenilton-only').forEach(el=>{el.style.display=userIsJenilton?(el.tagName==='TD'||el.tagName==='TH'?'table-cell':''):'none'});document.querySelectorAll('.aline-only').forEach(el=>{el.style.display=isAline?(el.tagName==='TD'||el.tagName==='TH'?'table-cell':''):'none'});document.querySelectorAll('.reginaldo-only').forEach(el=>{el.style.display=isReginaldo?(el.tagName==='TD'||el.tagName==='TH'?'table-cell':''):'none'});document.querySelectorAll('.jenilton-only-nav').forEach(el=>{let shouldShow=false;if(userIsJenilton){shouldShow=true;}else if(el.classList.contains('aline-only')&&isAline){shouldShow=true;}else if(el.classList.contains('reginaldo-only')&&isReginaldo){shouldShow=true;}el.style.display=shouldShow?'':'none';});const allEditableElements=document.querySelectorAll('#scanPage input,#scanPage textarea,#scanPage button,#scanPage .warranty-option,#receiptPage input,#receiptPage select,#receiptPage button,#analysisPage input,#analysisPage select,#analysisPage button,#finalizadoPage .actions-cell button, #finalizadoPage #batchEditFinalizadoBtn, #finalizadoPage .finalizado-checkbox, #finalizadoPage #selectAllFinalizadoCheckbox');allEditableElements.forEach(el=>{if(!el.closest('header')&&!el.closest('.report-filters')&&!el.closest('.filter-buttons')){el.disabled=true}});if(userIsJenilton){allEditableElements.forEach(el=>el.disabled=false)}if(isAline){document.querySelectorAll('#receiptPage input,#receiptPage select,#receiptPage button').forEach(el=>el.disabled=false)}if(isReginaldo){document.querySelectorAll('#analysisPage input,#analysisPage select,#analysisPage button').forEach(el=>el.disabled=false)}document.querySelectorAll('.nav-btn,.sidebar-btn,header button,.report-filters input,.report-filters button,#finalizadoSearchInput,#finalizadoStartDate,#finalizadoEndDate,#finalizadoClearFilterBtn,#finalizadoPdfBtn,#finalizadoExcelBtn,#finalizadoWhatsappBtn').forEach(el=>el.disabled=false)}function updateUI(){updateAutocompleteData();updateAnalysisClientFilter();updateReceiptClientFilter();updateAnalysisSalesmanFilter();updateFinalizadoFilters();updateReceiptTable();updateAnalysisTable();updateFinalizadoTable();updateDispatchPage();updateStats();updateWarrantyInstructionsUI();updateRecentRegistrationsLog();applyUIRestrictions()}function updateAutocompleteData() {
    uniqueClients = [...new Set(batteryData.map(b => b.client).filter(c => c && c.trim() !== ''))].sort();
    uniqueSalesmen = [...new Set(batteryData.map(b => b.salesman).filter(s => s && s.trim() !== ''))].sort();
}
function setupAutocomplete(inputElement, suggestionsElement, sourceArray) {
    inputElement.addEventListener('input', () => {
        const query = inputElement.value.trim().toUpperCase();
        suggestionsElement.innerHTML = '';
        suggestionsElement.classList.add('hidden');

        if (query.length < 2) return;

        const filtered = sourceArray.filter(item => item.includes(query)).slice(0, 10);

        if (filtered.length > 0) {
            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = item;
                div.addEventListener('click', () => {
                    inputElement.value = item;
                    suggestionsElement.classList.add('hidden');
                    // Manually trigger input to update global status
                    inputElement.dispatchEvent(new Event('input', { bubbles: true }));
                });
                suggestionsElement.appendChild(div);
            });
            suggestionsElement.classList.remove('hidden');
        }
    });

    // Hide suggestions when focus leaves the input/suggestions
    document.addEventListener('click', (e) => {
        if (!inputElement.parentElement.contains(e.target)) {
            suggestionsElement.classList.add('hidden');
        }
    });
}
function updateAnalysisClientFilter(){const uniqueClientsInAnalysis=[...new Set(batteryData.filter(b=>b.status==='in_analysis').map(b=>b.client))].sort();const clientOptions=uniqueClientsInAnalysis.map(client=>`<option value="${client}">${client}</option>`).join('');analysisClientFilter.innerHTML='<option value="">Todos os Clientes</option>'+clientOptions}function updateReceiptClientFilter(){const uniqueClients=[...new Set(batteryData.filter(b=>b.status==='awaiting_receipt').map(b=>b.client))].sort();const clientOptions=uniqueClients.map(client=>`<option value="${client}">${client}</option>`).join('');receiptClientFilter.innerHTML='<option value="">Todos os Clientes</option>'+clientOptions}function updateAnalysisSalesmanFilter(){const dataToAnalyze=batteryData.filter(b=>b.status==='in_analysis');const uniqueSalesmen=[...new Set(dataToAnalyze.map(b=>b.salesman))].sort();const salesmanOptions=uniqueSalesmen.map(s=>`<option value="${s}">${s}</option>`).join('');if(analysisSalesmanFilter)analysisSalesmanFilter.innerHTML='<option value="">Todos os Vendedores</option>'+salesmanOptions}function updateFinalizadoFilters(){const finalizadas=batteryData.filter(b=>b.status==='finalized');const uniqueClients=[...new Set(finalizadas.map(b=>b.client))].sort();const clientOptions=uniqueClients.map(client=>`<option value="${client}">${client}</option>`).join('');if(finalizadoClientFilter)finalizadoClientFilter.innerHTML='<option value="">Todos os Clientes</option>'+clientOptions;const uniqueSalesmen=[...new Set(finalizadas.map(b=>b.salesman))].sort();const salesmanOptions=uniqueSalesmen.map(s=>`<option value="${s}">${s}</option>`).join('');if(finalizadoSalesmanFilter)finalizadoSalesmanFilter.innerHTML='<option value="">Todos os Vendedores</option>'+salesmanOptions;const uniqueActions=[...new Set(finalizadas.map(b=>b.finalAction))].sort();const actionOptions=uniqueActions.map(a=>`<option value="${a}">${a}</option>`).join('');if(finalizadoActionFilter)finalizadoActionFilter.innerHTML='<option value="">Todas as Ações</option>'+actionOptions}function updateStats(){const awaitingReceipt=batteryData.filter(b=>b.status==='awaiting_receipt').length;const inAnalysis=batteryData.filter(b=>b.status==='in_analysis').length;const finalized=batteryData.filter(b=>b.status==='finalized');const totalFinalizedCount=finalized.length;if(awaitingReceiptCount)awaitingReceiptCount.textContent=awaitingReceipt;if(inAnalysisCount)inAnalysisCount.textContent=inAnalysis;if(finalizadoCount)finalizadoCount.textContent=totalFinalizedCount;const aprovadaFabricaCount=finalized.filter(b=>b.finalAction==='PROCEDENTE (ENVIAR NOVA)').length;const aprovadaCortesiaCount=finalized.filter(b=>b.finalAction==='IMPROCEDENTE (CORTESIA)').length;const reprovadaForaPrazoCount=finalized.filter(b=>b.finalAction==='REPROVADA - FORA DO PRAZO').length;const reprovadaDevolverCount=finalized.filter(b=>b.finalAction==='IMPROCEDENTE (DEVOLVER)').length;const reprovadaMauUsoSucatearCount=finalized.filter(b=>b.finalAction==='REPROVADA (MAU USO / SUCATEAR)').length;const calculatePercent=(count)=>totalFinalizedCount>0?Math.round((count/totalFinalizedCount)*100):0;if(document.getElementById('finalizadoAprovadaFabricaCount'))document.getElementById('finalizadoAprovadaFabricaCount').textContent=aprovadaFabricaCount;if(document.getElementById('finalizadoAprovadaCortesiaCount'))document.getElementById('finalizadoAprovadaCortesiaCount').textContent=aprovadaCortesiaCount;if(finalizadoReprovadaForaPrazoCountEl)finalizadoReprovadaForaPrazoCountEl.textContent=reprovadaForaPrazoCount;if(finalizadoReprovadaDevolverCountEl)finalizadoReprovadaDevolverCountEl.textContent=reprovadaDevolverCount;if(finalizadoReprovadaMauUsoSucatearCountEl)finalizadoReprovadaMauUsoSucatearCountEl.textContent=reprovadaMauUsoSucatearCount;if(finalizadoTotalPercentEl)finalizadoTotalPercentEl.textContent=`100%`;if(finalizadoAprovadaFabricaPercentEl)finalizadoAprovadaFabricaPercentEl.textContent=`${calculatePercent(aprovadaFabricaCount)}%`;if(finalizadoAprovadaCortesiaPercentEl)finalizadoAprovadaCortesiaPercentEl.textContent=`${calculatePercent(aprovadaCortesiaCount)}%`;if(finalizadoReprovadaForaPrazoPercentEl)finalizadoReprovadaForaPrazoPercentEl.textContent=`${calculatePercent(reprovadaForaPrazoCount)}%`;if(finalizadoReprovadaDevolverPercentEl)finalizadoReprovadaDevolverPercentEl.textContent=`${calculatePercent(reprovadaDevolverCount)}%`;if(finalizadoReprovadaMauUsoSucatearPercentEl)finalizadoReprovadaMauUsoSucatearPercentEl.textContent=`${calculatePercent(reprovadaMauUsoSucatearCount)}%`;}function updateWarrantyInstructionsUI(){warrantyInstructions={approved:'Bateria com defeito de fabricação. Enviar uma nova unidade para o cliente.',rejected_return:'Bateria sem defeito, apenas descarregada ou com falha externa. Devolver ao cliente.',rejected_scrap:'Bateria com falha por mau uso (ex: sobrecarga, caixa danificada) ou fora do prazo. Sucatear.'};warrantyInstructionsContainer.innerHTML=`<p><strong>APROVADA:</strong><br>${warrantyInstructions.approved}</p><hr><p><strong>REPROVADA (DEVOLVER):</strong><br>${warrantyInstructions.rejected_return}</p><hr><p><strong>REPROVADA (SUCATEAR):</strong><br>${warrantyInstructions.rejected_scrap}</p>`}function renderRecentRegistrationRow(battery){return`<tr><td>${battery.operationCode||'-'}</td><td>${battery.code}</td><td>${battery.client}</td><td>${battery.salesman}</td><td>${new Date(battery.timestamp).toLocaleDateString('pt-BR')}</td></tr>`}function updateRecentRegistrationsLog(){const logContainer=document.getElementById('activityLog');const recentActivities=[...batteryData].sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)).slice(0,10);if(recentActivities.length===0){recentRegistrationsBody.innerHTML=`<tr><td colspan="5" style="text-align: center;">Nenhum registo ainda.</td></tr>`;return}recentRegistrationsBody.innerHTML=recentActivities.map(renderRecentRegistrationRow).join('')}function setupFirestoreListener(){if(unsubscribeFromFirestore)unsubscribeFromFirestore();if(!auth.currentUser)return console.log("A aguardar autenticação para iniciar o listener...");setConnectionStatus('A Sincronizar...','#F39C12');unsubscribeFromFirestore=onSnapshot(query(batteriesCollection),(snapshot)=>{const serverData=snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));if(previousBatteryData.length>0){const recentlyFinalized=[];serverData.forEach(currentBattery=>{const previousVersion=previousBatteryData.find(b=>b.id===currentBattery.id);if(previousVersion&&previousVersion.status!=='finalized'&&currentBattery.status==='finalized'){recentlyFinalized.push(currentBattery)}});if(recentlyFinalized.length>0){showFinalizedNotification(recentlyFinalized)}}batteryData=serverData;previousBatteryData=JSON.parse(JSON.stringify(serverData));updateUI();updateLastUpdate();console.log(`Dados sincronizados: ${batteryData.length} registos carregados.`);setConnectionStatus('Online','#2ECC71')},(error)=>{console.error("Erro ao receber dados da nuvem: ",error);showNotification("Falha ao sincronizar. Verifique a sua ligação e as regras de segurança.","error");setConnectionStatus('Offline','#E74C3C')})}function setupGlobalStatusListener(){if(unsubscribeGlobalStatus)unsubscribeGlobalStatus();if(!auth.currentUser)return;const globalDocRef=doc(db,"batteries",GLOBAL_ACTIVE_ID);unsubscribeGlobalStatus=onSnapshot(globalDocRef,(docSnapshot)=>{let client='N/A';let salesman='N/A';if(docSnapshot.exists()){const data=docSnapshot.data();client=data.lastClient&&data.lastClient.trim()!==' ' ?data.lastClient:'N/A';salesman=data.lastSalesman&&data.lastSalesman.trim()!==' ' ?data.lastSalesman:'N/A';}currentClientDisplay.textContent=client;currentSalesmanDisplay.textContent=salesman;console.log(`Status Global Atualizado: Cliente: ${client}, Vendedor: ${salesman}`);const currentPage=document.querySelector('.page.active')?.id;const currentUser=sessionStorage.getItem('currentUser');if((currentPage==='analysisPage'&&currentUser==='ALINE BURQUE')||currentUser==='JENILTON'){updateReceiptTable();}},(error)=>{console.error("Erro ao receber status global da nuvem: ",error);});}function setupEventListeners(){loginForm?.addEventListener('submit',handleLogin);viewerLoginBtn?.addEventListener('click',handleViewerLogin);logoutBtn?.addEventListener('click',handleLogout);const header=document.querySelector('header');const mainContent=document.getElementById('mainContentWrapper');const trigger=document.getElementById('header-scroll-trigger');if(header&&trigger&&mainContent){const headerObserver=new IntersectionObserver(entries=>{entries.forEach(entry=>{header.classList.toggle('minimal',!entry.isIntersecting)})},{root:mainContent,threshold:0.99});headerObserver.observe(trigger)}navBtns.forEach(btn=>btn.addEventListener('click',()=>showPage(btn.getAttribute('data-page'))));sidebarBtns.forEach(btn=>btn.addEventListener('click',e=>{e.preventDefault();showPage(btn.getAttribute('data-page'))}));serialCodeInput?.addEventListener('input',handleSerialInput);serialCodeInput?.addEventListener('keypress',e=>{if(e.key==='Enter')addBattery()});salesmanNameInput?.addEventListener('input',e=>e.target.value=e.target.value.toUpperCase());salesmanNameInput?.addEventListener('blur',()=>{const name=salesmanNameInput.value.trim().toUpperCase();if(name){salesmanNameInput.value=name;}});clientNameInput?.addEventListener('input',e=>e.target.value=e.target.value.toUpperCase());clientNameInput?.addEventListener('blur',()=>{const name=clientNameInput.value.trim().toUpperCase();if(name){clientNameInput.value=name;}});clientNameInput?.addEventListener('input',debouncedUpdateGlobalStatus);salesmanNameInput?.addEventListener('input',debouncedUpdateGlobalStatus);clearFormBtn?.addEventListener('click',clearFullForm);addBtn?.addEventListener('click',addBattery);showRequirementsBtn?.addEventListener('click',window.openRequirementsModal);registerScrapBtn?.addEventListener('click',handleRegisterScrap);factoryOption?.addEventListener('click',()=>selectWarrantyType('factory'));analyzedOption?.addEventListener('click',()=>selectWarrantyType('analyzed'));closeFinalizedNotificationModal?.addEventListener('click',()=>finalizedNotificationModal.classList.remove('active'));closeReceiptSummaryModal?.addEventListener('click',()=>receiptSummaryModal.classList.remove('active'));printReceiptSummaryBtn?.addEventListener('click',generateReceiptSummaryPDF);closeDispatchSummaryModal?.addEventListener('click',()=>dispatchSummaryModal.classList.remove('active'));printDispatchSummaryBtn?.addEventListener('click',generateDispatchSummaryPDF);closeDispatchConfirmModal?.addEventListener('click',()=>dispatchConfirmModal.classList.remove('active'));confirmDispatchBtn?.addEventListener('click',()=>confirmDispatch(dispatchBatteriesToConfirm));dispatchSearchInput?.addEventListener('input',()=>{clearTimeout(filterDebounceTimer);filterDebounceTimer=setTimeout(updateDispatchPage,300)});backupBtn?.addEventListener('click',exportData);restoreBtn?.addEventListener('click',()=>restoreFileInput.click());restoreFileInput?.addEventListener('change',e=>{if(e.target.files.length>0){showConfirmModal('Confirmar Restauração para a Nuvem',`Atenção! Esta ação substituirá TODOS os dados da nuvem pelos dados do ficheiro.`,()=>handleRestoreFile(e.target.files[0]),()=>e.target.value='')}});helpBtn?.addEventListener('click',window.openRequirementsModal);closeRulesModal?.addEventListener('click',()=>rulesModal.classList.remove('active'));confirmRules?.addEventListener('click',()=>rulesModal.classList.remove('active'));receiptSearchInput?.addEventListener('input',debounce(updateReceiptTable,300));receiptClientFilter?.addEventListener('change',updateReceiptTable);analysisSearchInput?.addEventListener('input',debounce(updateAnalysisTable,300));analysisClientFilter?.addEventListener('change',updateAnalysisTable);analysisSalesmanFilter?.addEventListener('change',updateAnalysisTable);finalizadoSearchInput?.addEventListener('input',debounce(updateFinalizadoTable,300));finalizadoClientFilter?.addEventListener('change',updateFinalizadoTable);finalizadoStartDate?.addEventListener('change',updateFinalizadoTable);finalizadoEndDate?.addEventListener('change',updateFinalizadoTable);finalizadoSalesmanFilter?.addEventListener('change',updateFinalizadoTable);finalizadoActionFilter?.addEventListener('change',updateFinalizadoTable);finalizadoClearFilterBtn?.addEventListener('click',()=>{finalizadoSearchInput.value='';finalizadoStartDate.value='';finalizadoEndDate.value='';finalizadoSalesmanFilter.value='';finalizadoActionFilter.value='';finalizadoClientFilter.value='';updateFinalizadoTable();});batchReceiptBtn?.addEventListener('click',()=>{const selectedIds=Array.from(document.querySelectorAll('.receipt-checkbox:checked')).map(cb=>cb.dataset.id);if(selectedIds.length>0){openReceiptConfirmModal(selectedIds)}});selectAllReceiptCheckbox?.addEventListener('change',()=>{document.querySelectorAll('.receipt-checkbox').forEach(cb=>cb.checked=selectAllReceiptCheckbox.checked);updateBatchReceiptButtonState()});closeReceiptConfirmModal?.addEventListener('click',()=>receiptConfirmModal.classList.remove('active'));cancelReceiptConfirmBtn?.addEventListener('click',()=>receiptConfirmModal.classList.remove('active'));confirmReceiptBtn?.addEventListener('click',()=>confirmReceipt(receiptIdsToConfirm));closeAnalysisModal?.addEventListener('click',()=>analysisModal.classList.remove('active'));saveAnalysisBtn?.addEventListener('click',saveAnalysis);selectAllAnalysisCheckbox?.addEventListener('change',handleSelectAllAnalysis);batchAnalyzeBtn?.addEventListener('click',openBatchAnalysisModal);analysisApprovedRadioContainer?.addEventListener('click',()=>handleDiagnosisChange('approved'));analysisRejectedRadioContainer?.addEventListener('click',()=>handleDiagnosisChange('rejected'));analysisFinalAction?.addEventListener('change',autoFillRecommendation);closeClientEditModal?.addEventListener('click',()=>clientEditModal.classList.remove('active'));saveClientEditBtn?.addEventListener('click',saveEditedClientData);closeObservationModal?.addEventListener('click',()=>observationModal.classList.remove('active'));saveObservationBtn?.addEventListener('click',()=>observationCallback?.(observationText.value));procedenteBtn?.addEventListener('click',()=>procedenteModal.classList.add('active'));closeProcedenteModal?.addEventListener('click',()=>procedenteModal.classList.remove('active'));capacidadeBaixaBtn?.addEventListener('click',()=>{if(recommendationInput)recommendationInput.value='PROCEDENTE - CAPACIDADE BAIXA';procedenteModal?.classList.remove('active')});ccaBaixoBtn?.addEventListener('click',()=>{if(recommendationInput)recommendationInput.value='PROCEDENTE - CCA BAIXO';procedenteModal?.classList.remove('active')});descarregadaBtn?.addEventListener('click',()=>{if(recommendationInput)recommendationInput.value='IMPROCEDENTE - BATERIA DESCARREGADA'});addObservationBtn?.addEventListener('click',()=>openObservationModal(tempObservation,obs=>{tempObservation=obs;observationModal?.classList.remove('active');showNotification('Observação salva temporariamente.','info')}));analysisAddObservationBtn?.addEventListener('click',async()=>{const battery=batteryData.find(b=>b.id===analyzingBatteryId);if(battery)openObservationModal(battery.observations,async obs=>{try{const docRef=doc(db,"batteries",analyzingBatteryId);await updateDoc(docRef,{observations:obs});observationModal?.classList.remove('active');showNotification('Observação atualizada.','info')}catch(error){console.error("Erro ao atualizar observação:",error);showNotification("Erro ao salvar observação.","error")}})});toggleDarkModeBtn?.addEventListener('click',toggleDarkMode);cancelConfirmBtn?.addEventListener('click',()=>confirmModal.classList.remove('active'));confirmActionBtn?.addEventListener('click',()=>{confirmCallback?.();confirmModal.classList.remove('active')});changePasswordBtn?.addEventListener('click',()=>passwordModal.classList.add('active'));closePasswordModal?.addEventListener('click',()=>passwordModal.classList.remove('active'));passwordChangeForm?.addEventListener('submit',saveNewPassword);passwordConfirmForm?.addEventListener('submit',handleClearDataConfirmation);cancelPasswordConfirmBtn?.addEventListener('click',()=>passwordConfirmModal.classList.remove('active'));selectAllFinalizadoCheckbox?.addEventListener('change',handleSelectAllFinalizado);batchEditFinalizadoBtn?.addEventListener('click',openBatchEditFinalizadoModal);closeBatchEditFinalizadoModal?.addEventListener('click',()=>batchEditFinalizadoModal.classList.remove('active'));saveBatchEditBtn?.addEventListener('click',saveBatchEditedFinalizado);batchEditApprovedRadioContainer?.addEventListener('click',()=>handleBatchEditDiagnosisChange('approved'));batchEditRejectedRadioContainer?.addEventListener('click',()=>handleBatchEditDiagnosisChange('rejected'));batchEditFinalAction?.addEventListener('change',autoFillBatchEditRecommendation);finalizadoPdfBtn?.addEventListener('click',generateFinalizadasPDF);finalizadoExcelBtn?.addEventListener('click',exportFinalizadasToExcel);finalizadoWhatsappBtn?.addEventListener('click',()=>whatsappOptionsMenuModal.classList.add('active'));closeWhatsappPreviewModal?.addEventListener('click',()=>whatsappPreviewModal.classList.remove('active'));cancelWhatsappBtn?.addEventListener('click',()=>whatsappPreviewModal.classList.remove('active'));sendWhatsappBtn?.addEventListener('click',()=>{window.open(whatsappUrl,'_blank');whatsappPreviewModal.classList.remove('active')});closeWhatsappOptionsMenuModal?.addEventListener('click',()=>whatsappOptionsMenuModal.classList.remove('active'));sendFilteredReportBtn?.addEventListener('click',generateDetailedFilteredReport);sendTodaySummaryBtn?.addEventListener('click',generateTodaySummaryReport);sendPendingAnalysisBtn?.addEventListener('click',generatePendingAnalysisReport);sendGeneralSummaryBtn?.addEventListener('click',generateGeneralSummaryReport);const screensaverOverlay=document.getElementById('screensaverOverlay');screensaverOverlay?.addEventListener('click',()=>hideScreensaver());['click','mousemove','keypress','touchstart'].forEach(evt=>document.addEventListener(evt,resetIdleTimer,false));}async function clearFullForm(){clientNameInput.value='';clientPhoneInput.value='';salesmanNameInput.value='';serialCodeInput.value='';recommendationInput.value='';tempObservation='';clearCode();showNotification('Formulário limpo. A liberar status ativo na nuvem...','info');try{const globalDocRef=doc(db,"batteries",GLOBAL_ACTIVE_ID);await setDoc(globalDocRef,{lastClient:'',lastSalesman:'',timestamp:new Date().toISOString()},{merge:true});addActivity('fas fa-eraser','Formulário limpo e status ativo liberado.');}catch(error){console.error("Erro ao limpar status global:",error);showNotification("Erro ao liberar status ativo na nuvem. Verifique a conexão.","error");}}function handleRegisterScrap(){showNotification('Funcionalidade de "Registrar Sucata" ainda não implementada.','warning');}async function addBattery(){const client=clientNameInput.value.trim().toUpperCase();const salesman=salesmanNameInput.value.trim().toUpperCase();const code=serialCodeInput.value.trim().toUpperCase();const submissionDate=submissionDateInput.value;const clientPhone=clientPhoneInput.value.trim();const warrantyTypeEl=document.querySelector('input[name="warrantyType"]:checked');const recommendation=recommendationInput.value.trim();if(!client||!salesman||!code||!submissionDate||!warrantyTypeEl)return showNotification('Preencha Cliente, Vendedor, Código, Data e Tipo de Garantia.','error');if(warrantyTypeEl.value==='analyzed'&&!recommendation)return showNotification('Para Análise por Vídeo, o Parecer Técnico é obrigatório.','error');if(!validateSerialCode(code))return showNotification('Formato de código inválido.','error');if(batteryData.some(b=>b.code===code))return showNotification('Este código de série já foi registado.','error');const{week,year}=parseCode(code);const warrantyStatus=calculateWarrantyStatus(week,year);const dateParts=submissionDate.split('-');const submissionDateObj=new Date(Date.UTC(dateParts[0],dateParts[1]-1,dateParts[2]));const isAnalyzedByVideo=warrantyTypeEl.value==='analyzed';const newBattery={client,salesman,code,operationCode:isAnalyzedByVideo?'-':'',submissionDate:submissionDateObj.toISOString(),clientPhone:clientPhone,batteryModel:getBatteryModelFromCode(code),manufDate:getManufacturingDate(week,year).toLocaleDateString('pt-BR'),warranty_period_status:warrantyStatus,status:isAnalyzedByVideo?'finalized':'awaiting_receipt',warrantyType:warrantyTypeEl.value,recommendation:recommendation,observations:tempObservation,finalAction:'',timestamp:new Date().toISOString(),technicalOpinionDate:isAnalyzedByVideo?new Date().toISOString():null,receivedBy:isAnalyzedByVideo?'VIDEO_ANALYSIS':null,receiptDate:isAnalyzedByVideo?new Date().toISOString():null,analyzedBy:isAnalyzedByVideo?(sessionStorage.getItem('currentUser')||'unknown'):null,createdBy:sessionStorage.getItem('currentUser')||'unknown'};if(isAnalyzedByVideo&&recommendation){newBattery.finalAction=recommendation.toUpperCase().includes('PROCEDENTE')?'PROCEDENTE (ENVIAR NOVA)':(recommendation.toUpperCase().includes('IMPROCEDENTE')?'IMPROCEDENTE (DEVOLVER)':'');}else if(!isAnalyzedByVideo){newBattery.finalAction='';}try{const newDocRef=await addDoc(batteriesCollection,newBattery);console.log("Bateria adicionada com ID: ",newDocRef.id);const globalDocRef=doc(db,"batteries",GLOBAL_ACTIVE_ID);if(warrantyTypeEl.value!=='factory'){await setDoc(globalDocRef,{lastClient:'',lastSalesman:'',timestamp:new Date().toISOString()},{merge:true});}addActivity('fas fa-cloud-upload-alt',`Bateria ${code} salva na nuvem.`);clearCode();recommendationInput.value='';tempObservation='';}catch(error){console.error("Erro ao adicionar bateria na nuvem:",error);showNotification("Erro ao salvar na nuvem. Verifique a sua conexão.","error")}}function getUserFullName(username){if(!username||username.trim()==='')return'-';const name=userFullNameMap[username.toUpperCase()];if(name&&name!=='Visitante')return name;if(username.toUpperCase()==='VIDEO_ANALYSIS')return'Análise por Vídeo';return username;}function exportFinalizadasToExcel(){const data=getFilteredFinalizadasData();if(data.length===0)return showNotification('Não há dados no filtro para exportar','error');const mappedData=data.map(b=>({'Cód. Operação':b.operationCode||'N/A','Código Bateria':b.code,'Modelo':b.batteryModel,'Cliente':b.client,'Vendedor':b.salesman,'Data Registo':b.timestamp?new Date(b.timestamp).toLocaleDateString('pt-BR'):'N/A','Registado por':getUserFullName(b.createdBy),'Data Recebimento':b.receiptDate?new Date(b.receiptDate).toLocaleDateString('pt-BR'):'N/A','Recebido por':getUserFullName(b.receivedBy),'Data Análise':b.technicalOpinionDate?new Date(b.technicalOpinionDate).toLocaleDateString('pt-BR'):'N/A','Analisado por':getUserFullName(b.analyzedBy),'Ação Final':b.finalAction||'N/A','Parecer':b.recommendation||'N/A','Corrigido por':getUserFullName(b.lastEditedBy),'Data Correção':b.lastEditedDate?new Date(b.lastEditedDate).toLocaleDateString('pt-BR'):'N/A','Data Expedição':b.dispatchDate?new Date(b.dispatchDate).toLocaleDateString('pt-BR'):'N/A','Expedido por':getUserFullName(b.dispatchedBy),'O.S. Expedição':b.dispatchOrderId||'N/A'}));const ws=XLSX.utils.json_to_sheet(mappedData);ws['!autofilter']={ref:ws['!ref']};const colWidths=Object.keys(mappedData[0]).map(key=>({wch:Math.max(key.length,...mappedData.map(row=>(row[key]||'').toString().length))+2}));ws['!cols']=colWidths;const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Garantias Finalizadas");XLSX.writeFile(wb,`relatorio_finalizadas_${new Date().toISOString().slice(0,10)}.xlsx`)}function generateFinalizadasPDF(){const data=getFilteredFinalizadasData();if(data.length===0){showNotification('Não há dados no filtro para gerar o PDF.','info');return}try{const doc=new window.jspdf.jsPDF('l','pt');let startY=drawPdfHeader(doc,'Relatório Analítico de Finalizadas');const procedentes=data.filter(b=>b.finalAction==='PROCEDENTE (ENVIAR NOVA)');const cortesias=data.filter(b=>b.finalAction==='IMPROCEDENTE (CORTESIA)');const devolver=data.filter(b=>b.finalAction==='IMPROCEDENTE (DEVOLVER)');const reprovadasOutras=data.filter(b=>b.finalAction.includes('MAU USO')||b.finalAction.includes('FORA DO PRAZO'));const startDate=finalizadoStartDate.value;const endDate=finalizadoEndDate.value;doc.setFontSize(10).setFont(undefined,'normal');if(startDate&&endDate){doc.text(`Período de Análise: ${new Date(startDate+'T00:00:00').toLocaleDateString('pt-BR')} a ${new Date(endDate+'T00:00:00').toLocaleDateString('pt-BR')}`,40,startY)}else{doc.text(`Período de Análise: Todos os registos`,40,startY)}startY+=20;doc.autoTable({startY:startY,body:[['TOTAL DE ITENS',data.length],['PROCEDENTES (ENVIAR NOVA)',procedentes.length],['IMPROCEDENTES (CORTESIA)',cortesias.length],['IMPROCEDENTES (DEVOLVER)',devolver.length],['REPROVADAS (OUTRAS)',reprovadasOutras.length],],theme:'grid',styles:{font:'helvetica',fontSize:10},headStyles:{fillColor:[0,71,171]},columnStyles:{0:{fontStyle:'bold'}}});const createAnalysisSection=(doc,title,batteries,color)=>{if(batteries.length===0)return doc.lastAutoTable.finalY;let currentY=doc.lastAutoTable.finalY+25;if(currentY>480&&doc.internal.getNumberOfPages()>1){doc.addPage();currentY=80;}else if(currentY>480){doc.addPage();currentY=40;}doc.setFontSize(12).setFont(undefined,'bold');doc.setFillColor(...color);doc.rect(40,currentY-12,doc.internal.pageSize.getWidth()-80,16,'F');doc.setTextColor(255,255,255);doc.text(title.toUpperCase(),45,currentY);doc.setTextColor(0,0,0);currentY+=25;const body=batteries.map(b=>[b.code,b.client,getUserFullName(b.createdBy),b.receiptDate?new Date(b.receiptDate).toLocaleDateString('pt-BR'):'-',getUserFullName(b.receivedBy),b.technicalOpinionDate?new Date(b.technicalOpinionDate).toLocaleDateString('pt-BR'):'-',getUserFullName(b.analyzedBy),getUserFullName(b.lastEditedBy)||'-',b.finalAction||'-',b.recommendation||'-']);doc.autoTable({startY:currentY,head:[['Cód. Bateria','Cliente','Registado por','Data Rec.','Recebido por','Data Análise','Analisado por','Corrigido por','Ação Final','Parecer']],body:body,theme:'grid',headStyles:{fillColor:[44,62,80]},styles:{fontSize:7,cellPadding:2},margin:{left:40,right:40},columnStyles:{0:{cellWidth:45},1:{cellWidth:60},2:{cellWidth:50},3:{cellWidth:45},4:{cellWidth:50},5:{cellWidth:45},6:{cellWidth:50},7:{cellWidth:50},8:{cellWidth:60},9:{cellWidth:'auto'}}});return doc.lastAutoTable.finalY};createAnalysisSection(doc,`PROCEDENTES (${procedentes.length})`,procedentes,[46,204,113]);createAnalysisSection(doc,`IMPROCEDENTES - CORTESIA (${cortesias.length})`,cortesias,[243,156,18]);createAnalysisSection(doc,`IMPROCEDENTES - DEVOLVER (${devolver.length})`,devolver,[52,152,219]);createAnalysisSection(doc,`REPROVADAS - OUTRAS (${reprovadasOutras.length})`,reprovadasOutras,[231,76,60]);drawPdfFooter(doc);doc.output('dataurlnewwindow')}catch(error){showNotification(`Erro ao gerar PDF: ${error.message}`,'error');console.error("Erro PDF:",error)}}function generateReceiptSummaryPDF(){if(!currentReceiptSummaryData){showNotification('Nenhum dado de resumo para gerar PDF.','error');return}const{clientName,clientBatteries}=currentReceiptSummaryData;const doc=new window.jspdf.jsPDF('p','pt');const today=new Date().toLocaleDateString('pt-BR');const salesmanName=clientBatteries[0]?.salesman||'N/A';let startY=drawPdfHeader(doc,'Relatório de Baterias para Recebimento');doc.setFontSize(10).setFont(undefined,'normal');doc.text(`Cliente: ${clientName}`,40,startY);doc.text(`Vendedor: ${salesmanName}`,doc.internal.pageSize.getWidth()-40,startY,{align:'right'});startY+=20;const modelSummary=clientBatteries.reduce((acc,battery)=>{const model=battery.batteryModel||'N/A';acc[model]=(acc[model]||0)+1;return acc},{});doc.setFontSize(12).setFont(undefined,'bold');doc.text('Resumo por Modelo',40,startY);startY+=15;doc.setFontSize(10).setFont(undefined,'normal');for(const[model,count]of Object.entries(modelSummary).sort((a,b)=>a[0].localeCompare(b[0]))){doc.text(`- ${model}: ${count} unidade(s)`,45,startY);startY+=15;}startY+=10;doc.setFontSize(14).setFont(undefined,'bold').text('Lista Detalhada de Baterias',40,startY);const tableBody=clientBatteries.map(b=>[b.code,b.batteryModel,b.salesman,new Date(b.submissionDate).toLocaleDateString('pt-BR'),b.warranty_period_status==='warranty'?'Em Garantia':'Fora do Prazo',b.operationCode||'-',getUserFullName(b.createdBy)]);doc.autoTable({startY:startY+5,head:[['Código Bateria','Modelo','Vendedor','Data Envio','Status Prazo','Cód. Operação','Registado por']],body:tableBody,theme:'grid',headStyles:{fillColor:[0,71,171]},styles:{fontSize:8,cellPadding:2},margin:{left:40,right:40}});let finalY=doc.lastAutoTable.finalY+40;if(finalY>doc.internal.pageSize.getHeight()-60){doc.addPage();finalY=80;}doc.setFontSize(10);doc.text('Conferido por (Jenilton Cruz):_________________________',40,finalY);drawPdfFooter(doc);doc.output('dataurlnewwindow');receiptSummaryModal.classList.remove('active');}
function generateDispatchSummaryPDF(){
    if(!currentDispatchSummaryData){
        showNotification('Nenhum dado de resumo de expedição para gerar PDF.','error');
        return
    }
    const {clientName, batteries} = currentDispatchSummaryData;
    // Chama a função que gera o PDF de expedição, usando um placeholder para a O.S.
    generateDispatchPDF('PREVIEW (Sem O.S. - Resumo)', batteries);
    dispatchSummaryModal.classList.remove('active');
}
function drawPdfHeader(doc,title){const pageWidth=doc.internal.pageSize.getWidth();doc.setFontSize(22).setFont(undefined,'bold').setTextColor(0,71,171).text('FABRECK',40,50);doc.setTextColor(0,0,0);doc.setFontSize(10).setFont(undefined,'normal');doc.text('FABRECK DO BRASIL',pageWidth-40,40,{align:'right'});doc.text(title,pageWidth-40,55,{align:'right'});doc.text(`Data de Emissão: ${new Date().toLocaleDateString('pt-BR')}`,pageWidth-40,70,{align:'right'});doc.setLineWidth(1).line(40,85,pageWidth-40,85);return 105}function drawPdfFooter(doc){const pageCount=doc.internal.getNumberOfPages();const pageWidth=doc.internal.pageSize.getWidth();for(let i=1;i<=pageCount;i++){doc.setPage(i);const pageHeight=doc.internal.pageSize.getHeight();doc.setDrawColor(224,224,224);doc.line(40,pageHeight-40,pageWidth-40,pageHeight-40);doc.setFontSize(8).setTextColor(128,128,128);doc.text(`Relatório gerado pelo Sistema de Garantia Fabreck © ${new Date().getFullYear()}`,pageWidth/2,pageHeight-30,{align:'center'});doc.text(`Página ${i} de ${pageCount}`,pageWidth-40,pageHeight-30,{align:'right'})}}function getFilteredFinalizadasData(){const searchTerm=finalizadoSearchInput.value.trim().toLowerCase();const startDate=finalizadoStartDate.value;const endDate=finalizadoEndDate.value;const selectedClient=finalizadoClientFilter.value;const selectedSalesman=finalizadoSalesmanFilter.value;const selectedAction=finalizadoActionFilter.value;let dataFinalizada=batteryData.filter(b=>b.status==='finalized');if(searchTerm){dataFinalizada=dataFinalizada.filter(b=>(b.operationCode&&b.operationCode.toLowerCase().includes(searchTerm))||b.code.toLowerCase().includes(searchTerm)||b.client.toLowerCase().includes(searchTerm)||(b.recommendation&&b.recommendation.toLowerCase().includes(searchTerm)))}if(startDate||endDate){const start=startDate?new Date(startDate+'T00:00:00'):new Date('1970-01-01');const end=endDate?new Date(endDate+'T23:59:59'):new Date();dataFinalizada=dataFinalizada.filter(b=>{const analysisDate=b.technicalOpinionDate?new Date(b.technicalOpinionDate):null;return analysisDate&&analysisDate>=start&&analysisDate<=end})}if(selectedClient){dataFinalizada=dataFinalizada.filter(b=>b.client===selectedClient)}if(selectedSalesman){dataFinalizada=dataFinalizada.filter(b=>b.salesman===selectedSalesman)}if(selectedAction){dataFinalizada=dataFinalizada.filter(b=>b.finalAction===selectedAction)}return dataFinalizada;}function toggleDarkMode(){isDarkMode=!isDarkMode;localStorage.setItem(DARK_MODE_KEY,isDarkMode);applyDarkMode()}function applyDarkMode(){document.body.classList.toggle('dark-mode',isDarkMode);darkModeText.textContent=isDarkMode?'Modo Claro':'Modo Escuro';toggleDarkModeBtn.querySelector('i').className=isDarkMode?'fas fa-sun':'fas fa-moon'}function selectWarrantyType(type){factoryRadio.checked=type==='factory';analyzedRadio.checked=type==='analyzed';factoryOption.classList.toggle('selected',type==='factory');analyzedOption.classList.toggle('selected',type==='analyzed');videoAnalysisOptions.classList.toggle('hidden',type!=='analyzed');localStorage.setItem(LAST_WARRANTY_TYPE_KEY,type)}function showNotification(message,type){const notification=document.getElementById('notification');notification.textContent=message;notification.className=`notification ${type} show`;setTimeout(()=>notification.classList.remove('show'),3000)}function showRulesModal(){rulesModal.classList.add('active')}function showConfirmModal(title,message,onConfirm,onCancel){confirmTitle.textContent=title;confirmMessage.innerHTML=message;confirmCallback=onConfirm;confirmModal.classList.add('active');const cancelHandler=()=>{onCancel?.();confirmModal.classList.remove('active');cancelConfirmBtn.removeEventListener('click',cancelHandler)};cancelConfirmBtn.addEventListener('click',cancelHandler,{once:true})}function showFinalizedNotification(batteries){const listElement=document.getElementById('finalizedNotificationList');listElement.innerHTML='<p>As seguintes baterias tiveram seu status alterado para "Finalizado":</p><ul>'+batteries.map(b=>`<li><strong>${b.code}</strong> (${b.batteryModel}) - Cliente: ${b.client}</li>`).join('')+'</ul>';finalizedNotificationModal.classList.add('active');playBeep()}function playBeep(){try{const audioContext=new(window.AudioContext||window.webkitAudioContext)();const oscillator=audioContext.createOscillator();const gainNode=audioContext.createGain();oscillator.connect(gainNode);gainNode.connect(audioContext.destination);oscillator.type='sine';oscillator.frequency.setValueAtTime(800,audioContext.currentTime);gainNode.gain.setValueAtTime(.3,audioContext.currentTime);oscillator.start(audioContext.currentTime);oscillator.stop(audioContext.currentTime+.2)}catch(e){console.error("Não foi possível reproduzir o som de notificação.",e)}}function addActivity(icon,message){const newActivity={icon,message,time:new Date().toLocaleTimeString('pt-BR')};activityData.push(newActivity);if(activityData.length>50)activityData.shift();localStorage.setItem(ACTIVITY_DATA_KEY,JSON.stringify(activityData));updateActivityLog()}function updateLastUpdate(){lastUpdate.textContent=new Date().toLocaleString('pt-BR')}async function showPage(pageId){window.scrollTo({top:0,behavior:'smooth'});if(pageId==='scanPage'){const today=new Date();const year=today.getFullYear();const month=String(today.getMonth()+1).padStart(2,'0');const day=String(today.getDate()).padStart(2,'0');submissionDateInput.value=`${year}-${month}-${day}`;if((clientNameInput.value.trim()===''&&clientNameInput.value.trim()!=='N/A')||(salesmanNameInput.value.trim()===''&&salesmanNameInput.value.trim()!=='N/A')){try{const globalDocRef=doc(db,"batteries",GLOBAL_ACTIVE_ID);const docSnap=await getDoc(globalDocRef);if(docSnap.exists()){const data=docSnap.data();const client=data.lastClient&&data.lastClient.trim()!==' '?data.lastClient:'';const salesman=data.lastSalesman&&data.lastSalesman.trim()!==' '?data.lastSalesman:'';if(clientNameInput.value.trim()===''){clientNameInput.value=client;}if(salesmanNameInput.value.trim()===''){salesmanNameInput.value=salesman;}}}catch(error){console.error("Erro ao carregar status global inicial:",error);}}}pages.forEach(page=>page.classList.remove('active'));document.getElementById(pageId)?.classList.add('active');navBtns.forEach(btn=>btn.classList.toggle('active',btn.getAttribute('data-page')===pageId));sidebarBtns.forEach(btn=>btn.classList.toggle('active',btn.getAttribute('data-page')===pageId));if(['receiptPage','analysisPage','finalizadoPage','settingsPage'].includes(pageId)){updateUI()}}function updateReceiptTable(){const searchTerm=receiptSearchInput.value.trim().toLowerCase();const selectedClient=receiptClientFilter.value;const activeClient=currentClientDisplay.textContent;let dataToReceive=batteryData.filter(b=>b.status==='awaiting_receipt');if(selectedClient){dataToReceive=dataToReceive.filter(b=>b.client===selectedClient)}if(searchTerm){dataToReceive=dataToReceive.filter(b=>(b.code.toLowerCase().includes(searchTerm))||b.client.toLowerCase().includes(searchTerm)||b.salesman.toLowerCase().includes(searchTerm))}dataToReceive.sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp));const isAnyClientActive=activeClient!=='N/A';receiptLockMessage.style.display=isAnyClientActive?'block':'none';let shouldDisableSelectAll=false;if(dataToReceive.length===0){receiptBody.innerHTML=`<tr><td colspan="7" style="text-align: center;">Nenhuma bateria aguardando recebimento.</td></tr>`;}else{receiptBody.innerHTML=dataToReceive.map(b=>{const warrantyStatus=b.warranty_period_status==='warranty'?'<span class="status-badge status-warranty">Em Garantia</span>':'<span class="status-badge status-expired">Fora do Prazo</span>';const isClientLocked=(isAnyClientActive&&b.client===activeClient);const disabledAttribute=isClientLocked?'disabled':'';const lockIcon=isClientLocked?'<i class="fas fa-lock"></i>':'';if(isClientLocked){shouldDisableSelectAll=true;}return`<tr><td><input type="checkbox" class="receipt-checkbox" data-id="${b.id}" ${disabledAttribute}></td><td>${b.code}</td><td>${b.batteryModel}</td><td>${b.client}</td><td>${b.salesman}</td><td>${new Date(b.submissionDate).toLocaleDateString('pt-BR')}</td><td>${warrantyStatus}</td><td class="actions-cell">${lockIcon}<button class="confirm-receipt-btn btn btn-success" data-id="${b.id}" style="padding: 8px 12px; width: auto; margin: 0;" ${disabledAttribute}><i class="fas fa-check"></i> Receber</button></td></tr>`}).join('')}if(selectedClient&&dataToReceive.length>0&&!activeClient.includes(selectedClient)){showReceiptSummary(selectedClient,dataToReceive)}selectAllReceiptCheckbox.disabled=shouldDisableSelectAll;receiptBody.querySelectorAll('.confirm-receipt-btn').forEach(btn=>{if(!btn.disabled){btn.addEventListener('click',function(){openReceiptConfirmModal([this.dataset.id])});}});receiptBody.querySelectorAll('.receipt-checkbox').forEach(cb=>cb.addEventListener('change',updateBatchReceiptButtonState));selectAllReceiptCheckbox.checked=false;updateBatchReceiptButtonState();applyUIRestrictions();}function updateAnalysisTable(){const selectedClient=analysisClientFilter.value;const selectedSalesman=analysisSalesmanFilter.value;const searchTerm=analysisSearchInput.value.trim().toLowerCase();let dataToAnalyze=batteryData.filter(b=>b.status==='in_analysis');if(selectedClient){dataToAnalyze=dataToAnalyze.filter(b=>b.client===selectedClient)}if(selectedSalesman){dataToAnalyze=dataToAnalyze.filter(b=>b.salesman===selectedSalesman)}if(searchTerm){dataToAnalyze=dataToAnalyze.filter(b=>(b.operationCode&&b.operationCode.toLowerCase().includes(searchTerm))||b.code.toLowerCase().includes(searchTerm)||b.batteryModel.toLowerCase().includes(searchTerm))}dataToAnalyze.sort((a,b)=>new Date(a.receiptDate)-new Date(b.receiptDate));selectAllAnalysisCheckbox.checked=false;if(dataToAnalyze.length===0){analysisBody.innerHTML=`<tr><td colspan="8" style="text-align: center;">Nenhuma bateria na fila para análise técnica.</td></tr>`;}else{analysisBody.innerHTML=dataToAnalyze.map(renderAnalysisTableRow).join('')}analysisBody.querySelectorAll('.analyze-btn').forEach(btn=>btn.addEventListener('click',function(){openSingleAnalysisModal(this.dataset.id)}));analysisBody.querySelectorAll('.revert-to-receipt-btn').forEach(btn=>btn.addEventListener('click',function(){showConfirmModal('Retroceder para Recebimento?','Esta bateria voltará para a fila da Aline. Os dados de recebimento serão apagados.',()=>revertToReceipt(this.dataset.id))}));analysisBody.querySelectorAll('.analysis-checkbox').forEach(box=>box.addEventListener('change',updateBatchAnalyzeButtonState));updateBatchAnalyzeButtonState();applyUIRestrictions();}function updateFinalizadoTable(){const searchTerm=finalizadoSearchInput.value.trim().toLowerCase();const startDate=finalizadoStartDate.value;const endDate=finalizadoEndDate.value;const selectedClient=finalizadoClientFilter.value;const selectedSalesman=finalizadoSalesmanFilter.value;const selectedAction=finalizadoActionFilter.value;let dataFinalizada=batteryData.filter(b=>b.status==='finalized');if(searchTerm){dataFinalizada=dataFinalizada.filter(b=>(b.operationCode&&b.operationCode.toLowerCase().includes(searchTerm))||b.code.toLowerCase().includes(searchTerm)||b.client.toLowerCase().includes(searchTerm)||(b.recommendation&&b.recommendation.toLowerCase().includes(searchTerm)))}if(startDate||endDate){const start=startDate?new Date(startDate+'T00:00:00'):new Date('1970-01-01');const end=endDate?new Date(endDate+'T23:59:59'):new Date();dataFinalizada=dataFinalizada.filter(b=>{const analysisDate=b.technicalOpinionDate?new Date(b.technicalOpinionDate):null;return analysisDate&&analysisDate>=start&&analysisDate<=end})}if(selectedClient){dataFinalizada=dataFinalizada.filter(b=>b.client===selectedClient)}if(selectedSalesman){dataFinalizada=dataFinalizada.filter(b=>b.salesman===selectedSalesman)}if(selectedAction){dataFinalizada=dataFinalizada.filter(b=>b.finalAction===selectedAction)}dataFinalizada.sort((a,b)=>new Date(b.technicalOpinionDate)-new Date(b.technicalOpinionDate));if(dataFinalizada.length===0){finalizadoBody.innerHTML=`<tr><td colspan="8" style="text-align: center;">Nenhuma garantia finalizada encontrada com estes filtros.</td></tr>`;}else{finalizadoBody.innerHTML=dataFinalizada.map(renderFinalizadoTableRow).join('')}finalizadoBody.querySelectorAll('.finalizado-checkbox').forEach(box=>box.addEventListener('change',updateBatchEditFinalizadoButtonState));finalizadoBody.querySelectorAll('.return-to-analysis-btn').forEach(btn=>btn.addEventListener('click',function(){showConfirmModal('Retornar para Análise?','Esta bateria voltará para a fila de análise do Reginaldo. O parecer anterior será apagado.',()=>returnToAnalysis(this.dataset.id))}));finalizadoBody.querySelectorAll('.name-edit-btn').forEach(btn=>btn.addEventListener('click',function(){openClientEditModal(this.dataset.id)}));finalizadoBody.querySelectorAll('.remove-btn').forEach(btn=>btn.addEventListener('click',function(){showConfirmModal('Remover Bateria da Nuvem','Tem a certeza que deseja remover esta bateria? A ação é irreversível.',()=>removeBattery(this.dataset.id))}));updateBatchEditFinalizadoButtonState();applyUIRestrictions();}function updateDispatchPage(){const searchTerm=dispatchSearchInput.value.trim().toLowerCase();const pendingDispatch=batteryData.filter(b=>b.status==='finalized'&&(b.finalAction.includes('PROCEDENTE')||b.finalAction.includes('CORTESIA'))&&!b.dispatchOrderId);let groupedByClient=pendingDispatch.reduce((acc,battery)=>{const key=`${battery.client}|${battery.salesman}`;if(!acc[key]){acc[key]=[]}acc[key].push(battery);return acc},{});if(searchTerm){groupedByClient=Object.fromEntries(Object.entries(groupedByClient).filter(([key])=>key.toLowerCase().includes(searchTerm)))}dispatchClientList.innerHTML='';if(Object.keys(groupedByClient).length===0){dispatchClientList.innerHTML='<div class="info-section"><p>Nenhuma expedição pendente encontrada.</p></div>';return}for(const key in groupedByClient){const[client,salesman]=key.split('|');const batteries=groupedByClient[key];const clientCard=document.createElement('div');clientCard.className='card';const tableRows=batteries.map(b=>`<tr><td>${b.code}</td><td>${b.batteryModel}</td><td><span class="status-badge ${b.finalAction.includes('PROCEDENTE')?'action-approved':'action-courtesy'}">${b.finalAction}</span></td><td>${b.operationCode||'-'}</td></tr>`).join('');clientCard.innerHTML=`<div class="card-header" style="align-items: flex-start;"><div><h3 class="card-title" style="margin-bottom: 5px;">Cliente: ${client}</h3><p style="font-size: 14px; color: var(--fabreck-gray);">Vendedor: ${salesman}</p></div><div style="display:flex; gap:10px;"><button class="btn btn-info summary-dispatch-btn" data-key="${key}" style="margin-top:0; white-space: nowrap; width: auto;"><i class="fas fa-file-alt"></i> Resumo</button><button class="btn btn-primary generate-dispatch-order-btn" data-key="${key}" style="margin-top: 0; white-space: nowrap; width: auto;"><i class="fas fa-print"></i> Gerar Pedido (${batteries.length})</button></div></div><div class="table-container" style="margin-top: 10px;"><table style="font-size: 12px;"><thead><tr><th>Código Bateria</th><th>Modelo</th><th>Ação</th><th>Cód. Operação</th></tr></thead><tbody>${tableRows}</tbody></table></div>`;dispatchClientList.appendChild(clientCard)}document.querySelectorAll('.summary-dispatch-btn').forEach(btn=>{btn.addEventListener('click',function(){const key=this.dataset.key;const batteries=groupedByClient[key];showDispatchSummary(key.split('|')[0],batteries)})});document.querySelectorAll('.generate-dispatch-order-btn').forEach(btn=>{btn.addEventListener('click',function(){const key=this.dataset.key;const batteries=groupedByClient[key];openDispatchConfirmModal(batteries)})})}function generateDispatchPDF(orderId,batteries){const doc=new window.jspdf.jsPDF('l','pt');const today=new Date().toLocaleDateString('pt-BR');const clientName=batteries[0].client;const salesmanName=batteries[0].salesman;doc.setFontSize(20).setFont(undefined,'bold').text('PEDIDO DE EXPEDIÇÃO - GARANTIA',doc.internal.pageSize.getWidth()/2,40,{align:'center'});doc.setFontSize(14).setFont(undefined,'normal').text(`Pedido Nº: ${orderId}`,doc.internal.pageSize.getWidth()/2,58,{align:'center'});let startY=85;doc.setFontSize(12);doc.text(`Cliente:`,40,startY);doc.setFont(undefined,'bold').text(clientName,90,startY);doc.setFont(undefined,'normal').text(`Vendedor:`,40,startY+20);doc.setFont(undefined,'bold').text(salesmanName,100,startY+20);doc.text(`Data de Emissão:`,doc.internal.pageSize.getWidth()-40,startY,{align:'right',baseline:'middle',x:doc.internal.pageSize.getWidth()-120,y:startY});doc.setFont(undefined,'bold').text(today,doc.internal.pageSize.getWidth()-40,startY,{align:'right'});startY+=45;const modelSummary=batteries.reduce((acc,battery)=>{const model=battery.batteryModel||'N/A';acc[model]=(acc[model]||0)+1;return acc},{});startY+=10;doc.setFontSize(14).setFont(undefined,'bold').text('Resumo por Modelo',40,startY);startY+=8;const summaryBody=Object.entries(modelSummary).map(([model,count])=>[model,count]);doc.autoTable({startY:startY,head:[['Modelo','Quantidade']],body:summaryBody,theme:'grid',headStyles:{fillColor:[0,71,171]},columnStyles:{1:{halign:'center'}},tableWidth:300});startY=doc.lastAutoTable.finalY+20;const tableBody=batteries.map(b=>[b.code,b.batteryModel,b.timestamp?new Date(b.timestamp).toLocaleDateString('pt-BR'):'-',getUserFullName(b.createdBy),b.receiptDate?new Date(b.receiptDate).toLocaleDateString('pt-BR'):'-',getUserFullName(b.receivedBy),b.technicalOpinionDate?new Date(b.technicalOpinionDate).toLocaleDateString('pt-BR'):'-',getUserFullName(b.analyzedBy),b.finalAction,b.recommendation||'-']);doc.autoTable({startY:startY,head:[['Cód. Bateria','Modelo','Data Reg.','Registado por','Data Rec.','Recebido por','Data Análise','Analisado por','Ação Final','Parecer Técnico']],body:tableBody,theme:'grid',styles:{fontSize:8},headStyles:{fillColor:[30,30,30]},columnStyles:{9:{cellWidth:'auto'}}});let finalY=doc.lastAutoTable.finalY+40;if(finalY>doc.internal.pageSize.getHeight()-100){doc.addPage();finalY=80}doc.line(40,finalY,240,finalY);doc.text('Separado por',140,finalY+15,{align:'center'});doc.line(doc.internal.pageSize.getWidth()-240,finalY,doc.internal.pageSize.getWidth()-40,finalY);doc.text('Conferido por',doc.internal.pageSize.getWidth()-140,finalY+15,{align:'center'});drawPdfFooter(doc);doc.output('dataurlnewwindow');}function saveNewPassword(e){e.preventDefault();const currentPassword=document.getElementById('currentPassword').value;const newPassword=document.getElementById('newPassword').value;const confirmNewPassword=document.getElementById('confirmNewPassword').value;const loggedInUser=sessionStorage.getItem('currentUser');if(!loggedInUser)return showNotification('Erro: Utilizador não identificado.','error');let adminUsers=JSON.parse(localStorage.getItem(ADMIN_USERS_KEY));const userToUpdate=adminUsers.find(admin=>admin.user===loggedInUser);if(!userToUpdate||currentPassword!==userToUpdate.pass)return showNotification('A palavra-passe atual está incorreta.','error');if(newPassword.length<3)return showNotification('A nova palavra-passe deve ter pelo menos 3 caracteres.','error');if(newPassword!==confirmNewPassword)return showNotification('As novas palavras-passe não coincidem.','error');userToUpdate.pass=newPassword;localStorage.setItem(ADMIN_USERS_KEY,JSON.stringify(adminUsers));showNotification('Palavra-passe alterada com sucesso!','success');passwordModal.classList.remove('active');passwordChangeForm.reset()}function handleClearDataConfirmation(e){e.preventDefault();const enteredPassword=adminPasswordConfirmInput.value;const loggedInUser=sessionStorage.getItem('currentUser');if(loggedInUser!=='JENILTON')return;const adminUsers=JSON.parse(localStorage.getItem(ADMIN_USERS_KEY));const userToUpdate=adminUsers.find(admin=>admin.user===loggedInUser);if(userToUpdate&&enteredPassword===userToUpdate.pass){showNotification('Senha correta. A limpar os dados...','warning');passwordConfirmModal.classList.remove('active');clearData()}else{showNotification('Palavra-passe incorreta. A limpeza foi cancelada.','error');adminPasswordConfirmInput.value=''}}function generateDetailedFilteredReport(){const data=getFilteredFinalizadasData();if(data.length===0)return showNotification('Nenhum dado no filtro para gerar o relatório.','error');let message=`*Relatório Detalhado de Garantias Finalizadas*\n`;message+=`*Data:* ${new Date().toLocaleDateString('pt-BR')}\n`;message+=`====================================\n\n`;const groupedBySalesman=data.reduce((acc,battery)=>{(acc[battery.salesman]=acc[battery.salesman]||[]).push(battery);return acc},{});for(const salesman in groupedBySalesman){message+=`*VENDEDOR:* ${salesman}\n`;message+=`------------------------------------\n`;const clientData=groupedBySalesman[salesman];const groupedByClient=clientData.reduce((acc,battery)=>{(acc[battery.client]=acc[battery.client]||[]).push(battery);return acc},{});for(const client in groupedByClient){message+=`  *CLIENTE:* ${client}\n`;const batteryData=groupedByClient[client];batteryData.forEach(b=>{message+=`    - ${b.batteryModel} (${b.code}): *${b.finalAction}*\n`});message+=`\n`}}openWhatsAppModal('custom',{message})}function generateTodaySummaryReport(){const today=new Date();today.setHours(0,0,0,0);const todaysEntries=batteryData.filter(b=>{const entryDate=new Date(b.timestamp);return entryDate>=today});if(todaysEntries.length===0){return showNotification('Nenhum registo de garantia feito hoje.','info')}let message=`*RESUMO DE REGISTOS DE GARANTIA - ${new Date().toLocaleDateString('pt-BR')}*\n\n`;const groupedBySalesman=todaysEntries.reduce((acc,battery)=>{(acc[battery.salesman]=acc[battery.salesman]||[]).push(battery);return acc},{});let totalToday=0;Object.keys(groupedBySalesman).sort().forEach(salesman=>{const entries=groupedBySalesman[salesman];const count=entries.length;totalToday+=count;message+=`*VENDEDOR: ${salesman}*\n`;message+=`Total de Baterias Registadas: ${count}\n\n`});message+=`*TOTAL GERAL DO DIA: ${totalToday} BATERIAS*\n\n`;message+=`_Relatório gerado pelo Sistema de Garantia Fabreck._`;openWhatsAppModal('custom',{message:message})}function generatePendingAnalysisReport(){const pendingData=batteryData.filter(b=>b.status==='awaiting_receipt'||b.status==='in_analysis');if(pendingData.length===0){return showNotification('Nenhuma bateria pendente.','info')}let message=`*RESUMO DE BATERIAS PENDENTES*\n`;message+=`*Data:* ${new Date().toLocaleDateString('pt-BR')}\n\n`;const groupedByClient=pendingData.reduce((acc,battery)=>{(acc[battery.client]=acc[battery.client]||[]).push(battery);return acc},{});for(const client in groupedByClient){const batteries=groupedByClient[client];message+=`*CLIENTE: ${client}* (${batteries.length} UNID.)\n`;batteries.forEach(b=>{const statusText=b.status==='awaiting_receipt'?'Aguardando Recebimento':'Em Análise';message+=` • ${b.batteryModel} (${b.code}) - ${statusText}\n`});message+='\n'}openWhatsAppModal('custom',{message})}function generateGeneralSummaryReport(){const finalizedData=batteryData.filter(b=>b.status==='finalized');if(finalizedData.length===0)return showNotification('Nenhuma garantia finalizada para gerar resumo.','info');let message=`*RESUMO GERAL DE GARANTIAS FINALIZADAS*\n`;message+=`*Data:* ${new Date().toLocaleDateString('pt-BR')}\n\n`;const groupedBySalesman=finalizedData.reduce((acc,battery)=>{(acc[battery.salesman]=acc[battery.salesman]||[]).push(battery);return acc},{});for(const salesman in groupedBySalesman){message+=`*VENDEDOR:* ${salesman}\n`;const clientData=groupedBySalesman[salesman];const summary=clientData.reduce((acc,b)=>{let category='Reprovadas';if(b.finalAction.includes('PROCEDENTE'))category='Aprovadas';else if(b.finalAction.includes('CORTESIA'))category='Cortesias';acc[category]=(acc[category]||0)+1;return acc},{Aprovadas:0,Cortesias:0,Reprovadas:0});message+=`  - Aprovadas: ${summary.Aprovadas}\n`;message+=`  - Cortesias: ${summary.Cortesias}\n`;message+=`  - Reprovadas: ${summary.Reprovadas}\n\n`}openWhatsAppModal('custom',{message})}function openWhatsAppModal(type,data=null){let message='';let targetPhone='';whatsappOptionsMenuModal.classList.remove('active');if(type==='custom'){message=data.message;if(data.phone)targetPhone=data.phone}if(!message){showNotification('Não foi possível gerar a mensagem.','error');return}whatsappMessagePreview.textContent=message;const encodedMessage=encodeURIComponent(message);whatsappUrl=targetPhone?`https://wa.me/${targetPhone.replace(/\D/g,'')}?text=${encodedMessage}`:`https://web.whatsapp.com/send?text=${encodedMessage}`;whatsappPreviewModal.classList.add('active');}init();});
</script>
</body></html>
